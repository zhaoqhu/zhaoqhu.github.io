<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.7.4">Jekyll</generator><link href="http://localhost:4000/atom.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" /><updated>2026-01-15T14:17:09+08:00</updated><id>http://localhost:4000/atom.xml</id><title type="html">Zhao Q.H.’s Notes</title><subtitle>Keep It Simple, Stupid</subtitle><author><name>Zhao Q.H.</name></author><entry><title type="html">FastAPI-ORM</title><link href="http://localhost:4000/fastapi/2026/01/15/fastapi-orm/" rel="alternate" type="text/html" title="FastAPI-ORM" /><published>2026-01-15T00:00:00+08:00</published><updated>2026-01-15T00:00:00+08:00</updated><id>http://localhost:4000/fastapi/2026/01/15/fastapi-orm</id><content type="html" xml:base="http://localhost:4000/fastapi/2026/01/15/fastapi-orm/">&lt;p&gt;sqlalchemy[asyncio]异步的SQLAlchemy是Python的一个开源SQL工具包和对象关系映射（ORM）框架，用于简化数据库操作。
aiomysql是一个基于Python asyncio的异步MySQL客户端库，用于在高并发场景下提升数据库访问性能.&lt;/p&gt;

&lt;h1 id=&quot;python环境&quot;&gt;python环境&lt;/h1&gt;
&lt;h2 id=&quot;python-版本&quot;&gt;python 版本&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;% python3 --version
Python 3.13.10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;pip版本&quot;&gt;pip版本&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; pip3 --version
pip 25.3 from /Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pip (python 3.13)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;python3虚拟环境&quot;&gt;python3虚拟环境&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;创建虚拟环境
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 -m venv venv 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;激活虚拟环境
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;source venv/bin/activate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;在虚拟环境工作&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# source ./venv/bin/activate
# deactivate
(venv) # pip --version
pip 25.3 /fastapi/venv/lib/python3.13/site-packages/pip (python 3.13)
(venv) # python --version
Python 3.13.10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;退出虚拟环境
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;deactivate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;在虚拟环境安装运行fastapi服务工具&quot;&gt;在虚拟环境安装运行fastapi服务工具。&lt;/h2&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip install &quot;fastapi[standard]&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;fastapi-命令行工具&quot;&gt;fastapi 命令行工具&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;使用 fastapi工具运行fastapi服务
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# fastapi dev main.py 
# 命令
dev      Run a FastAPI app in development mode.
│ run      Run a FastAPI app in production mode.
│ deploy   Deploy a FastAPI app to FastAPI Cloud.
│ login    Login to FastAPI Cloud.
│ cloud    Manage FastAPI Cloud deployments.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;uvicorn-命令行工具&quot;&gt;uvicorn 命令行工具&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;使用 uvicorn高兴能服务器工具运行fastapi
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;uvicorn main:app --reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;vscode运行和调试&quot;&gt;VSCode运行和调试&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;vscode/launch.json
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
  // 使用 IntelliSense 了解相关属性。 
  // 悬停以查看现有属性的描述。
  // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
  &quot;version&quot;: &quot;0.2.0&quot;,
  &quot;configurations&quot;: [
      {
          &quot;name&quot;: &quot;Python Debugger: FastAPI&quot;,
          &quot;type&quot;: &quot;debugpy&quot;,
          &quot;request&quot;: &quot;launch&quot;,
          &quot;module&quot;: &quot;uvicorn&quot;,
          &quot;python&quot;:&quot;/Users/zhaoqinghu/dev_docker/fastapi-1/venv/bin/python3&quot;, // 请根据你的虚拟环境路径进行修改
          &quot;args&quot;: [
              &quot;main:app&quot;,
              &quot;--reload&quot;
          ],
          &quot;jinja&quot;: true
      }
  ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;h1 id=&quot;fastpai-orm&quot;&gt;FASTPAI-ORM&lt;/h1&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;orm简介&quot;&gt;ORM简介&lt;/h2&gt;
&lt;p&gt;ORM(OBJECT-RelationMapping，对象关系映射)是一种编程技术，用于面向对象编程语言和
关系型数据库之间建立映射。允许开发者通过操作对象的方式和数据交互，而无需直接编写复杂的SQL语句。
ORM分类&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;排名     ORM工具             特点                         适应场景
1       SQLAlchemy ORM      功能最强，最灵活，企业级        各类API、微服务、数据应用
2       Django ORM          封装好、上手快                 Django项目、管理后台
3       Tortose ORM         全异步                       异步Web服务、高并发API
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;安装sqlalchemy和aiomysql异步数据库驱动&quot;&gt;安装sqlalchemy和aiomysql（异步数据库驱动）&lt;/h2&gt;

&lt;p&gt;FastAPI异步框架必须安装”sqlalchemy[asyncio]”来支持异步。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://pypi.org/project/SQLAlchemy/&quot;&gt;sqlalchemy&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://pypi.org/project/aiomysql/&quot;&gt;aiomysql&lt;/a&gt;
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# pip install &quot;sqlalchemy[asyncio]&quot;
//不支持异步
# pip install &quot;sqlalchemy&quot;
# pip install aiomysql             
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;orm-建表&quot;&gt;ORM-建表&lt;/h2&gt;
&lt;ul&gt;
  &lt;li&gt;创建数据库引擎&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker

ASYNC_DATABASE_URL = &quot;mysql+aiomysql://root:CXqwr12_@localhost:13306/fastapi_first?charset=utf8mb4&quot;
async_engine = create_async_engine(
    ASYNC_DATABASE_URL,
    echo=True,  #可选，输出SQL日志
    pool_size=10, #连接池大小
    max_overflow=20, #超出连接池大小外最多创建的连接数
    pool_timeout=30, #连接池中没有可用连接时，等待获取连接的最长时间
)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;定义模型类&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column

# 2.定义模型类：基类+表对应的模型类
# 基类：创建时间、更新时间；书籍表：id、书名、作者、价格、出版社

class Base(DeclarativeBase):
    create_time: Mapped[datetime] = mapped_column(DateTime, insert_default=func.now(),default=func.now(),comment=&quot;创建时间&quot;)
    update_time: Mapped[datetime] = mapped_column(DateTime, insert_default=func.now(), default=func.now(), onupdate=func.now(),comment=&quot;更新时间&quot;)
class Book(Base):
    __tablename__ = &quot;books&quot;
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True,comment=&quot;书籍id&quot;)
    bookname: Mapped[str] = mapped_column(String(255),comment=&quot;书名&quot;)
    author: Mapped[str] = mapped_column(String(255),comment=&quot;作者&quot;)
    price: Mapped[float] = mapped_column(Float,comment=&quot;价格&quot;)
    publisher: Mapped[str] = mapped_column(String(255),comment=&quot;出版社&quot;)

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;启动应用时建表&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
# 3.定义函数建表 -&amp;gt;FastAPI启动时调用
async def create_tables():
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


@app.on_event(&quot;startup&quot;)
async def startup_event():
    await create_tables()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;orm-在路由中使用&quot;&gt;ORM-在路由中使用&lt;/h2&gt;
&lt;p&gt;核心：创建依赖项，使用Depends注入到处理函数&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 需求：查询功能的接口，查询图书-&amp;gt;依赖注入：创建依赖获取数据库会话+Depends注入路由处理函数
AsyncSessionLocal = async_sessionmaker(
    bind=async_engine, #绑定数据库引擎
    class_=AsyncSession, #指定会话类
    expire_on_commit=False #提交后不失效
)
# 创建依赖获取数据库会话
async def get_database():
    async with AsyncSessionLocal() as session:
        try:
            yield session #返回数据库会话路由处理函数
            await session.commit() #提交事务
        except Exception as e: 
            await session.rollback() # 有异常回滚
            raise e
        finally:
            await session.close()   #关闭会话

# 路由中使用依赖注入
@app.get(&quot;/book/books&quot;)
async def get_book_list(db: AsyncSession = Depends(get_database)):
    result = await db.execute(
       select(Book) 
    )
    books = result.scalars().all()
    return books

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;数据库操作---查询&quot;&gt;数据库操作 - 查询&lt;/h2&gt;

&lt;p&gt;核心语句：await db.execute( select(模型类))，返回一个ORM&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;获取所有数据&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;scalars().all()
*获取单条数据
scalars().first()
get(模型类,主键值)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;数据库操作---查询条件&quot;&gt;数据库操作 - 查询条件&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;比较判断：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;==|&amp;gt;|&amp;lt;|&amp;gt;=|&amp;lt;=
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;orm查询总结&quot;&gt;ORM查询总结&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;select()-&amp;gt;db.execute()-&amp;gt;从对象获取数据-&amp;gt;响应结果
db.get(模型类，主键值)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;条件查询&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;比较判断、模糊查询like()、与非查询：&amp;amp; | ~、包含查询：in_()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;聚合查询func&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;count()
max()
avg()
sum()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;分页查询&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;select().offset().limit()
offset值 = (当前页面-1)*每页数量

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;从ORM对象获取数据的方式&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;获取所有数据&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;scalars().all()
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;p&gt;获取单条数据&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;//提取第一个数据
scalars.first() 
//提取一个或null
scalar_one_or_none()
//提取标量值(配合聚合查询使用)
scalar()

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;数据库操作-新增&quot;&gt;数据库操作-新增&lt;/h2&gt;

&lt;p&gt;核心步骤：定义ORM对象-&amp;gt;添加对象到事务: add(对象)-&amp;gt;commit 提交到数据库&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;
    &lt;p&gt;数据库操作-修改&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;数据库操作-删除&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;总结&quot;&gt;总结&lt;/h2&gt;
&lt;p&gt;面向对象的方式操作数据库不写SQL啦
企业应用最多、社区最活跃的SQLAlchemy ORM。&lt;/p&gt;

&lt;h2 id=&quot;mainpy&quot;&gt;main.py&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;import datetime
from fastapi import FastAPI , Path, Query, HTTPException, Depends
from pydantic import BaseModel,Field
from fastapi.responses import HTMLResponse, FileResponse
from sqlalchemy import DateTime, Float, String, func, select
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession, async_sessionmaker
from sqlalchemy.orm import DeclarativeBase, Mapped, mapped_column
from typing import List
app = FastAPI()

# 1.创建异步数据库引擎
ASYNC_DATABASE_URL = &quot;mysql+aiomysql://root:CXqwr12_@localhost:13306/fastapi_first?charset=utf8mb4&quot;
async_engine = create_async_engine(
    ASYNC_DATABASE_URL,
    echo=True,  #可选，输出SQL日志
    pool_size=10, #连接池大小
    max_overflow=20, #超出连接池大小外最多创建的连接数
    pool_timeout=30, #连接池中没有可用连接时，等待获取连接的最长时间
)



# 2.定义模型类：基类+表对应的模型类
# 基类：创建时间、更新时间；书籍表：id、书名、作者、价格、出版社

class Base(DeclarativeBase):
    create_time: Mapped[datetime] = mapped_column(DateTime, insert_default=func.now(),default=func.now(),comment=&quot;创建时间&quot;)
    update_time: Mapped[datetime] = mapped_column(DateTime, insert_default=func.now(), default=func.now(), onupdate=func.now(),comment=&quot;更新时间&quot;)
class Book(Base):
    __tablename__ = &quot;books&quot;
    id: Mapped[int] = mapped_column(primary_key=True, autoincrement=True,comment=&quot;书籍id&quot;)
    bookname: Mapped[str] = mapped_column(String(255),comment=&quot;书名&quot;)
    author: Mapped[str] = mapped_column(String(255),comment=&quot;作者&quot;)
    price: Mapped[float] = mapped_column(Float,comment=&quot;价格&quot;)
    publisher: Mapped[str] = mapped_column(String(255),comment=&quot;出版社&quot;)


# 3.定义函数建表 -&amp;gt;FastAPI启动时调用
async def create_tables():
    async with async_engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)


@app.on_event(&quot;startup&quot;)
async def startup_event():
    await create_tables()



# 中间件示例
# 中间件请求执行顺序是从下到上，响应执行顺序是从上到下
@app.middleware(&quot;http&quot;)
async def add_process_time_header(request, call_next):
    print(&quot;11Processing time header&quot;)
    response = await call_next(request)
    print(&quot;11After response&quot;) 
    return response

@app.middleware(&quot;http&quot;)
async def log_requests(request, call_next):
    print(f&quot;22Request URL: {request.url}&quot;)
    response = await call_next(request)
    print(f&quot;22Response status code: {response.status_code}&quot;)
    return response




@app.get(&quot;/&quot;)
async def root():
    return {&quot;Hello&quot;: &quot;ORM&quot;}


# 需求：查询功能的接口，查询图书-&amp;gt;依赖注入：创建依赖获取数据库会话+Depends注入路由处理函数
AsyncSessionLocal = async_sessionmaker(
    bind=async_engine, #绑定数据库引擎
    class_=AsyncSession, #指定会话类
    expire_on_commit=False #提交后不失效
)
# 创建依赖获取数据库会话
async def get_database():
    async with AsyncSessionLocal() as session:
        try:
            yield session #返回数据库会话路由处理函数
            await session.commit() #提交事务
        except Exception as e: 
            await session.rollback() # 有异常回滚
            raise e
        finally:
            await session.close()   #关闭会话


# 查询所有书籍
@app.get(&quot;/book/books&quot;)
async def get_books(db: AsyncSession = Depends(get_database)):
    result = await db.execute(select(Book))
    books = result.scalars().all()
    return books


#  查询单本书籍
@app.get(&quot;/book/book&quot;)
async def get_book(db: AsyncSession = Depends(get_database)):
    # 方式一
    ##result = await db.execute(select(Book))
    #book = result.scalars().first()
    # 方式二
    book = await db.get(Book, 2)  
    return book


# 通过id查询书籍
@app.get(&quot;/book/get_book{book_id}&quot;)
async def get_book(book_id: int, db: AsyncSession = Depends(get_database)):
    result = await db.execute(select(Book).where(Book.id == book_id))
    books = result.scalars().one_or_none()
    return books


# 价格大于10的书籍
@app.get(&quot;/book/search_book/&quot;)
async def search_books(db: AsyncSession = Depends(get_database)):
    result = await db.execute(select(Book).where(Book.price &amp;gt; 10))
    books = result.scalars().all()
    return books


# 模糊查询作者以曹开头的书籍和价格大于等于200的书籍
@app.get(&quot;/book/search_books_like&quot;)
async def search_books_like(db: AsyncSession = Depends(get_database)):
    result = await db.execute(select(Book).where(
        # &amp;amp; | ~，逻辑与、逻辑或、逻辑非
        (Book.author.like(&quot;曹%&quot;)) &amp;amp; (Book.price &amp;gt;= 200)
    ))
    books = result.scalars().all()
    return books

# 查询id在指定列表内的书籍
@app.get(&quot;/book/search_books_in&quot;)
async def search_books_in(db: AsyncSession = Depends(get_database)):
    
    id_list = [1,3,5,7]
    result = await db.execute(select(Book).where(
        (Book.id.in_(id_list))
    ))
    books = result.scalars().all()
    return books

# 聚合查询function
@app.get(&quot;/books/func&quot;)
async def search_books_in(db: AsyncSession = Depends(get_database)):
    result = await db.execute(select(func.count(Book.id)))
    books = result.scalar()
    return books


# 分页查询
@app.get(&quot;/books/pages&quot;)
async def search_books_in(page:int = 1,size:int = 1,db: AsyncSession = Depends(get_database)):
    offset = (page -1)*size
    limit = size
    result = await db.execute(select(Book).offset(offset).limit(limit))
    books = result.scalars().all()
    return books


class BookBase(BaseModel):
    bookname: str = Field(..., example=&quot;Sample Book&quot;)
    author: str = Field(..., example=&quot;John Doe&quot;)
    price: float = Field(..., example=19.99)
    publisher: str = Field(..., example=&quot;Sample Publisher&quot;)

# 创建单本书籍
@app.post(&quot;/book/add_book&quot;)
async def add_book(book: BookBase, db: AsyncSession = Depends(get_database)):
    db.add(Book(**book.dict()))
    await db.commit()
    return {&quot;message&quot;: &quot;Book created successfully&quot;}


# 创建多本书籍
@app.post(&quot;/book/add_books&quot;)
async def add_books(books: List[BookBase], db: AsyncSession = Depends(get_database)):
    for book in books:
        db.add(Book(**book.dict()))
    await db.commit()
    return {&quot;message&quot;: &quot;Books created successfully&quot;}


# 更新书籍信息

class BookUpdate(BaseModel):
    bookname: str = Field(..., example=&quot;Updated Book&quot;)
    author: str = Field(..., example=&quot;Updated Author&quot;)
    price: float = Field(..., example=29.99)
    publisher: str = Field(..., example=&quot;Updated Publisher&quot;)

@app.put(&quot;/book/update_book/{book_id}&quot;)
async def update_book(book_id: int,data: BookUpdate, db: AsyncSession = Depends(get_database)):
    book = await db.get(Book, book_id)

    if book is None:
        raise HTTPException(status_code=404, detail=&quot;Book not found&quot;)
    
    book.bookname = data.bookname
    book.author = data.author
    book.price = data.price
    book.publisher = data.publisher 
    await db.commit()
    return {&quot;message&quot;: &quot;Book updated successfully&quot;}

# 删除书籍
@app.delete(&quot;/book/delete_book/{book_id}&quot;)
async def delete_book(book_id: int, db: AsyncSession = Depends(get_database)):
    book = await db.get(Book, book_id)

    if book is None:
        raise HTTPException(status_code=404, detail=&quot;Book not found&quot;)
    
    await db.delete(book)
    await db.commit()
    return {&quot;message&quot;: &quot;Book deleted successfully&quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Zhao Q.H.</name></author><category term="fastapi" /><category term="Python" /><category term="fastapi" /><category term="orm" /><summary type="html">sqlalchemy[asyncio]异步的SQLAlchemy是Python的一个开源SQL工具包和对象关系映射（ORM）框架，用于简化数据库操作。 aiomysql是一个基于Python asyncio的异步MySQL客户端库，用于在高并发场景下提升数据库访问性能.</summary></entry><entry><title type="html">FastAPI框架学习</title><link href="http://localhost:4000/fastapi/2026/01/13/Fastapi-learning/" rel="alternate" type="text/html" title="FastAPI框架学习" /><published>2026-01-13T00:00:00+08:00</published><updated>2026-01-13T00:00:00+08:00</updated><id>http://localhost:4000/fastapi/2026/01/13/Fastapi-learning</id><content type="html" xml:base="http://localhost:4000/fastapi/2026/01/13/Fastapi-learning/">&lt;p&gt;在python3.13.10虚拟环境中使用fastapi cli 工具和uvicorn服务运行工具来运行FastAPI项目。&lt;/p&gt;
&lt;h1 id=&quot;python环境&quot;&gt;python环境&lt;/h1&gt;
&lt;h2 id=&quot;python-版本&quot;&gt;python 版本&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;% python3 --version
Python 3.13.10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;pip版本&quot;&gt;pip版本&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt; pip3 --version
pip 25.3 from /Library/Frameworks/Python.framework/Versions/3.13/lib/python3.13/site-packages/pip (python 3.13)
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;python3虚拟环境&quot;&gt;python3虚拟环境&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;创建虚拟环境&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;python3 -m venv venv 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;激活虚拟环境&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;source venv/bin/activate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;在虚拟环境工作&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# source ./venv/bin/activate
# deactivate
(venv) # pip --version
pip 25.3 /fastapi/venv/lib/python3.13/site-packages/pip (python 3.13)
(venv) # python --version
Python 3.13.10
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;退出虚拟环境&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# deactivate
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;在虚拟环境安装运行fastapi服务工具&quot;&gt;在虚拟环境安装运行fastapi服务工具。&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip install &quot;fastapi[standard]&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;fastapi-命令行工具&quot;&gt;fastapi 命令行工具&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;使用 fastapi工具运行fastapi服务&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# fastapi dev main.py 
# 命令
dev      Run a FastAPI app in development mode.
│ run      Run a FastAPI app in production mode.
│ deploy   Deploy a FastAPI app to FastAPI Cloud.
│ login    Login to FastAPI Cloud.
│ cloud    Manage FastAPI Cloud deployments.
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;uvicorn-命令行工具&quot;&gt;uvicorn 命令行工具&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;使用 uvicorn高兴能服务器工具运行fastapi&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;uvicorn main:app --reload
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;vscode运行和调试&quot;&gt;VSCode运行和调试&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;vscode/launch.json&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;{
    // 使用 IntelliSense 了解相关属性。 
    // 悬停以查看现有属性的描述。
    // 欲了解更多信息，请访问: https://go.microsoft.com/fwlink/?linkid=830387
    &quot;version&quot;: &quot;0.2.0&quot;,
    &quot;configurations&quot;: [
        {
            &quot;name&quot;: &quot;Python Debugger: FastAPI&quot;,
            &quot;type&quot;: &quot;debugpy&quot;,
            &quot;request&quot;: &quot;launch&quot;,
            &quot;module&quot;: &quot;uvicorn&quot;,
            &quot;python&quot;:&quot;/Users/zhaoqinghu/dev_docker/fastapi-1/venv/bin/python3&quot;, // 请根据你的虚拟环境路径进行修改
            &quot;args&quot;: [
                &quot;main:app&quot;,
                &quot;--reload&quot;
            ],
            &quot;jinja&quot;: true
        }
    ]
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;fastpai&quot;&gt;FASTPAI&lt;/h1&gt;

&lt;h2 id=&quot;依赖&quot;&gt;依赖&lt;/h2&gt;

&lt;ul&gt;
  &lt;li&gt;requirements.txt&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;annotated-doc==0.0.4
annotated-types==0.7.0
anyio==4.12.1
certifi==2026.1.4
click==8.3.1
dnspython==2.8.0
email-validator==2.3.0
fastapi==0.128.0
fastapi-cli==0.0.20
fastapi-cloud-cli==0.9.0
fastar==0.8.0
h11==0.16.0
httpcore==1.0.9
httptools==0.7.1
httpx==0.28.1
idna==3.11
Jinja2==3.1.6
markdown-it-py==4.0.0
MarkupSafe==3.0.3
mdurl==0.1.2
pydantic==2.12.5
pydantic-extra-types==2.11.0
pydantic-settings==2.12.0
pydantic_core==2.41.5
Pygments==2.19.2
python-dotenv==1.2.1
python-multipart==0.0.21
PyYAML==6.0.3
rich==14.2.0
rich-toolkit==0.17.1
rignore==0.7.6
sentry-sdk==2.49.0
shellingham==1.5.4
starlette==0.50.0
typer==0.21.1
typing-inspection==0.4.2
typing_extensions==4.15.0
urllib3==2.6.3
uvicorn==0.40.0
uvloop==0.22.1
watchfiles==1.1.1
websockets==16.0

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;安装依赖&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip install -r requirements.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;将当前虚拟环境的依赖输出到requirementtxt&quot;&gt;将当前虚拟环境的依赖输出到requirement.txt。&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;pip freeze &amp;gt; requirements.txt
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h1 id=&quot;fastapi基础入门&quot;&gt;FastAPI基础入门&lt;/h1&gt;
&lt;h2 id=&quot;第一个fastapi程序&quot;&gt;第一个FastAPI程序&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;from fastapi import FastAPI
# 创建FastAPI实例
app = FastAPI()

@app.get(&quot;/&quot;)
async def root():
    return {&quot;Hello&quot;: &quot;World&quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;路由请求&quot;&gt;路由请求&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#@FastAPI请求实例.请求方法(&quot;请求路径&quot;)
@app.get(&quot;/&quot;)

# 访问/hello 响应结果 msg: 你好 FastAPI

@app.get(&quot;/hello)
async def get_hello():
    return {&quot;msg&quot;:&quot;你好 FastAPI&quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;路径参数path&quot;&gt;路径参数path&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;原生注释&lt;/li&gt;
  &lt;li&gt;Path注释&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;@app.get(&quot;/book/{id}&quot;)
async def get_book(id: int):
    return {&quot;id&quot;:id,&quot;title&quot;:f&quot;这是第{id}本书&quot;}
@app.get(&quot;/new/cat/id/{id}&quot;)
async def get_new_cat_id(id: int=Path(default=...,ge=1,le=100)):
    return {&quot;id&quot;:id,&quot;title&quot;:f&quot;新闻分类ID为{id}&quot;}

@app.get(&quot;/new/cat/name/{name}&quot;)
async def get_new_cat_name(name: str=Path(default=...,min_length=2,max_length=5)):
    return {&quot;name&quot;:name,&quot;title&quot;:f&quot;新闻分类名称为{name}&quot;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;查询参数&quot;&gt;查询参数&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;Query类型注解&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;curl -X 'GET' \
  'http://127.0.0.1:8000/news/news_list?skip=0&amp;amp;limit=10' \
  -H 'accept: application/json'

@app.get(&quot;/news/news_list&quot;)
async def get_news_list(
    skip: int=Query(0,description=&quot;跳过的记录数&quot;,lt=100), 
    limit: int=Query(10,description=&quot;返回的记录数&quot;,gt=0,le=50)
    ):
    return {&quot;skip&quot;: skip, &quot;limit&quot;: limit}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;请求体参数&quot;&gt;请求体参数&lt;/h3&gt;

&lt;p&gt;在Http协议中，请求体的位置在HTTP请求的消息体(body)中，作用是创建、更新资源携带大量数据，如JSON。请求方法：POST、PUT等。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 导入pydantic中的BaseModel请求体参数和Field注解和验证
from pydantic import BaseModel,Field
class User(BaseModel):
    username: str=Field(default=&quot;张三&quot;,min_length=2,max_length=10,description=&quot;用户名，长度2-10&quot;)
    password: str=Field(min_length=6,max_length=20,description=&quot;密码，长度6-20&quot;)


@app.post(&quot;/register&quot;)
async def register(user: User):
    return user

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;路由响应&quot;&gt;路由响应&lt;/h2&gt;
&lt;p&gt;默认情况下，FastAPI会自动将路径操作函数返回的Python对象(字典、列表、Pydanitc模型等)，经由jsonenable_encode
转换为JSON兼容格式，并包装为JSONResponse返回。这省去了手动序列化的步骤，让开发者更专注于业务逻辑。如果
需要返回非JSON数据（如HTML、文件流），FastAPI提供了丰富的响应类型来返回不同数据。&lt;/p&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;响应类型&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;用途&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;示例&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;JSONResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;默认响应，返回JSON数据&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return JSONResponse({&quot;key&quot;: &quot;value&quot;})&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;HTMLResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;返回HTML内容&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return HTMLResponse(html_content)&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;PlainTextResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;返回纯文本&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return PlainTextResponse(&quot;Hello, World!&quot;)&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;FileResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;返回文件以供下载&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return FileResponse(&quot;/path/to/file.pdf&quot;)&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;StreamingResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;用于流式传输数据&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return StreamingResponse(some_generator_function)&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;RedirectResponse&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;将客户端重定向到指定URL&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;return RedirectResponse(url=&quot;https://example.com&quot;)&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
# 返回HTML响应
@app.get(&quot;/html&quot;,response_class=HTMLResponse)
async def get_html():
    html_content=&quot;&quot;&quot;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;title&amp;gt;&lt;/span&gt;FastAPI HTML Response&lt;span class=&quot;nt&quot;&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Hello, FastAPI!&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;This is an HTML response.&lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
    &quot;&quot;&quot;
    return HTMLResponse(content=html_content,status_code=200)
# 返回文件响应

@app.get(&quot;/file&quot;,response_class=FileResponse)
async def get_file():
    file_path=&quot;425.jpg&quot;  # 确保该文件存在于项目根目录
    return FileResponse(path=file_path)

# 自定义响应数据格式
class News(BaseModel):
    id: int
    title: str
    content: str

@app.get(path=&quot;/news/{id}&quot;,response_model=News)
async def get_news(id: int):
    news_item=News(id=id,title=f&quot;新闻标题{id}&quot;,content=f&quot;这是新闻内容{id}&quot;)
    return news_item

# 自定义异常处理
@app.get(&quot;/items/{item_id}&quot;)
async def read_item(item_id: int):
    id_list = range(1,6)
    if item_id not in id_list:
        raise HTTPException(status_code=404,detail=&quot;Item not found&quot;)
    return {&quot;item_id&quot;: item_id, &quot;name&quot;: f&quot;Item {item_id}&quot;}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;中间件&quot;&gt;中间件&lt;/h2&gt;
&lt;p&gt;中间件(Middleware)是一个在每次请求进入FastAPI应用时都会被执行的函数。
它在请求到达实际的路径操作（路由处理函数）之前运行，并且在响应返回给客户端之前在运行一次&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;        请求进入            传递请求               传递请求
        ------&amp;gt;            ------&amp;gt;              ------&amp;gt; 
客户端             中间件A              中间件B                 路由处理函数
                                  
        &amp;lt;------            &amp;lt;------              &amp;lt;------        
        返回响应             传递响应              返回响应        

# 中间件示例
# 中间件请求执行顺序是从下到上，响应执行顺序是从上到下
@app.middleware(&quot;http&quot;)
async def add_process_time_header(request, call_next):
    print(&quot;11Processing time header&quot;)
    response = await call_next(request)
    print(&quot;11After response&quot;) 
    return response

@app.middleware(&quot;http&quot;)
async def log_requests(request, call_next):
    print(f&quot;22Request URL: {request.url}&quot;)
    response = await call_next(request)
    print(f&quot;22Response status code: {response.status_code}&quot;)
    return response 
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;依赖注入&quot;&gt;依赖注入&lt;/h2&gt;

&lt;p&gt;使用依赖逐日系统来共享通用逻辑，减少代码重复。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;# 依赖注入
async def common_parameters(q: str = None, skip: int = 0, limit: int = 10):
    return {&quot;q&quot;: q, &quot;skip&quot;: skip, &quot;limit&quot;: limit}

@app.get(&quot;/depends/news_list&quot;)
async def get_news_list(common: dict = Depends(common_parameters)):
    page = common
    data = [{&quot;id&quot;:1,&quot;title&quot;:&quot;新闻1&quot;},{&quot;id&quot;:2,&quot;title&quot;:&quot;新闻2&quot;}]
    return {&quot;page&quot;: page, &quot;data&quot;: data}

@app.get(&quot;/depends/user_list&quot;)
async def get_user_list(common = Depends(common_parameters)):
    page = common
    data =  [{&quot;id&quot;:1,&quot;name&quot;:&quot;用户1&quot;},{&quot;id&quot;:2,&quot;name&quot;:&quot;用户2&quot;}]
    return {&quot;page&quot;: page, &quot;data&quot;: data}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;mainpy&quot;&gt;main.py&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;
from fastapi import FastAPI , Path, Query, HTTPException, Depends
from pydantic import BaseModel,Field
from fastapi.responses import HTMLResponse, FileResponse

app = FastAPI()

# 中间件示例
# 中间件请求执行顺序是从下到上，响应执行顺序是从上到下
@app.middleware(&quot;http&quot;)
async def add_process_time_header(request, call_next):
    print(&quot;11Processing time header&quot;)
    response = await call_next(request)
    print(&quot;11After response&quot;) 
    return response

@app.middleware(&quot;http&quot;)
async def log_requests(request, call_next):
    print(f&quot;22Request URL: {request.url}&quot;)
    response = await call_next(request)
    print(f&quot;22Response status code: {response.status_code}&quot;)
    return response




@app.get(&quot;/&quot;)
async def root():
    return {&quot;Hello&quot;: &quot;World&quot;}

@app.get(&quot;/hello&quot;)
async def get_hello():
    return {&quot;msg&quot;:&quot;你好 FastAPI&quot;}

# 路径参数
@app.get(&quot;/hello/{name}&quot;)
async def say_hello(name: str):
    return {&quot;Hello&quot;: name}
# 路径参数注解
@app.get(&quot;/book/{id}&quot;)
async def get_book(id: int):
    return {&quot;id&quot;:id,&quot;title&quot;:f&quot;这是第{id}本书&quot;}

# 路径参数加Path注解和验证
@app.get(&quot;/new/cat/id/{id}&quot;)
async def get_new_cat_id(id: int=Path(default=...,ge=1,le=100)):
    return {&quot;id&quot;:id,&quot;title&quot;:f&quot;新闻分类ID为{id}&quot;}

@app.get(&quot;/new/cat/name/{name}&quot;)
async def get_new_cat_name(name: str=Path(default=...,min_length=2,max_length=5)):
    return {&quot;name&quot;:name,&quot;title&quot;:f&quot;新闻分类名称为{name}&quot;}

# 查询参数加Query注解和验证
@app.get(&quot;/news/news_list&quot;)
async def get_news_list(
    skip: int=Query(0,description=&quot;跳过的记录数&quot;,lt=100), 
    limit: int=Query(10,description=&quot;返回的记录数&quot;,gt=0,le=50)
    ):
    return {&quot;skip&quot;: skip, &quot;limit&quot;: limit}

# 导入pydantic中的BaseModel请求体参数和Field注解和验证
class User(BaseModel):
    username: str=Field(default=&quot;张三&quot;,min_length=2,max_length=10,description=&quot;用户名，长度2-10&quot;)
    password: str=Field(min_length=6,max_length=20,description=&quot;密码，长度6-20&quot;)


@app.post(&quot;/register&quot;)
async def register(user: User):
    return user

# 返回HTML响应
@app.get(&quot;/html&quot;,response_class=HTMLResponse)
async def get_html():
    html_content=&quot;&quot;&quot;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;html&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;head&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;title&amp;gt;&lt;/span&gt;FastAPI HTML Response&lt;span class=&quot;nt&quot;&gt;&amp;lt;/title&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/head&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;body&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;h1&amp;gt;&lt;/span&gt;Hello, FastAPI!&lt;span class=&quot;nt&quot;&gt;&amp;lt;/h1&amp;gt;&lt;/span&gt;
            &lt;span class=&quot;nt&quot;&gt;&amp;lt;p&amp;gt;&lt;/span&gt;This is an HTML response.&lt;span class=&quot;nt&quot;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;
        &lt;span class=&quot;nt&quot;&gt;&amp;lt;/body&amp;gt;&lt;/span&gt;
    &lt;span class=&quot;nt&quot;&gt;&amp;lt;/html&amp;gt;&lt;/span&gt;
    &quot;&quot;&quot;
    return HTMLResponse(content=html_content,status_code=200)
# 返回文件响应

@app.get(&quot;/file&quot;,response_class=FileResponse)
async def get_file():
    file_path=&quot;425.jpg&quot;  # 确保该文件存在于项目根目录
    return FileResponse(path=file_path)

# 自定义响应数据格式
class News(BaseModel):
    id: int
    title: str
    content: str

@app.get(path=&quot;/news/{id}&quot;,response_model=News)
async def get_news(id: int):
    news_item=News(id=id,title=f&quot;新闻标题{id}&quot;,content=f&quot;这是新闻内容{id}&quot;)
    return news_item

# 自定义异常处理
@app.get(&quot;/items/{item_id}&quot;)
async def read_item(item_id: int):
    id_list = range(1,6)
    if item_id not in id_list:
        raise HTTPException(status_code=404,detail=&quot;Item not found&quot;)
    return {&quot;item_id&quot;: item_id, &quot;name&quot;: f&quot;Item {item_id}&quot;}

# 依赖注入
async def common_parameters(q: str = None, skip: int = 0, limit: int = 10):
    return {&quot;q&quot;: q, &quot;skip&quot;: skip, &quot;limit&quot;: limit}

@app.get(&quot;/depends/news_list&quot;)
async def get_news_list(common: dict = Depends(common_parameters)):
    page = common
    data = [{&quot;id&quot;:1,&quot;title&quot;:&quot;新闻1&quot;},{&quot;id&quot;:2,&quot;title&quot;:&quot;新闻2&quot;}]
    return {&quot;page&quot;: page, &quot;data&quot;: data}

@app.get(&quot;/depends/user_list&quot;)
async def get_user_list(common = Depends(common_parameters)):
    page = common
    data =  [{&quot;id&quot;:1,&quot;name&quot;:&quot;用户1&quot;},{&quot;id&quot;:2,&quot;name&quot;:&quot;用户2&quot;}]
    return {&quot;page&quot;: page, &quot;data&quot;: data}

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;swagger-api&quot;&gt;Swagger API&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/python/fastapi-swagger.png&quot; width=&quot;100%&quot; /&gt;&lt;/p&gt;

&lt;h2 id=&quot;vscode-debug&quot;&gt;VSCode debug&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/python/fastapi-vscode-debug.png&quot; width=&quot;100%&quot; /&gt;&lt;/p&gt;</content><author><name>Zhao Q.H.</name></author><category term="fastapi" /><category term="Python" /><category term="fastapi" /><summary type="html">在python3.13.10虚拟环境中使用fastapi cli 工具和uvicorn服务运行工具来运行FastAPI项目。 python环境 python 版本</summary></entry><entry><title type="html">Python pyenv版本管理工具</title><link href="http://localhost:4000/python/2026/01/09/Python-pyenv/" rel="alternate" type="text/html" title="Python pyenv版本管理工具" /><published>2026-01-09T00:00:00+08:00</published><updated>2026-01-09T00:00:00+08:00</updated><id>http://localhost:4000/python/2026/01/09/Python-pyenv</id><content type="html" xml:base="http://localhost:4000/python/2026/01/09/Python-pyenv/">&lt;p&gt;pyenv 是一个非常流行的 Python 版本管理工具，它允许你在同一系统上安装和管理多个 Python 版本。以下是如何在你的系统上安装和使用 pyenv 的步骤。&lt;/p&gt;

&lt;h2 id=&quot;安装-pyenv&quot;&gt;安装 pyenv&lt;/h2&gt;
&lt;h3 id=&quot;linux-deb&quot;&gt;Linux deb&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;步骤1：安装依赖项
在安装 pyenv 之前，需要安装一些依赖项。你可以使用以下命令安装这些依赖项：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo apt update
sudo apt install -y make build-essential libssl-dev zlib1g-dev libbz2-dev \
libreadline-dev libsqlite3-dev wget curl llvm libncurses5-dev libncursesw5-dev \
xz-utils tk-dev libffi-dev liblzma-dev python-openssl git
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;步骤2：安装 pyenv
使用 curl 或 wget 安装 pyenv：
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash
curl https://pyenv.run | bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;或者：&lt;/p&gt;
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash
wget -qO- https://pyenv.run | bash
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;步骤3：配置 shell 环境
在你的 ~/.bashrc 或 ~/.zshrc 文件中添加以下内容，以便在启动 shell 时自动加载 pyenv：
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash
export PATH=&quot;$HOME/.pyenv/bin:$PATH&quot;
eval &quot;$(pyenv init --path)&quot;
eval &quot;$(pyenv init -)&quot;
eval &quot;$(pyenv virtualenv-init -)&quot;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;然后重新加载 shell 配置文件：
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash
source ~/.bashrc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;或者&lt;/p&gt;
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;source ~/.zshrc
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;h2 id=&quot;使用-pyenv&quot;&gt;使用 pyenv&lt;/h2&gt;
  &lt;/li&gt;
  &lt;li&gt;步骤1：安装 Python 版本
安装一个指定的 Python 版本，例如 Python 3.10.2：
```
bash
pyenv install 3.10.2&lt;/li&gt;
  &lt;li&gt;步骤2：设置全局 Python 版本
设置全局使用的 Python 版本：
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;p&gt;bash
pyenv global 3.10.2
```&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;步骤3：验证安装
验证安装的 Python 版本：
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;bash
python --version
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
&lt;/ul&gt;</content><author><name>Zhao Q.H.</name></author><category term="python" /><category term="Python" /><category term="pyenv" /><summary type="html">pyenv 是一个非常流行的 Python 版本管理工具，它允许你在同一系统上安装和管理多个 Python 版本。以下是如何在你的系统上安装和使用 pyenv 的步骤。</summary></entry><entry><title type="html">Go pprof 核心指标分析与工具使用指南</title><link href="http://localhost:4000/go/2025/12/17/gin-pprof/" rel="alternate" type="text/html" title="Go pprof 核心指标分析与工具使用指南" /><published>2025-12-17T00:00:00+08:00</published><updated>2025-12-17T00:00:00+08:00</updated><id>http://localhost:4000/go/2025/12/17/gin-pprof</id><content type="html" xml:base="http://localhost:4000/go/2025/12/17/gin-pprof/">&lt;p&gt;ginpprof是Gin中间件，集成pprof，暴露/debug/pprof端点，支持CPU、内存、阻塞分析，助定位瓶颈&lt;/p&gt;
&lt;h2 id=&quot;安装&quot;&gt;安装&lt;/h2&gt;
&lt;h3 id=&quot;初始化go模块&quot;&gt;初始化Go模块&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;go mod init gin-pprof-demo
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;安装依赖&quot;&gt;安装依赖&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;go get github.com/gin-contrib/pprof
go get github.com/gin-gonic/gin
go get github.com/swaggo/swag/cmd/swag
go get github.com/swaggo/files
go get github.com/swaggo/gin-swagger
go get github.com/swaggo/swag
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;生成swagger-文档&quot;&gt;生成Swagger 文档&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;swag init
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;运行程序&quot;&gt;运行程序&lt;/h3&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;go run main.go
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;指标分类与核心说明&quot;&gt;指标分类与核心说明&lt;/h2&gt;

&lt;p&gt;Go &lt;code class=&quot;highlighter-rouge&quot;&gt;net/http/pprof&lt;/code&gt; 暴露的10个性能分析端点，按&lt;strong&gt;分析对象&lt;/strong&gt;分类如下，涵盖内存、CPU、阻塞、并发、线程、执行流程等维度，配合 &lt;code class=&quot;highlighter-rouge&quot;&gt;go tool&lt;/code&gt; 可精准定位性能瓶颈。&lt;/p&gt;

&lt;h2 id=&quot;指标详情表格&quot;&gt;指标详情表格&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;strong&gt;分类&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;指标名称&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;核心用途&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;go tool 分析命令/步骤&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;关键参数/注意事项&lt;/strong&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;内存分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;allocs&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;累计内存分配（含已释放对象），记录程序启动以来的&lt;strong&gt;所有内存分配历史&lt;/strong&gt;（字节/对象数）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/allocs&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 默认分析 &lt;code class=&quot;highlighter-rouge&quot;&gt;alloc_space&lt;/code&gt;（累计分配）&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 看累计分配大户&lt;br /&gt;- 结合 &lt;code class=&quot;highlighter-rouge&quot;&gt;heap&lt;/code&gt; 对比当前活跃内存&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;heap&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;堆内存快照（当前&lt;strong&gt;活跃对象&lt;/strong&gt;，未被GC回收的内存），记录实时内存占用。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/heap&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 默认 &lt;code class=&quot;highlighter-rouge&quot;&gt;inuse_space&lt;/code&gt;（当前活跃），用 &lt;code class=&quot;highlighter-rouge&quot;&gt;sample_index=alloc_space&lt;/code&gt; 切换累计分配&lt;br /&gt;- 多次采样后用 &lt;code class=&quot;highlighter-rouge&quot;&gt;diff&lt;/code&gt; 对比泄漏&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;list&lt;/code&gt; 定位代码行&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;CPU分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;profile&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;CPU耗时采样（默认10秒），记录函数&lt;strong&gt;CPU占用时长&lt;/strong&gt;（纳秒级）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/profile?seconds=30&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- &lt;code class=&quot;highlighter-rouge&quot;&gt;seconds=N&lt;/code&gt; 指定采样时长（建议30秒）&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 找CPU热点，&lt;code class=&quot;highlighter-rouge&quot;&gt;list&lt;/code&gt; 定位代码行&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;web&lt;/code&gt; 可视化调用图&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;阻塞分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;block&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;阻塞事件采样（channel操作、IO等待等），记录goroutine阻塞&lt;strong&gt;时长/次数&lt;/strong&gt;。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/block?seconds=30&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 需先调用 &lt;code class=&quot;highlighter-rouge&quot;&gt;runtime.SetBlockProfileRate(1)&lt;/code&gt; 启用采样&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 看阻塞热点，&lt;code class=&quot;highlighter-rouge&quot;&gt;list&lt;/code&gt; 定位阻塞代码&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mutex&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;锁竞争事件采样（&lt;code class=&quot;highlighter-rouge&quot;&gt;sync.Mutex&lt;/code&gt;），记录goroutine因锁竞争的&lt;strong&gt;阻塞时长/次数&lt;/strong&gt;。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/mutex?seconds=30&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 需先调用 &lt;code class=&quot;highlighter-rouge&quot;&gt;runtime.SetMutexProfileFraction(1)&lt;/code&gt; 启用采样&lt;br /&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 看锁竞争热点&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;并发分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;goroutine&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;当前所有goroutine的&lt;strong&gt;堆栈跟踪&lt;/strong&gt;（含状态：运行中、阻塞、死锁）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/goroutine&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;curl http://.../goroutine?debug=2 &amp;gt; goroutines.txt&lt;/code&gt; 导出堆栈&lt;br /&gt;- 搜索 &lt;code class=&quot;highlighter-rouge&quot;&gt;chan receive&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;lock&lt;/code&gt; 定位阻塞/泄漏&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;线程分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;threadcreate&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;线程创建事件采样，记录&lt;strong&gt;新线程创建的堆栈&lt;/strong&gt;（含创建耗时）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/threadcreate?seconds=30&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 看线程创建热点&lt;br /&gt;- 适合分析线程创建开销（如频繁创建线程）&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;执行流程分析&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;trace&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;执行时序跟踪（goroutine调度、GC、系统调用、请求处理流程），生成&lt;strong&gt;时序日志&lt;/strong&gt;。&lt;/td&gt;
      &lt;td&gt;1. 下载trace文件：&lt;code class=&quot;highlighter-rouge&quot;&gt;curl -o trace.bin 'http://.../trace?seconds=5'&lt;/code&gt;&lt;br /&gt;2. 分析：&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool trace trace.bin&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 需先下载二进制文件（&lt;code class=&quot;highlighter-rouge&quot;&gt;trace.bin&lt;/code&gt;），再用 &lt;code class=&quot;highlighter-rouge&quot;&gt;go tool trace&lt;/code&gt; 打开&lt;br /&gt;- 可视化界面看甘特图、goroutine分析&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;配置查看&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;cmdline&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;程序启动命令行参数（如 &lt;code class=&quot;highlighter-rouge&quot;&gt;./main -port=8080&lt;/code&gt;）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/cmdline&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 直接返回文本，查看启动配置（环境变量、GOMAXPROCS等）&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;调试工具&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;symbol&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;符号表查询接口，将&lt;strong&gt;内存地址转换为函数名&lt;/strong&gt;（供调试工具使用）。&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://localhost:8080/debug/pprof/symbol&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;- 日常分析极少用，仅调试时解析崩溃堆栈中的未知地址&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;关键说明&quot;&gt;关键说明&lt;/h2&gt;

&lt;h3 id=&quot;1-分类逻辑&quot;&gt;1. 分类逻辑&lt;/h3&gt;

&lt;p&gt;按&lt;strong&gt;分析对象&lt;/strong&gt;划分（内存、CPU、阻塞等），便于快速匹配问题类型：&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;内存问题&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;heap&lt;/code&gt;（当前泄漏）+ &lt;code class=&quot;highlighter-rouge&quot;&gt;allocs&lt;/code&gt;（累计分配）&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;CPU问题&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;profile&lt;/code&gt;（CPU热点）&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;阻塞/并发问题&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;goroutine&lt;/code&gt;（状态）+ &lt;code class=&quot;highlighter-rouge&quot;&gt;block&lt;/code&gt;（阻塞事件）+ &lt;code class=&quot;highlighter-rouge&quot;&gt;mutex&lt;/code&gt;（锁竞争）&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;时序问题&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;trace&lt;/code&gt;（甘特图分析延迟）&lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;2-通用命令与避坑点&quot;&gt;2. 通用命令与避坑点&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;&lt;strong&gt;场景&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;核心命令&lt;/strong&gt;&lt;/th&gt;
      &lt;th&gt;&lt;strong&gt;避坑点&lt;/strong&gt;&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;内存泄漏定位&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://.../heap&lt;/code&gt; → 多次采样 → &lt;code class=&quot;highlighter-rouge&quot;&gt;diff&lt;/code&gt; 对比 → &lt;code class=&quot;highlighter-rouge&quot;&gt;list&lt;/code&gt; 定位代码行&lt;/td&gt;
      &lt;td&gt;默认 &lt;code class=&quot;highlighter-rouge&quot;&gt;inuse_space&lt;/code&gt; 仅看活跃内存，需切 &lt;code class=&quot;highlighter-rouge&quot;&gt;alloc_space&lt;/code&gt; 看累计分配；小泄漏需多次采样&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;CPU热点定位&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://.../profile?seconds=30&lt;/code&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;list&lt;/code&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;web&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;采样时长建议30秒（覆盖多轮请求），避免短时波动干扰&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;阻塞事件分析&lt;/td&gt;
      &lt;td&gt;先 &lt;code class=&quot;highlighter-rouge&quot;&gt;runtime.SetBlockProfileRate(1)&lt;/code&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;go tool pprof http://.../block?seconds=30&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;未启用采样时无数据，需代码中显式开启&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;trace时序分析&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;curl -o trace.bin 'http://.../trace?seconds=5'&lt;/code&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;go tool trace trace.bin&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;需下载二进制文件（非URL直接分析），用可视化界面看甘特图&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;3-核心场景速查&quot;&gt;3. 核心场景速查&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;“内存涨了但heap没反应”&lt;/strong&gt; → 用 &lt;code class=&quot;highlighter-rouge&quot;&gt;alloc_space&lt;/code&gt; 维度 + 多次采样 &lt;code class=&quot;highlighter-rouge&quot;&gt;diff&lt;/code&gt; 对比&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;“CPU占用高但不知道哪里慢”&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;profile&lt;/code&gt; 采样 + &lt;code class=&quot;highlighter-rouge&quot;&gt;top&lt;/code&gt; 找热点函数&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;“goroutine数量爆炸”&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;goroutine&lt;/code&gt; 导出堆栈 + 搜索 &lt;code class=&quot;highlighter-rouge&quot;&gt;chan receive&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;lock&lt;/code&gt; 定位泄漏源&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;“请求延迟忽高忽低”&lt;/strong&gt; → &lt;code class=&quot;highlighter-rouge&quot;&gt;trace&lt;/code&gt; 甘特图看GC/系统调用与请求的时序重叠&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;实战示例&quot;&gt;实战示例&lt;/h2&gt;

&lt;p&gt;&lt;img src=&quot;/assets/images/go/gin-pprof-1.png&quot; width=&quot;100%&quot; /&gt;
&lt;img src=&quot;/assets/images/go/gin-pprof-2.png&quot; width=&quot;100%&quot; /&gt;
&lt;img src=&quot;/assets/images/go/gin-pprof-3.png&quot; width=&quot;100%&quot; /&gt;
&lt;img src=&quot;/assets/images/go/gin-pprof-4.png&quot; width=&quot;100%&quot; /&gt;&lt;/p&gt;</content><author><name>Zhao Q.H.</name></author><category term="go" /><category term="Gin" /><category term="pprof" /><summary type="html">ginpprof是Gin中间件，集成pprof，暴露/debug/pprof端点，支持CPU、内存、阻塞分析，助定位瓶颈 安装 初始化Go模块</summary></entry><entry><title type="html">Golang面试汇总</title><link href="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/11/mianshi-go/" rel="alternate" type="text/html" title="Golang面试汇总" /><published>2025-12-11T00:00:00+08:00</published><updated>2025-12-11T00:00:00+08:00</updated><id>http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/11/mianshi-go</id><content type="html" xml:base="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/11/mianshi-go/">&lt;h1 id=&quot;并发编程问题&quot;&gt;并发编程问题&lt;/h1&gt;
&lt;h2 id=&quot;并发知识概览&quot;&gt;并发知识概览&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;知识点&lt;/th&gt;
      &lt;th&gt;核心概念&lt;/th&gt;
      &lt;th&gt;问题&lt;/th&gt;
      &lt;th&gt;使用频率&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;context&lt;/td&gt;
      &lt;td&gt;上下文控制&lt;/td&gt;
      &lt;td&gt;golang中context使用场景？&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;goroutine&lt;/td&gt;
      &lt;td&gt;轻量级线程&lt;/td&gt;
      &lt;td&gt;golang中怎么确保所有的协程可以执行完？&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;channel&lt;/td&gt;
      &lt;td&gt;通信管道&lt;/td&gt;
      &lt;td&gt;餐厅传菜口&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;sync.WaitGroup&lt;/td&gt;
      &lt;td&gt;等待组&lt;/td&gt;
      &lt;td&gt;golang中怎么确保所有的协程可以执行完？&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;select&lt;/td&gt;
      &lt;td&gt;多路复用&lt;/td&gt;
      &lt;td&gt;golang中select的用法&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;sync.Mutex&lt;/td&gt;
      &lt;td&gt;互斥锁&lt;/td&gt;
      &lt;td&gt;厕所门锁（一次一人）&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;sync.RWMutex&lt;/td&gt;
      &lt;td&gt;读写锁&lt;/td&gt;
      &lt;td&gt;图书馆（多认读，一人写）&lt;/td&gt;
      &lt;td&gt;⭐⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;atomic&lt;/td&gt;
      &lt;td&gt;原子操作&lt;/td&gt;
      &lt;td&gt;银行柜台&lt;/td&gt;
      &lt;td&gt;⭐⭐&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;1-golang中context使用场景&quot;&gt;1. golang中context使用场景？&lt;/h2&gt;
&lt;p&gt;context通过WithCancel（取消）、WithTimeout（超时）控制协程生命周期。
context通过WithValue传递请求范围的附加信息如TraceID、UserId等元数据。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;context&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;net/http&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;strings&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;sync&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;

	&lt;span class=&quot;s2&quot;&gt;&quot;github.com/gin-gonic/gin&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;用&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Gin&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;模拟&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;HTTP&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;服务（需先安装：&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;u&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;github&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;com&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gonic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;）&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;自定义键类型（避免键冲突）&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctxKey&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;KeyTraceID&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctxKey&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;traceID&quot;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;追踪&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ID&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;键&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;KeyUserID&lt;/span&gt;  &lt;span class=&quot;n&quot;&gt;ctxKey&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;userID&quot;&lt;/span&gt;  &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;用户&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ID&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;键&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;中间件：注入&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TraceID&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;和用户身份信息到&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;metadataMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HandlerFunc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;生成&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;TraceID&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（模拟&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UUID&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;，实际可用&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uuid&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;库）&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;traceID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Sprintf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;trace-%d&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Now&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;().&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UnixNano&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;

		&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;从&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Header&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;获取&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Token&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;并解析&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UserID&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（模拟认证逻辑）&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;authHeader&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetHeader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Authorization&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;userID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;strings&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HasPrefix&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;authHeader&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;Bearer &quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;模拟解析&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Token&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;得到&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;UserID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1001&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（实际需用&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;JWT&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;库解析）&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;userID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1001&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

		&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;将元数据存入&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（链式传递）&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;KeyTraceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;traceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithValue&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;KeyUserID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;userID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;更新请求的&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;

		&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;继续处理请求&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;处理函数：从&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;获取元数据，并启动子协程传递元数据&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handleRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Request&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;从&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;获取元数据（&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;TraceID&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;、&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;UserID&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;）&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;traceID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyTraceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;userID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyUserID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;[主协程] TraceID: %s, UserID: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;traceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;userID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;启动子协程，传递&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（元数据随之传递）&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;子协程从&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;获取元数据&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;subTraceID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyTraceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;subUserID&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Value&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;KeyUserID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;).(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;[子协程] TraceID: %s, UserID: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;subTraceID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;subUserID&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;传递当前请求的&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;等待子协程完成&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StatusOK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;status&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;success&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Use&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;metadataMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;   &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;全局启用元数据中间件&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/demo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;handleRequest&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;注册接口&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;服务启动：http://localhost:8080/demo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;请求示例：curl -H 'Authorization: Bearer token' http://localhost:8080/demo&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:8080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;2-golang中怎么确保所有的协程可以执行完&quot;&gt;2. golang中怎么确保所有的协程可以执行完？&lt;/h2&gt;
&lt;p&gt;通过sync.WaitGroup中的Add()、defer Done()、Wait()来控制。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;context&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;sync&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithTimeout&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;秒超时&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;After&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;):&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;模拟&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;秒任务（超时）&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;任务完成&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;监听超时信号&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;任务超时:&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;等待协程退出（或被取消后退出）&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;主程序结束&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;3-golang中怎么退出一个协程&quot;&gt;3. golang中怎么退出一个协程？&lt;/h2&gt;
&lt;p&gt;父协程通过Context发送Cancel取消信号，子协程通过select监听Done信号退出。
父协程通过close关闭channel，子协程通过监听channel关闭信息退出。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;context&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;sync&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;子协程函数：监听&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;取消信号退出&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerWithContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;确保协程退出时通知&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;协程 %d 启动&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;n&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;():&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;监听取消信号（&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;被取消时，该通道关闭）&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;协程 %d 收到退出信号，原因：%v&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Err&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;主动退出协程&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;模拟业务逻辑（如处理任务）&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;协程 %d 工作中...（模拟任务）&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;id&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;500&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Millisecond&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;模拟耗时操作&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;sync&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;创建可取消的&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（父&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;为&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;）&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;WithCancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Background&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;确保主程序退出时取消&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;，避免资源泄漏&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;启动&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;个子协程（传递&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;和&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;WaitGroup&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;）&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Add&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;workerWithContext&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;主协程运行&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;秒后发送取消信号&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;===== 主协程发送取消信号 =====&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;cancel&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;关闭&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ctx&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Done&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;通道，所有子协程收到退出信号&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;4.&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;等待所有子协程退出&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;wg&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Wait&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;===== 所有子协程已退出，主程序结束 =====&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;4-golang中select的用法&quot;&gt;4. golang中select的用法？&lt;/h2&gt;
&lt;p&gt;同时监听多个channel，当多个 case 就绪时，随机选择一个执行，支持 default子句（非阻塞），常与 time.After组，实现超时控制。
golang中怎么完成一个原子操作？&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;math/rand&quot;&lt;/span&gt;
	&lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;taskGen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;++&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Sleep&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Duration&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;1000&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Millisecond&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;随机延迟&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;ch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;rand&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Intn&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;100&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;                                          &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;发送随机任务数据&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;%s 发送任务: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;name&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;i&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;close&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;任务发送完毕，关闭通道&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ch1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ch2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;ch3&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;chan&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;int&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;启动&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;个任务生成器&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;taskGen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;任务源1&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;taskGen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;任务源2&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;taskGen&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;任务源3&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

	&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;用&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;随机选择就绪通道处理任务&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;n&quot;&gt;select&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;通道关闭后设为&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;，避免下次监听&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;!ok {
&lt;/span&gt;				&lt;span class=&quot;n&quot;&gt;ch1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;处理 ch1 任务: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch2&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;!ok {
&lt;/span&gt;				&lt;span class=&quot;n&quot;&gt;ch2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;处理 ch2 任务: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;case&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;lt;-&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ch3&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;!ok {
&lt;/span&gt;				&lt;span class=&quot;n&quot;&gt;ch3&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
				&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;处理 ch3 任务: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;data&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
			&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;所有通道都关闭时退出&lt;/span&gt;
		&lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ch1&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ch2&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ch3&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;==&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;nil&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
			&lt;span class=&quot;k&quot;&gt;break&lt;/span&gt;
		&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
	&lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Println&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;所有任务处理完毕&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;5-golang中多协程goroutine操作map数据类型会怎么样&quot;&gt;5. golang中多协程goroutine操作map数据类型，会怎么样？&lt;/h2&gt;
&lt;p&gt;当多个 goroutine 同时对 map 进行读写操作（尤其是写操作）时，会触发数据竞争（Data Race），导致未定义行为，包括但不限于：
程序崩溃（panic）（如 fatal error: concurrent map read and map write）；
解决方法是使用sync.Mutex排他锁或者使用sync.RWMutex。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;func main() {
	m := make(map[int]int)
	var wg sync.WaitGroup
	var rwmu sync.RWMutex

	// 启动 2 个 goroutine 同时写 map
	for i := 0; i &amp;lt; 2; i++ {
		wg.Add(1)
		go func(idx int) {
			defer wg.Done()
			for j := 0; j &amp;lt; 1000; j++ {
				rwmu.Lock()         // 加锁
				m[j] = idx*1000 + j // 写操作（并发冲突！）
				rwmu.Unlock()       // 解锁
			}
		}(i)
	}

	wg.Wait()
	fmt.Println(&quot;map 大小:&quot;, len(m)) // 可能永远无法执行到这里

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;6-锁类型与并发规则&quot;&gt;6. 锁类型与并发规则​&lt;/h2&gt;
&lt;p&gt;sync.Mutex：排他锁（一刀切）
规则：任何时刻，只有一个 goroutine 能持有锁（无论是读还是写）。
效果：读写操作完全串行化，避免数据竞争，但读操作之间也无法并行（即使只是读取，也会阻塞其他读）。
sync.RWMutex：读写锁（分场景放行）
规则：
读锁（RLock/RUnlock）：可被多个 goroutine 同时持有（读并行）；
写锁（Lock/Unlock）：排他性，持有写锁时，其他 goroutine 既不能读也不能写；
读写互斥：读锁和写锁不能同时存在（读时不能写，写时不能读）。&lt;/p&gt;

&lt;h2 id=&quot;7-golang中无缓冲和有缓冲的channel区别&quot;&gt;7. golang中无缓冲和有缓冲的channel区别？&lt;/h2&gt;
&lt;p&gt;无缓冲Channel是同步通信，发送接收必须同时就绪，像面对面交接，需要频繁切换goroutine。
有缓存Channel是异步通信，有内部队列缓存数据，发送仅在队列满时阻塞，接收仅在队列空时阻塞，像投递到信箱。无缓冲用于精确同步和信号通知，有缓冲用于任务队列、流量控制和性能优化。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;func unbufferedExample() {
    ch := make(chan int)  // 无缓冲
    
    go func() {
        fmt.Println(&quot;发送前&quot;)
        ch &amp;lt;- 42           // 阻塞直到有人接收
        fmt.Println(&quot;发送后&quot;)
    }()
    
    time.Sleep(time.Second)  // 让发送方等待
    fmt.Println(&quot;接收前&quot;)
    fmt.Println(&amp;lt;-ch)        // 解除发送方阻塞
    fmt.Println(&quot;接收后&quot;)
}
// 输出: 发送前 → (等待1秒) → 接收前 → 42 → 接收后 → 发送后

func bufferedExample() {
    ch := make(chan int, 2)  // 容量2
    
    ch &amp;lt;- 1  // 立即成功
    ch &amp;lt;- 2  // 立即成功
    fmt.Println(&quot;已发送2个&quot;)
    
    ch &amp;lt;- 3  // ❌ 阻塞！缓冲区已满
    fmt.Println(&quot;这行不会执行&quot;)
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;8-golang中的原子操作&quot;&gt;8. golang中的原子操作。&lt;/h2&gt;
&lt;p&gt;sync/atomic
在 Web 接口开发（尤其是高并发场景）中，原子操作（sync/atomic）凭借无锁高效的特性，常用于简单共享状态的并发读写，避免 mutex带来的性能损耗。结合 Gin 框架.
场景：接口访问计数器（PV统计）&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&lt;span class=&quot;k&quot;&gt;package&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;import&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;fmt&quot;&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;net/http&quot;&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;strconv&quot;&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;sync/atomic&quot;&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;time&quot;&lt;/span&gt;

    &lt;span class=&quot;s2&quot;&gt;&quot;github.com/gin-gonic/gin&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;全局原子计数器（记录总&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;）&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;var&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;totalPV&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;uint64&lt;/span&gt;

&lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;统计中间件&lt;/span&gt;
&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pvMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;HandlerFunc&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;原子自增&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（无锁）&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;newPV&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atomic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;AddUint64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;将&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;存入上下文（供后续处理使用）&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Set&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;pv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;newPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;Next&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;n&quot;&gt;func&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Default&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Use&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pvMiddleware&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;())&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;全局启用&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;统计&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;接口：获取实时&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/pv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;currentPV&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atomic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LoadUint64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;原子读（避免脏读）&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StatusOK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;total_pv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;currentPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;接口：模拟业务请求（触发&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;计数）&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GET&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;/hello&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Context&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;pv&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;GetUint64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;pv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;从上下文获取当前&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;JSON&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;http&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;StatusOK&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;gin&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;H&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;message&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;hello&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&quot;current_pv&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pv&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;})&lt;/span&gt;

    &lt;span class=&quot;p&quot;&gt;//&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;每&lt;/span&gt; &lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;err&quot;&gt;秒打印一次&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;PV&lt;/span&gt;&lt;span class=&quot;err&quot;&gt;（模拟监控）&lt;/span&gt;
    &lt;span class=&quot;n&quot;&gt;go&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;func&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;ticker&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;NewTicker&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;m&quot;&gt;10&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;time&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Second&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;defer&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ticker&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Stop&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
        &lt;span class=&quot;n&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;range&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ticker&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;C&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;n&quot;&gt;fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;Printf&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;当前总 PV: %d&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;atomic&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;LoadUint64&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&amp;amp;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;totalPV&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
        &lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;}()&lt;/span&gt;

    &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;nf&quot;&gt;Run&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;:8080&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Zhao Q.H.</name></author><category term="面试" /><category term="Go" /><summary type="html">并发编程问题 并发知识概览</summary></entry><entry><title type="html">Rabbitmq面试汇总</title><link href="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms/" rel="alternate" type="text/html" title="Rabbitmq面试汇总" /><published>2025-12-05T00:00:00+08:00</published><updated>2025-12-05T00:00:00+08:00</updated><id>http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms</id><content type="html" xml:base="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms/">&lt;h2 id=&quot;消息队列&quot;&gt;消息队列&lt;/h2&gt;
&lt;p&gt;生产者将消息发往交换机，交换机依据路由规则和绑定关系将消息投递到指定队列；队列持久化存储消息，消费者监听队列获取消息，处理完成后发送 ACK，RabbitMQ 确认后删除消息 —— 形成一条完整、可靠、可控的消息流转链路。&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----------------+      路由       +-------------+      存储      +-------------+
| 生产者发送消息 | -------------&amp;gt; | 交换机路由  | -------------&amp;gt; | 队列存储消息 |
+----------------+               +-------------+               +-------------+
                                       ↑
                                       绑定关系（Exchange-Queue）
                                       ↓
+----------------+      订阅/ACK      +-------------+
| 消费者监听队列 | &amp;lt;------------------ | 消息处理完成 |
+----------------+                   +-------------+

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;生产者&quot;&gt;生产者&lt;/h2&gt;

&lt;h3 id=&quot;-如何确保几乎-100不丢-5-层防护详解&quot;&gt;✅ 如何确保“几乎 100%”不丢？—— 5 层防护详解&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;层级&lt;/th&gt;
      &lt;th&gt;机制&lt;/th&gt;
      &lt;th&gt;解决的问题&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1️⃣ 幂等控制&lt;/td&gt;
      &lt;td&gt;Redis &lt;code class=&quot;highlighter-rouge&quot;&gt;SET NX&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;防止并发压测导致重复发送&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2️⃣ 持久化&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;delivery_mode=2&lt;/code&gt; + &lt;code class=&quot;highlighter-rouge&quot;&gt;durable=true&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;防止 Broker 重启丢消息&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3️⃣ Publisher Confirms&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;ack&lt;/code&gt;/&lt;code class=&quot;highlighter-rouge&quot;&gt;nack&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;确认消息被 Broker 接收并持久化&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4️⃣ Mandatory + Return&lt;/td&gt;
      &lt;td&gt;路由失败返回&lt;/td&gt;
      &lt;td&gt;防止消息因路由错误被静默丢弃&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;5️⃣ 失败回滚&lt;/td&gt;
      &lt;td&gt;删除 Redis 标记&lt;/td&gt;
      &lt;td&gt;允许重试，避免永久阻塞&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;生产环境中生产者的标准答案&quot;&gt;生产环境中生产者的标准答案&lt;/h3&gt;
&lt;p&gt;没有一个 basic_publish()能保证消息入队，但“持久化 + confirms + mandatory + return + 幂等 + 重试”的组合拳，可以让消息丢失概率低于 0.001%，达到工业级可靠性&lt;/p&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;
use PhpAmqpLib\Exception\AMQPTimeoutException;

class ReliableRabbitMQProducer
{
    private $connection;
    private $redis; // 用于幂等控制

    public function __construct()
    {
        // 1. 建立 RabbitMQ 连接（进程内复用）
        $this-&amp;gt;connection = new AMQPStreamConnection(
            'rabbitmq', 5672, 'guest', 'guest',
            '/', false, 'plain', null, 'en_US',
            3.0, 3.0, null, false, 60
        );

        // 2. 初始化 Redis（用于幂等）
        $this-&amp;gt;redis = new Redis();
        $this-&amp;gt;redis-&amp;gt;connect('redis', 6379);
    }

    /**
     * 可靠发送消息（多层防护）
     * @param string $orderId 业务唯一ID
     * @param array $orderData 订单数据
     * @return bool 是否成功
     */
    public function sendOrderCreated(string $orderId, array $orderData): bool
    {
        $lockKey = &quot;sent:order:{$orderId}&quot;;

        // === 第1层：幂等控制（防并发压测）===
        $isFirstSend = $this-&amp;gt;redis-&amp;gt;set($lockKey, 1, ['nx', 'ex' =&amp;gt; 86400]);
        if (!$isFirstSend) {
            error_log(&quot;Duplicate request ignored: {$orderId}&quot;);
            return true; // 幂等返回成功
        }

        $channel = null;
        try {
            $channel = $this-&amp;gt;connection-&amp;gt;channel();

            // === 第2层：声明资源（幂等操作）===
            $exchange = 'orders';
            $queue = 'order.created';
            $routingKey = 'order.created';

            $channel-&amp;gt;exchange_declare($exchange, 'direct', false, true, false);
            $channel-&amp;gt;queue_declare($queue, false, true, false, false);
            $channel-&amp;gt;queue_bind($queue, $exchange, $routingKey);

            // === 第3层：构造持久化消息 + mandatory ===
            $messageId = 'order:' . $orderId . ':' . str_replace('.', '', microtime(true));
            $msg = new AMQPMessage(
                json_encode([
                    'message_id' =&amp;gt; $messageId,
                    'order_id'   =&amp;gt; $orderId,
                    'data'       =&amp;gt; $orderData,
                    'timestamp'  =&amp;gt; time()
                ]),
                [
                    'delivery_mode' =&amp;gt; AMQPMessage::DELIVERY_MODE_PERSISTENT, // 持久化
                    'content_type'  =&amp;gt; 'application/json',
                    'message_id'    =&amp;gt; $messageId,
                    'mandatory'     =&amp;gt; true  // 关键：路由失败返回给生产者
                ]
            );

            // === 第4层：开启 Publisher Confirms ===
            $channel-&amp;gt;confirm_select();

            $acked = false;
            $nacked = false;
            $returned = false;

            // 设置 ack/nack 回调
            $channel-&amp;gt;set_ack_handler(function (AMQPMessage $message) use (&amp;amp;$acked, $messageId) {
                if ($message-&amp;gt;get('message_id') === $messageId) {
                    $acked = true;
                    error_log(&quot;✅ [CONFIRMED] Message acked: {$messageId}&quot;);
                }
            });

            $channel-&amp;gt;set_nack_handler(function (AMQPMessage $message) use (&amp;amp;$nacked, $messageId) {
                if ($message-&amp;gt;get('message_id') === $messageId) {
                    $nacked = true;
                    error_log(&quot;❌ [FAILED] Message nacked: {$messageId}&quot;);
                }
            });

            // 设置 return 回调（路由失败）
            $channel-&amp;gt;set_return_listener(function ($replyCode, $replyText, $exchange, $routingKey, AMQPMessage $message) use (&amp;amp;$returned, $messageId) {
                $returned = true;
                error_log(&quot;🚨 [RETURNED] Message returned: {$replyCode} {$replyText}, msg: {$messageId}&quot;);
                // 可记录到数据库，人工处理
            });

            // === 第5层：发送消息 ===
            $channel-&amp;gt;basic_publish($msg, $exchange, $routingKey);

            // === 第6层：等待 Broker 确认（同步阻塞，最多5秒）===
            $channel-&amp;gt;wait_for_pending_acks_returns(5.0);

            // === 第7层：判断结果 ===
            if ($nacked) {
                throw new Exception(&quot;Broker nack'd the message (e.g., queue full)&quot;);
            }
            if ($returned) {
                throw new Exception(&quot;Message was returned (routing failed)&quot;);
            }
            if (!$acked) {
                throw new Exception(&quot;No ack received (network issue or broker down)&quot;);
            }

            // ✅ 成功：消息已入队并持久化
            error_log(&quot;🎉 Message successfully persisted to queue: {$messageId}&quot;);
            return true;

        } catch (Exception $e) {
            // === 第8层：失败回滚幂等标记（允许重试）===
            $this-&amp;gt;redis-&amp;gt;del($lockKey);
            error_log(&quot;❌ Send failed: {$e-&amp;gt;getMessage()} | Order: {$orderId}&quot;);
            return false;
        } finally {
            // 清理资源
            if ($channel &amp;amp;&amp;amp; $channel-&amp;gt;is_open()) {
                $channel-&amp;gt;close();
            }
        }
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;调用示例&quot;&gt;调用示例&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;$producer = new ReliableRabbitMQProducer();
$success = $producer-&amp;gt;sendOrderCreated('123456', ['amount' =&amp;gt; 99.9, 'user_id' =&amp;gt; 789]);

if ($success) {
    echo &quot;消息已可靠投递\n&quot;;
} else {
    echo &quot;投递失败，请重试或告警\n&quot;;
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;消息持久化&quot;&gt;消息持久化&lt;/h3&gt;

&lt;h3 id=&quot;幂等处理&quot;&gt;幂等处理&lt;/h3&gt;
&lt;ul&gt;
  &lt;li&gt;流程图
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;+----------------+     +------------------+     +------------------+
|   HTTP Client  | --&amp;gt; |   PHP-FPM        | --&amp;gt; |   RabbitMQ       |
| (并发压测)     |     | (生产者逻辑)      |     | (消息队列)       |
+----------------+     +------------------+     +------------------+
                           |
                           | 1. 提取 order_id
                           v
                     +------------------+
                     |   Redis: SET NX  |
                     | sent:order:X     |
                     | NX EX 3600       |
                     +------------------+
                           |
                  true → 发送消息
                          ↳ success → 完成 ✅
                          ↳ failure → DEL 标记 → 返回错误 ⚠️
                  false → 返回成功（幂等）✅
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
  &lt;/li&gt;
  &lt;li&gt;代码
    &lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;public function sendOrderCreated(string $orderId, array $data): bool
{
  $lockKey = &quot;sent:order:{$orderId}&quot;;
  $tempKey = &quot;temp:order:{$orderId}&quot;; // 可选：用临时标记

  // 方案 A：直接 SET NX（简单）
  $isFirst = $this-&amp;gt;redis-&amp;gt;set($lockKey, 1, ['nx', 'ex' =&amp;gt; 3600]);

  if (!$isFirst) {
      return true; // 幂等
  }

  // 发送消息
  try {
      $this-&amp;gt;doPublish($orderId, $data);
      return true; // 成功
  } catch (Exception $e) {
      // 关键：发送失败，清除标记！
      $this-&amp;gt;redis-&amp;gt;del($lockKey);
      error_log(&quot;Publish failed, rollback mark: {$orderId}&quot;);
      return false;
  }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;    &lt;/div&gt;
    &lt;h2 id=&quot;️-rabbitmq-消费者防重复消费与幂等处理完整方案&quot;&gt;🛡️ RabbitMQ 消费者防重复消费与幂等处理完整方案&lt;/h2&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;核心思想&lt;/strong&gt;：RabbitMQ 只保证“至少一次”或“至多一次”交付，&lt;strong&gt;不保证“恰好一次”&lt;/strong&gt;。因此，消费者必须具备&lt;strong&gt;识别重复消息、安全忽略重复、保证业务幂等&lt;/strong&gt;的能力，否则将导致资损、数据错乱等严重问题。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;一为什么必须处理重复消费&quot;&gt;一、为什么必须处理重复消费？&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;原因&lt;/th&gt;
      &lt;th&gt;说明&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;🔁 网络抖动或处理超时&lt;/td&gt;
      &lt;td&gt;RabbitMQ 未收到 ACK，重投消息&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;💥 消费者崩溃&lt;/td&gt;
      &lt;td&gt;业务已执行但未 ACK，重启后消息重发&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🧱 手动 ACK 遗漏&lt;/td&gt;
      &lt;td&gt;代码 Bug 导致忘记 &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_ack()&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🔄 集群 HA 切换&lt;/td&gt;
      &lt;td&gt;镜像队列主从切换可能触发重发&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;📤 生产者重试&lt;/td&gt;
      &lt;td&gt;网络问题导致同一条消息被发多次&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;p&gt;👉 &lt;strong&gt;结论：重复消费是分布式系统中的常态，必须设计幂等机制应对。&lt;/strong&gt;&lt;/p&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;二幂等性消费者的生命线&quot;&gt;二、幂等性：消费者的生命线&lt;/h3&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;定义&lt;/strong&gt;：无论同一条消息被消费多少次，系统的业务状态和最终结果都与只消费一次相同。&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h4 id=&quot;-幂等不是可选项而是生产环境的必选项&quot;&gt;✅ 幂等不是“可选项”，而是&lt;strong&gt;生产环境的必选项&lt;/strong&gt;。&lt;/h4&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;三五大幂等策略按推荐度排序&quot;&gt;三、五大幂等策略（按推荐度排序）&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;方案&lt;/th&gt;
      &lt;th&gt;原理&lt;/th&gt;
      &lt;th&gt;适用场景&lt;/th&gt;
      &lt;th&gt;优点&lt;/th&gt;
      &lt;th&gt;缺点&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1️⃣ &lt;strong&gt;基于 &lt;code class=&quot;highlighter-rouge&quot;&gt;message_id&lt;/code&gt; + Redis/NX&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;消费前用 &lt;code class=&quot;highlighter-rouge&quot;&gt;SET message_id NX EX&lt;/code&gt; 判断是否已处理&lt;/td&gt;
      &lt;td&gt;通用场景，尤其异步消息&lt;/td&gt;
      &lt;td&gt;✅ 简单高效&lt;br /&gt;✅ 分布式友好&lt;br /&gt;✅ 可设置过期&lt;/td&gt;
      &lt;td&gt;❌ 依赖 Redis 可用性&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2️⃣ &lt;strong&gt;基于业务主键（如 order_id）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;用业务唯一 ID 判断是否已处理&lt;/td&gt;
      &lt;td&gt;有明确业务标识的场景&lt;/td&gt;
      &lt;td&gt;✅ 无需全局 ID&lt;br /&gt;✅ 贴近业务逻辑&lt;/td&gt;
      &lt;td&gt;❌ 同一业务可能多次合法更新（如状态变更）&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3️⃣ &lt;strong&gt;数据库唯一约束&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;插入时依赖 &lt;code class=&quot;highlighter-rouge&quot;&gt;UNIQUE KEY&lt;/code&gt; 报错&lt;/td&gt;
      &lt;td&gt;数据入库、用户注册等&lt;/td&gt;
      &lt;td&gt;✅ 强一致性&lt;br /&gt;✅ 不依赖外部缓存&lt;/td&gt;
      &lt;td&gt;❌ 性能差&lt;br /&gt;❌ 需捕获异常&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4️⃣ &lt;strong&gt;状态机控制&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;业务状态只能单向流转（如：待支付 → 已支付）&lt;/td&gt;
      &lt;td&gt;有严格状态流转的业务&lt;/td&gt;
      &lt;td&gt;✅ 天然防重&lt;br /&gt;✅ 无额外存储&lt;/td&gt;
      &lt;td&gt;❌ 不适用于幂等更新（如多次加积分）&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;5️⃣ &lt;strong&gt;本地文件或内存标记&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;单机脚本可用 &lt;code class=&quot;highlighter-rouge&quot;&gt;flock()&lt;/code&gt; 或数组缓存&lt;/td&gt;
      &lt;td&gt;单机、低频场景&lt;/td&gt;
      &lt;td&gt;✅ 简单&lt;/td&gt;
      &lt;td&gt;❌ 不支持分布式&lt;br /&gt;❌ 重启丢失&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;blockquote&gt;
  &lt;p&gt;✅ &lt;strong&gt;推荐组合&lt;/strong&gt;：&lt;/p&gt;
  &lt;ul&gt;
    &lt;li&gt;常规业务：&lt;strong&gt;方案 1（&lt;code class=&quot;highlighter-rouge&quot;&gt;message_id&lt;/code&gt; + Redis）&lt;/strong&gt;&lt;/li&gt;
    &lt;li&gt;核心交易：&lt;strong&gt;方案 1 + 方案 3（数据库唯一键）双重保险&lt;/strong&gt;&lt;/li&gt;
    &lt;li&gt;状态驱动：&lt;strong&gt;方案 4（状态机）为主，辅以方案 1&lt;/strong&gt;&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;四消费者开发十大关键实践整合可靠性与可维护性&quot;&gt;四、消费者开发十大关键实践（整合可靠性与可维护性）&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;类别&lt;/th&gt;
      &lt;th&gt;实践要点&lt;/th&gt;
      &lt;th&gt;说明&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;🔐 &lt;strong&gt;1. 手动 ACK&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;禁用 &lt;code class=&quot;highlighter-rouge&quot;&gt;auto_ack=true&lt;/code&gt;，业务完成后 &lt;code class=&quot;highlighter-rouge&quot;&gt;basic_ack()&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;防止未处理完就确认，避免消息丢失&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;⚖️ &lt;strong&gt;2. 公平分发（QoS）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;basic_qos(null, 1, null)&lt;/code&gt; 控制未 ACK 消息数&lt;/td&gt;
      &lt;td&gt;避免某消费者过载，提升负载均衡&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🧼 &lt;strong&gt;3. 优雅关闭&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;捕获 &lt;code class=&quot;highlighter-rouge&quot;&gt;SIGTERM&lt;/code&gt;，停止 &lt;code class=&quot;highlighter-rouge&quot;&gt;wait()&lt;/code&gt; 并等待当前消息处理完&lt;/td&gt;
      &lt;td&gt;防止强制退出导致消息重投&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🗑️ &lt;strong&gt;4. 死信队列（DLX）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;配置 DLX 处理重试超限的消息&lt;/td&gt;
      &lt;td&gt;避免无限重入队，便于问题排查&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🕒 &lt;strong&gt;5. 控制处理时长&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;避免阻塞操作，设置 &lt;code class=&quot;highlighter-rouge&quot;&gt;read_write_timeout&lt;/code&gt;&lt;/td&gt;
      &lt;td&gt;防止心跳超时导致连接断开&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🔁 &lt;strong&gt;6. 重试策略&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;失败后 &lt;code class=&quot;highlighter-rouge&quot;&gt;nack(true)&lt;/code&gt; 重试有限次数（如 3 次）&lt;/td&gt;
      &lt;td&gt;防死循环，结合 DLX 使用&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;📊 &lt;strong&gt;7. 日志与监控&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;记录 &lt;code class=&quot;highlighter-rouge&quot;&gt;message_id&lt;/code&gt;、处理结果、重试次数&lt;/td&gt;
      &lt;td&gt;便于追踪问题，支持对账&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🆔 &lt;strong&gt;8. 唯一标识传递&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;消息体必须包含 &lt;code class=&quot;highlighter-rouge&quot;&gt;message_id&lt;/code&gt;（生产者生成）&lt;/td&gt;
      &lt;td&gt;幂等去重的依据&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🧩 &lt;strong&gt;9. 幂等优先于重试&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;先判断是否已处理，再决定是否执行业务&lt;/td&gt;
      &lt;td&gt;减少无效重试，提升性能&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;🧪 &lt;strong&gt;10. 压测验证&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;模拟网络抖动、消费者崩溃，验证去重有效性&lt;/td&gt;
      &lt;td&gt;确保方案在生产环境可靠&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;五完整处理流程以-php-为例&quot;&gt;五、完整处理流程（以 PHP 为例）&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[接收消息]
     ↓
[提取 message_id]
     ↓
[Redis SET message_id NX EX 86400]
     ↓
   ┌─────────────┐
   │ 已存在？YES  │ → 直接 ACK，跳过业务 ✅
   └─────────────┘
   ↓ NO
[执行业务逻辑]
     ↓
[成功] → ACK ✅
[失败] → 可选：删除 Redis 标记 → NACK（重试或进 DLX）⚠️

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;blockquote&gt;
  &lt;p&gt;✅ 关键点：&lt;/p&gt;
  &lt;ul&gt;
    &lt;li&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;SET NX&lt;/code&gt; 是原子操作，防并发重复处理&lt;/li&gt;
    &lt;li&gt;业务成功后才 ACK，失败可回滚标记允许重试&lt;/li&gt;
    &lt;li&gt;重试次数超限 → 进 DLX，人工介入&lt;/li&gt;
  &lt;/ul&gt;
&lt;/blockquote&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;六总结构建零资损消费者体系的四大支柱&quot;&gt;六、总结：构建“零资损”消费者体系的四大支柱&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;支柱&lt;/th&gt;
      &lt;th&gt;内涵&lt;/th&gt;
      &lt;th&gt;落地动作&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1️⃣ &lt;strong&gt;认知到位&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;接受“重复消费是常态”&lt;/td&gt;
      &lt;td&gt;设计时默认消息可能重复&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2️⃣ &lt;strong&gt;幂等优先&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;业务层具备去重能力&lt;/td&gt;
      &lt;td&gt;采用 &lt;code class=&quot;highlighter-rouge&quot;&gt;message_id&lt;/code&gt; + Redis 等方案&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3️⃣ &lt;strong&gt;机制健全&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;ACK、QoS、DLX、监控全覆盖&lt;/td&gt;
      &lt;td&gt;避免技术性重复（如未 ACK）&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4️⃣ &lt;strong&gt;验证充分&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;压测 + 对账 + 监控&lt;/td&gt;
      &lt;td&gt;确保方案在真实场景中可靠&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;hr /&gt;

&lt;h3 id=&quot;-最终建议&quot;&gt;✅ 最终建议&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;strong&gt;不要依赖 RabbitMQ 保证“只消费一次”&lt;/strong&gt; —— 它没有这个语义。&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;不要把“没报错”当成“成功”&lt;/strong&gt; —— 必须 ACK 才算完成。&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;不要把“重试”当“容错”&lt;/strong&gt; —— 无幂等的重试是灾难。&lt;/li&gt;
  &lt;li&gt;&lt;strong&gt;把“幂等”当作和“业务逻辑”同等重要的模块来设计&lt;/strong&gt;。&lt;/li&gt;
&lt;/ul&gt;

&lt;hr /&gt;

&lt;p&gt;💡 &lt;strong&gt;金句总结&lt;/strong&gt;：&lt;/p&gt;
&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;在消息驱动的系统中，消费者不是“执行者”，而是“决策者”——它必须判断：这条消息我以前见过吗？我现在该处理吗？处理错了能回滚吗？只有想清楚这三个问题，系统才能真正可靠。&lt;/strong&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;h3 id=&quot;一五大核心模块系统骨架&quot;&gt;一、五大核心模块（系统骨架）&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;模块&lt;/th&gt;
      &lt;th&gt;职责&lt;/th&gt;
      &lt;th&gt;对应代码文件&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;1️⃣ &lt;strong&gt;配置管理层&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;统一管理 RabbitMQ、Redis、队列、死信等参数，与环境解耦，支持多环境灵活切换&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;config/rabbitmq.php&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;2️⃣ &lt;strong&gt;连接资源管理&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;初始化并维护 RabbitMQ 连接、Channel、Redis 连接池，确保资源生命周期安全、异常自动清理&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BaseConsumer::initializeRabbitMQ()&lt;/code&gt;&lt;br /&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BaseConsumer::initializeRedis()&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;3️⃣ &lt;strong&gt;消息消费引擎&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;实现消费循环、回调分发、手动 ACK/NACK 控制、QoS 公平分发，保障消息可靠投递与负载均衡&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BaseConsumer::startConsuming()&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;4️⃣ &lt;strong&gt;业务处理核心&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;抽象业务处理逻辑，内置幂等去重、事务控制、重试机制、死信策略，确保业务执行的准确性和容错性&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BaseConsumer::onMessage()&lt;/code&gt;&lt;br /&gt;+ 子类 &lt;code class=&quot;highlighter-rouge&quot;&gt;processMessage()&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;5️⃣ &lt;strong&gt;运维支撑体系&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;提供结构化日志、监控埋点、优雅关闭（信号处理）、Supervisor 进程托管，保障系统可观测性与高可用&lt;/td&gt;
      &lt;td&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;BaseConsumer::signalHandler()&lt;/code&gt;&lt;br /&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;bin/consumer.php&lt;/code&gt;&lt;br /&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;supervisor/*.conf&lt;/code&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;ul&gt;
  &lt;li&gt;一、 配置文件 (config/rabbitmq.php)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
return [
    // RabbitMQ 连接配置
    'rabbitmq' =&amp;gt; [
        'host' =&amp;gt; 'rabbitmq-host',
        'port' =&amp;gt; 5672,
        'username' =&amp;gt; 'your_username',
        'password' =&amp;gt; 'your_password',
        'vhost' =&amp;gt; '/',
        'heartbeat' =&amp;gt; 60,
        'read_write_timeout' =&amp;gt; 60,
    ],
    
    // 队列配置
    'queues' =&amp;gt; [
        'order.created' =&amp;gt; [
            'name' =&amp;gt; 'order.created',
            'exchange' =&amp;gt; 'orders',
            'routing_key' =&amp;gt; 'order.created',
            'durable' =&amp;gt; true,
            'prefetch' =&amp;gt; 1, // 公平分发
            'retry_count' =&amp;gt; 3, // 最大重试次数
            'retry_delay' =&amp;gt; 5000, // 重试延迟(毫秒)
        ],
        'payment.success' =&amp;gt; [
            'name' =&amp;gt; 'payment.success',
            'exchange' =&amp;gt; 'payments',
            'routing_key' =&amp;gt; 'payment.success',
            'durable' =&amp;gt; true,
            'prefetch' =&amp;gt; 2,
            'retry_count' =&amp;gt; 5,
            'retry_delay' =&amp;gt; 10000,
        ],
    ],
    
    // Redis 配置（用于幂等）
    'redis' =&amp;gt; [
        'host' =&amp;gt; 'redis-host',
        'port' =&amp;gt; 6379,
        'password' =&amp;gt; '',
        'database' =&amp;gt; 0,
        'timeout' =&amp;gt; 3,
    ],
    
    // 死信队列配置
    'dead_letter' =&amp;gt; [
        'enabled' =&amp;gt; true,
        'exchange' =&amp;gt; 'dlx.orders',
        'queue' =&amp;gt; 'dlx.order.created',
        'ttl' =&amp;gt; 60000, // 消息在队列中存活时间(毫秒)
    ],
];
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;二、 核心消费者类 (app/Consumers/BaseConsumer.php)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
namespace App\Consumers;

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;
use PhpAmqpLib\Exception\AMQPTimeoutException;
use Redis;
use Psr\Log\LoggerInterface;

abstract class BaseConsumer
{
    protected $connection;
    protected $channel;
    protected $redis;
    protected $logger;
    protected $config;
    
    // 信号控制
    protected $shouldStop = false;
    protected $currentMessage = null;
    protected $currentStartTime = 0;

    public function __construct(array $config, LoggerInterface $logger)
    {
        $this-&amp;gt;config = $config;
        $this-&amp;gt;logger = $logger;
        $this-&amp;gt;setupSignalHandlers();
    }

    /**
     * 初始化连接和资源
     */
    public function initialize(): void
    {
        // 初始化 Redis
        $this-&amp;gt;initializeRedis();
        
        // 初始化 RabbitMQ 连接
        $this-&amp;gt;initializeRabbitMQ();
    }

    /**
     * 初始化 Redis
     */
    protected function initializeRedis(): void
    {
        try {
            $this-&amp;gt;redis = new Redis();
            $redisConfig = $this-&amp;gt;config['redis'];
            
            if (!$this-&amp;gt;redis-&amp;gt;connect(
                $redisConfig['host'], 
                $redisConfig['port'], 
                $redisConfig['timeout']
            )) {
                throw new \Exception(&quot;Redis connection failed&quot;);
            }
            
            if (!empty($redisConfig['password'])) {
                $this-&amp;gt;redis-&amp;gt;auth($redisConfig['password']);
            }
            
            $this-&amp;gt;redis-&amp;gt;select($redisConfig['database']);
            
            $this-&amp;gt;logger-&amp;gt;info(&quot;Redis connected successfully&quot;);
        } catch (\Exception $e) {
            $this-&amp;gt;logger-&amp;gt;error(&quot;Redis initialization failed: &quot; . $e-&amp;gt;getMessage());
            throw $e;
        }
    }

    /**
     * 初始化 RabbitMQ 连接
     */
    protected function initializeRabbitMQ(): void
    {
        try {
            $rabbitConfig = $this-&amp;gt;config['rabbitmq'];
            
            $this-&amp;gt;connection = new AMQPStreamConnection(
                $rabbitConfig['host'],
                $rabbitConfig['port'],
                $rabbitConfig['username'],
                $rabbitConfig['password'],
                $rabbitConfig['vhost'],
                false,
                'AMQPLAIN',
                null,
                'en_US',
                $rabbitConfig['read_write_timeout'],
                $rabbitConfig['read_write_timeout'],
                null,
                false,
                $rabbitConfig['heartbeat']
            );

            $this-&amp;gt;channel = $this-&amp;gt;connection-&amp;gt;channel();
            
            // 设置 QoS（公平分发）
            $this-&amp;gt;channel-&amp;gt;basic_qos(null, $this-&amp;gt;getPrefetchCount(), null);
            
            $this-&amp;gt;logger-&amp;gt;info(&quot;RabbitMQ connected successfully&quot;);
        } catch (\Exception $e) {
            $this-&amp;gt;logger-&amp;gt;error(&quot;RabbitMQ initialization failed: &quot; . $e-&amp;gt;getMessage());
            throw $e;
        }
    }

    /**
     * 声明队列和绑定
     */
    protected function declareQueue(string $queueName): void
    {
        $queueConfig = $this-&amp;gt;config['queues'][$queueName];
        
        // 声明死信交换机和队列（如果启用）
        if ($this-&amp;gt;config['dead_letter']['enabled']) {
            $this-&amp;gt;declareDeadLetter($queueName);
        }

        // 声明主队列
        $args = [];
        if ($this-&amp;gt;config['dead_letter']['enabled']) {
            $args['x-dead-letter-exchange'] = $this-&amp;gt;config['dead_letter']['exchange'];
            $args['x-dead-letter-routing-key'] = $this-&amp;gt;config['dead_letter']['queue'];
            $args['x-message-ttl'] = $this-&amp;gt;config['dead_letter']['ttl'];
        }

        $this-&amp;gt;channel-&amp;gt;queue_declare(
            $queueConfig['name'],
            false, // passive
            $queueConfig['durable'], // durable
            false, // exclusive
            false, // auto_delete
            false, // nowait
            $args // arguments
        );

        // 声明交换机
        $this-&amp;gt;channel-&amp;gt;exchange_declare(
            $queueConfig['exchange'],
            'direct', // type
            false, // passive
            $queueConfig['durable'], // durable
            false // auto_delete
        );

        // 绑定队列到交换机
        $this-&amp;gt;channel-&amp;gt;queue_bind(
            $queueConfig['name'],
            $queueConfig['exchange'],
            $queueConfig['routing_key']
        );

        $this-&amp;gt;logger-&amp;gt;info(&quot;Queue {$queueName} declared and bound successfully&quot;);
    }

    /**
     * 声明死信队列
     */
    protected function declareDeadLetter(string $queueName): void
    {
        $dlxConfig = $this-&amp;gt;config['dead_letter'];
        $queueConfig = $this-&amp;gt;config['queues'][$queueName];

        // 声明死信交换机
        $this-&amp;gt;channel-&amp;gt;exchange_declare(
            $dlxConfig['exchange'],
            'direct',
            false,
            true,
            false
        );

        // 声明死信队列
        $this-&amp;gt;channel-&amp;gt;queue_declare(
            $dlxConfig['queue'] . '.' . $queueName,
            false,
            true,
            false,
            false
        );

        // 绑定死信队列
        $this-&amp;gt;channel-&amp;gt;queue_bind(
            $dlxConfig['queue'] . '.' . $queueName,
            $dlxConfig['exchange'],
            $queueConfig['routing_key']
        );
    }

    /**
     * 消息处理函数（子类必须实现）
     */
    abstract protected function processMessage(array $data, array $headers): bool;

    /**
     * 获取消息去重键
     */
    protected function getDeduplicationKey(AMQPMessage $message): string
    {
        $data = json_decode($message-&amp;gt;getBody(), true);
        return $data['message_id'] ?? $message-&amp;gt;getDeliveryTag() . '_' . md5($message-&amp;gt;getBody());
    }

    /**
     * 检查消息是否已处理（幂等性）
     */
    protected function isMessageProcessed(string $deduplicationKey): bool
    {
        $key = &quot;processed:message:{$deduplicationKey}&quot;;
        return $this-&amp;gt;redis-&amp;gt;exists($key);
    }

    /**
     * 标记消息已处理
     */
    protected function markMessageProcessed(string $deduplicationKey, int $ttl = 86400): void
    {
        $key = &quot;processed:message:{$deduplicationKey}&quot;;
        $this-&amp;gt;redis-&amp;gt;setex($key, $ttl, 1);
    }

    /**
     * 消息消费回调
     */
    public function onMessage(AMQPMessage $message): void
    {
        $this-&amp;gt;currentMessage = $message;
        $this-&amp;gt;currentStartTime = microtime(true);

        try {
            // 提取消息内容
            $data = json_decode($message-&amp;gt;getBody(), true);
            if (json_last_error() !== JSON_ERROR_NONE) {
                throw new \Exception(&quot;Invalid JSON: &quot; . json_last_error_msg());
            }

            $headers = $message-&amp;gt;get_properties();
            $deduplicationKey = $this-&amp;gt;getDeduplicationKey($message);

            $this-&amp;gt;logger-&amp;gt;info(&quot;Processing message&quot;, [
                'message_id' =&amp;gt; $data['message_id'] ?? 'unknown',
                'delivery_tag' =&amp;gt; $message-&amp;gt;getDeliveryTag(),
                'redelivered' =&amp;gt; $message-&amp;gt;isRedelivered()
            ]);

            // 幂等性检查
            if ($this-&amp;gt;isMessageProcessed($deduplicationKey)) {
                $this-&amp;gt;logger-&amp;gt;info(&quot;Duplicate message detected, skipping&quot;, [
                    'message_id' =&amp;gt; $data['message_id'] ?? 'unknown'
                ]);
                $message-&amp;gt;ack();
                return;
            }

            // 业务处理
            $success = $this-&amp;gt;processMessage($data, $headers);

            if ($success) {
                // 标记消息已处理
                $this-&amp;gt;markMessageProcessed($deduplicationKey);
                
                // 确认消息
                $message-&amp;gt;ack();
                
                $processingTime = round((microtime(true) - $this-&amp;gt;currentStartTime) * 1000, 2);
                $this-&amp;gt;logger-&amp;gt;info(&quot;Message processed successfully&quot;, [
                    'message_id' =&amp;gt; $data['message_id'] ?? 'unknown',
                    'processing_time_ms' =&amp;gt; $processingTime
                ]);
            } else {
                throw new \Exception(&quot;Business processing failed&quot;);
            }

        } catch (\Exception $e) {
            $this-&amp;gt;handleProcessingFailure($message, $e);
        } finally {
            $this-&amp;gt;currentMessage = null;
            $this-&amp;gt;currentStartTime = 0;
        }
    }

    /**
     * 处理处理失败
     */
    protected function handleProcessingFailure(AMQPMessage $message, \Exception $e): void
    {
        $data = json_decode($message-&amp;gt;getBody(), true);
        $messageId = $data['message_id'] ?? 'unknown';
        
        $processingTime = round((microtime(true) - $this-&amp;gt;currentStartTime) * 1000, 2);
        
        $this-&amp;gt;logger-&amp;gt;error(&quot;Message processing failed&quot;, [
            'message_id' =&amp;gt; $messageId,
            'error' =&amp;gt; $e-&amp;gt;getMessage(),
            'processing_time_ms' =&amp;gt; $processingTime,
            'delivery_tag' =&amp;gt; $message-&amp;gt;getDeliveryTag(),
            'redelivered' =&amp;gt; $message-&amp;gt;isRedelivered()
        ]);

        // 根据重试次数决定是否重试或拒绝
        $retryCount = $this-&amp;gt;getCurrentRetryCount($message);
        $maxRetries = $this-&amp;gt;getMaxRetryCount();

        if ($retryCount &amp;lt; $maxRetries) {
            // 重试：重新入队
            $this-&amp;gt;logger-&amp;gt;info(&quot;Retrying message&quot;, [
                'message_id' =&amp;gt; $messageId,
                'retry_count' =&amp;gt; $retryCount + 1,
                'max_retries' =&amp;gt; $maxRetries
            ]);
            
            // 延迟重试（通过 TTL 实现）
            $message-&amp;gt;nack(false); // 不重新入队，等待 TTL 后进入死信或重新发布
        } else {
            // 达到最大重试次数，拒绝消息（进入死信队列）
            $this-&amp;gt;logger-&amp;gt;warning(&quot;Max retries exceeded, sending to dead letter&quot;, [
                'message_id' =&amp;gt; $messageId,
                'retry_count' =&amp;gt; $retryCount
            ]);
            
            $message-&amp;gt;nack(false); // 拒绝，不重新入队
        }
    }

    /**
     * 获取当前重试次数
     */
    protected function getCurrentRetryCount(AMQPMessage $message): int
    {
        $headers = $message-&amp;gt;get_properties();
        $retryCount = $headers['application_headers']['x-retry-count'][1] ?? 0;
        return (int)$retryCount;
    }

    /**
     * 获取最大重试次数
     */
    protected function getMaxRetryCount(): int
    {
        return $this-&amp;gt;config['queues']['order.created']['retry_count'] ?? 3;
    }

    /**
     * 获取预取计数
     */
    protected function getPrefetchCount(): int
    {
        return $this-&amp;gt;config['queues']['order.created']['prefetch'] ?? 1;
    }

    /**
     * 设置信号处理器（优雅关闭）
     */
    protected function setupSignalHandlers(): void
    {
        pcntl_signal(SIGTERM, [$this, 'signalHandler']);
        pcntl_signal(SIGINT, [$this, 'signalHandler']);
        pcntl_signal(SIGHUP, [$this, 'signalHandler']);
    }

    /**
     * 信号处理
     */
    public function signalHandler(int $signal): void
    {
        $this-&amp;gt;logger-&amp;gt;info(&quot;Received signal {$signal}, shutting down gracefully...&quot;);
        $this-&amp;gt;shouldStop = true;
    }

    /**
     * 开始消费
     */
    public function startConsuming(string $queueName): void
    {
        $this-&amp;gt;declareQueue($queueName);

        $this-&amp;gt;logger-&amp;gt;info(&quot;Starting consumer for queue: {$queueName}&quot;);

        $callback = function (AMQPMessage $message) {
            // 检查是否需要停止
            pcntl_signal_dispatch();
            if ($this-&amp;gt;shouldStop) {
                $this-&amp;gt;logger-&amp;gt;info(&quot;Stopping consumer due to shutdown signal&quot;);
                throw new \Exception(&quot;Consumer shutdown requested&quot;);
            }

            $this-&amp;gt;onMessage($message);
        };

        $queueConfig = $this-&amp;gt;config['queues'][$queueName];
        
        $this-&amp;gt;channel-&amp;gt;basic_consume(
            $queueConfig['name'],
            '', // consumer tag
            false, // no local
            false, // no ack (we do manual ack)
            false, // exclusive
            false, // no wait
            $callback
        );

        // 主循环
        try {
            while (count($this-&amp;gt;channel-&amp;gt;callbacks) &amp;amp;&amp;amp; !$this-&amp;gt;shouldStop) {
                $this-&amp;gt;channel-&amp;gt;wait(null, false, 1); // 1秒超时，便于检查停止信号
                pcntl_signal_dispatch();
            }
        } catch (\Exception $e) {
            $this-&amp;gt;logger-&amp;gt;info(&quot;Consumer stopped: &quot; . $e-&amp;gt;getMessage());
        }

        $this-&amp;gt;logger-&amp;gt;info(&quot;Consumer stopped gracefully&quot;);
    }

    /**
     * 关闭连接
     */
    public function close(): void
    {
        try {
            if ($this-&amp;gt;channel &amp;amp;&amp;amp; $this-&amp;gt;channel-&amp;gt;is_open()) {
                $this-&amp;gt;channel-&amp;gt;close();
            }
            if ($this-&amp;gt;connection &amp;amp;&amp;amp; $this-&amp;gt;connection-&amp;gt;isConnected()) {
                $this-&amp;gt;connection-&amp;gt;close();
            }
            if ($this-&amp;gt;redis) {
                $this-&amp;gt;redis-&amp;gt;close();
            }
            $this-&amp;gt;logger-&amp;gt;info(&quot;All connections closed&quot;);
        } catch (\Exception $e) {
            $this-&amp;gt;logger-&amp;gt;error(&quot;Error closing connections: &quot; . $e-&amp;gt;getMessage());
        }
    }

    public function __destruct()
    {
        $this-&amp;gt;close();
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;三、 具体业务消费者 (app/Consumers/OrderCreatedConsumer.php)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
namespace App\Consumers;

use Psr\Log\LoggerInterface;

class OrderCreatedConsumer extends BaseConsumer
{
    public function __construct(array $config, LoggerInterface $logger)
    {
        parent::__construct($config, $logger);
    }

    /**
     * 业务消息处理
     */
    protected function processMessage(array $data, array $headers): bool
    {
        try {
            $messageId = $data['message_id'] ?? 'unknown';
            $orderId = $data['order_id'] ?? null;
            $orderData = $data['data'] ?? [];

            if (!$orderId) {
                throw new \Exception(&quot;Missing order_id in message&quot;);
            }

            $this-&amp;gt;logger-&amp;gt;info(&quot;Processing order creation&quot;, [
                'order_id' =&amp;gt; $orderId,
                'message_id' =&amp;gt; $messageId
            ]);

            // 模拟业务处理：创建订单、扣库存、发通知等
            // 这里应该是你的实际业务逻辑
            $result = $this-&amp;gt;createOrder($orderId, $orderData);
            
            if (!$result) {
                throw new \Exception(&quot;Order creation failed for order_id: {$orderId}&quot;);
            }

            // 模拟数据库事务提交
            $this-&amp;gt;commitTransaction();

            return true;

        } catch (\Exception $e) {
            $this-&amp;gt;rollbackTransaction();
            throw $e;
        }
    }

    /**
     * 创建订单业务逻辑
     */
    private function createOrder(string $orderId, array $orderData): bool
    {
        // 这里实现你的订单创建逻辑
        // 例如：写入数据库、调用库存服务、发送通知等
        
        // 模拟处理时间
        usleep(rand(100000, 500000)); // 0.1-0.5秒
        
        // 模拟偶尔的失败（用于测试重试机制）
        if (rand(1, 100) &amp;lt;= 5) { // 5% 失败率
            return false;
        }
        
        $this-&amp;gt;logger-&amp;gt;info(&quot;Order created successfully&quot;, ['order_id' =&amp;gt; $orderId]);
        return true;
    }

    /**
     * 提交事务
     */
    private function commitTransaction(): void
    {
        // 实现你的事务提交逻辑
        // 例如：DB::commit() 或其他服务的确认
    }

    /**
     * 回滚事务
     */
    private function rollbackTransaction(): void
    {
        // 实现你的事务回滚逻辑
        // 例如：DB::rollBack() 或其他服务的取消
    }
}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;四、 消费者启动脚本 (bin/consumer.php)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;#!/usr/bin/env php
&lt;span class=&quot;cp&quot;&gt;&amp;lt;?php&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/../vendor/autoload.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;App\Consumers\OrderCreatedConsumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Monolog\Logger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Monolog\Handler\RotatingFileHandler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;k&quot;&gt;use&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Monolog\Formatter\LineFormatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// 加载配置
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;require_once&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/../config/rabbitmq.php'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// 初始化日志
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$logger&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'rabbitmq_consumer'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;c1&quot;&gt;// 文件处理器（按天轮转，保留30天）
&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$fileHandler&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;RotatingFileHandler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;nx&quot;&gt;__DIR__&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;s1&quot;&gt;'/../logs/consumer.log'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;mi&quot;&gt;30&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;c1&quot;&gt;// 保留天数
&lt;/span&gt;    &lt;span class=&quot;nx&quot;&gt;Logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;::&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;INFO&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;nv&quot;&gt;$formatter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;LineFormatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;[%datetime%] %channel%.%level_name%: %message% %context% %extra%&lt;/span&gt;&lt;span class=&quot;se&quot;&gt;\n&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;s2&quot;&gt;&quot;Y-m-d H:i:s.u&quot;&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$fileHandler&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;setFormatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$formatter&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;nv&quot;&gt;$logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;pushHandler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$fileHandler&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;

&lt;span class=&quot;k&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;c1&quot;&gt;// 创建消费者实例
&lt;/span&gt;    &lt;span class=&quot;nv&quot;&gt;$consumer&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;nx&quot;&gt;OrderCreatedConsumer&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nv&quot;&gt;$config&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$logger&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    
    &lt;span class=&quot;c1&quot;&gt;// 初始化连接
&lt;/span&gt;    &lt;span class=&quot;nv&quot;&gt;$consumer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;initialize&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;();&lt;/span&gt;
    
    &lt;span class=&quot;c1&quot;&gt;// 开始消费（优雅关闭支持）
&lt;/span&gt;    &lt;span class=&quot;nv&quot;&gt;$consumer&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;startConsuming&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s1&quot;&gt;'order.created'&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
    
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;catch&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;nx&quot;&gt;\Exception&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;nv&quot;&gt;$logger&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;critical&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;s2&quot;&gt;&quot;Consumer failed to start: &quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getMessage&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(),&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;[&lt;/span&gt;
        &lt;span class=&quot;s1&quot;&gt;'exception'&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&quot;nv&quot;&gt;$e&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt;&lt;span class=&quot;na&quot;&gt;getTraceAsString&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;()&lt;/span&gt;
    &lt;span class=&quot;p&quot;&gt;]);&lt;/span&gt;
    &lt;span class=&quot;k&quot;&gt;exit&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;);&lt;/span&gt;
&lt;span class=&quot;p&quot;&gt;}&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;五、 Supervisor 配置 (supervisor/consumer.conf)&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;[program:rabbitmq-order-consumer]
process_name=%(program_name)s_%(process_num)02d
command=/usr/bin/php /path/to/your/project/bin/consumer.php
directory=/path/to/your/project
numprocs=2
autostart=true
autorestart=true
startretries=3
user=www-data
redirect_stderr=true
stdout_logfile=/path/to/your/project/logs/supervisor.log
stopwaitsecs=30
killasgroup=true
priority=999

; 环境变量
environment=APP_ENV=&quot;production&quot;,APP_DEBUG=&quot;false&quot;

; 停止信号（优雅关闭）
stopsignal=TERM
stopasgroup=true
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h3 id=&quot;-使用方式&quot;&gt;🚀 使用方式&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;一、 安装依赖：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;composer require php-amqplib/php-amqplib monolog/monolog predis/predis
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;ul&gt;
  &lt;li&gt;二、 配置 Supervisor：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;sudo cp supervisor/consumer.conf /etc/supervisor/conf.d/
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start rabbitmq-order-consumer:*
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;ul&gt;
  &lt;li&gt;三、 监控日志：&lt;/li&gt;
&lt;/ul&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;tail -f logs/consumer.log
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</content><author><name>Zhao Q.H.</name></author><category term="面试" /><category term="rabbitmq" /><summary type="html">消息队列 生产者将消息发往交换机，交换机依据路由规则和绑定关系将消息投递到指定队列；队列持久化存储消息，消费者监听队列获取消息，处理完成后发送 ACK，RabbitMQ 确认后删除消息 —— 形成一条完整、可靠、可控的消息流转链路。</summary></entry><entry><title type="html">XHProf性能分析工具。</title><link href="http://localhost:4000/php/2025/12/03/xhprof/" rel="alternate" type="text/html" title="XHProf性能分析工具。" /><published>2025-12-03T00:00:00+08:00</published><updated>2025-12-03T00:00:00+08:00</updated><id>http://localhost:4000/php/2025/12/03/xhprof</id><content type="html" xml:base="http://localhost:4000/php/2025/12/03/xhprof/">&lt;p&gt;XHProf 最初由 Facebook 开源，曾是 PHP 性能分析的标杆工具；如今在社区的持续维护下，已实现对 PHP 8.4 的完整支持，凭借其低开销采样、多维度指标采集（时间、内存、调用栈）和可视化调用图能力，依然是 PHP 开发者在开发调试与生产诊断中进行性能瓶颈定位的高效利器。&lt;/p&gt;

&lt;h2 id=&quot;xhprof2310报告表头&quot;&gt;XHProf2.3.10报告表头&lt;/h2&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;英文表头&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;中文解释&lt;/th&gt;
      &lt;th style=&quot;text-align: left&quot;&gt;详细说明与重要性&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Function Name&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;函数名称&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;被调用的函数或方法的完整名称。例如 &lt;code class=&quot;highlighter-rouge&quot;&gt;main()&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;mysql_query&lt;/code&gt;, &lt;code class=&quot;highlighter-rouge&quot;&gt;UserController::index()&lt;/code&gt;。这是识别代码位置的关键。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Calls&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;调用次数&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;该函数在此次请求中被调用的总次数。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：如果一个函数被调用了成千上万次（例如循环内），即使单次很快，累积起来也可能成为性能瓶颈。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Calls%&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;调用次数占比&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;该函数的调用次数占总调用次数的百分比。&lt;br /&gt;&lt;strong&gt;用途&lt;/strong&gt;：帮助识别哪些函数是程序的主要执行路径。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Incl. Wall Time (microsec)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;总耗时 (微秒)&lt;/strong&gt; &lt;br /&gt;&lt;em&gt;(或: 包含实际时间)&lt;/em&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;核心指标&lt;/strong&gt;。指函数从开始到结束的总耗时，&lt;strong&gt;包括其内部调用的所有子函数的时间&lt;/strong&gt;。&lt;br /&gt;单位：微秒 (1秒 = 1,000,000 微秒)。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：用于定位哪个大的功能模块最耗时。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;IWall%&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;总耗时占比&lt;/strong&gt; &lt;br /&gt;&lt;em&gt;(或: 包含实际时间占比)&lt;/em&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;该函数的包含时间占总包含时间的百分比。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：直观地看出每个函数对总响应时间的“贡献”比例。&lt;code class=&quot;highlighter-rouge&quot;&gt;main()&lt;/code&gt; 函数永远是 100%。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Excl. Wall Time (microsec)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;自身耗时 (微秒)&lt;/strong&gt; &lt;br /&gt;&lt;em&gt;(或: 独占实际时间)&lt;/em&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;另一个核心指标&lt;/strong&gt;。指函数自身的执行时间，&lt;strong&gt;不包括其内部调用的任何子函数的时间&lt;/strong&gt;。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：这是&lt;strong&gt;优化的关键&lt;/strong&gt;！如果这个值很高，说明函数自身的逻辑（算法、循环、计算）需要优化。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;EWall%&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;自身耗时占比&lt;/strong&gt; &lt;br /&gt;&lt;em&gt;(或: 独占实际时间占比)&lt;/em&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;该函数的独占时间占总时间的百分比。&lt;br /&gt;&lt;strong&gt;用途&lt;/strong&gt;：辅助判断函数自身逻辑的耗时占比。但通常我们更关注绝对值。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Incl. CPU (microsecs)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;总CPU时间 (微秒)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;类似于 &lt;code class=&quot;highlighter-rouge&quot;&gt;总耗时&lt;/code&gt;，但是统计的是CPU实际工作的时间，排除了等待时间（如I/O、网络、sleep）。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：如果 &lt;code class=&quot;highlighter-rouge&quot;&gt;总耗时&lt;/code&gt; 很高但 &lt;code class=&quot;highlighter-rouge&quot;&gt;总CPU时间&lt;/code&gt; 很低，说明瓶颈可能在I/O或外部服务（数据库、API调用）。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Excl. CPU (microsecs)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;自身CPU时间 (微秒)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;类似于 &lt;code class=&quot;highlighter-rouge&quot;&gt;自身耗时&lt;/code&gt;，是函数自身消耗的纯CPU时间。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Incl. MemUse (bytes)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;包含内存占用 (字节)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;函数执行过程中分配的内存总量，包括其子函数分配的内存。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Excl. MemUse (bytes)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;独占内存占用 (字节)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;函数自身直接分配的内存量，不包括子函数。&lt;br /&gt;&lt;strong&gt;重要性&lt;/strong&gt;：用于发现内存泄漏或大对象分配的热点。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Incl. PeakMemUse (bytes)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;包含峰值内存 (字节)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;在函数执行期间，整个进程达到的内存使用峰值，包括子函数的影响。&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;Excl. PeakMemUse (bytes)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;&lt;strong&gt;独占峰值内存 (字节)&lt;/strong&gt;&lt;/td&gt;
      &lt;td style=&quot;text-align: left&quot;&gt;在函数自身执行栈帧内达到的内存峰值。&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&quot;xhprof扩展地址&quot;&gt;xhprof扩展地址&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://pecl.php.net/package/xhprof&quot;&gt;https://pecl.php.net/package/xhprof&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;xhprof代码地址&quot;&gt;xhprof代码地址&lt;/h2&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/longxinH/xhprof&quot;&gt;https://github.com/longxinH/xhprof&lt;/a&gt;&lt;/p&gt;

&lt;h2 id=&quot;xhprof使用例子&quot;&gt;xhprof使用例子&lt;/h2&gt;
&lt;h3 id=&quot;代码&quot;&gt;代码&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;&amp;lt;?php
xhprof_enable(XHPROF_FLAGS_CPU + XHPROF_FLAGS_MEMORY);

for ($i = 0; $i &amp;lt;= 1000; $i++) {
    $a = $i * $i;
}

$xhprof_data = xhprof_disable();

$XHPROF_ROOT = &quot;/tools/xhprof/&quot;;
include_once $XHPROF_ROOT . &quot;/xhprof_lib/utils/xhprof_lib.php&quot;;
include_once $XHPROF_ROOT . &quot;/xhprof_lib/utils/xhprof_runs.php&quot;;

$xhprof_runs = new XHProfRuns_Default();
$run_id = $xhprof_runs-&amp;gt;save_run($xhprof_data, &quot;xhprof_testing&quot;);

echo &quot;http://localhost/xhprof/xhprof_html/index.php?run={$run_id}&amp;amp;source=xhprof_testing\n&quot;;

?&amp;gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h3 id=&quot;输出报告链接&quot;&gt;输出报告链接&lt;/h3&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;http://localhost/xhprof/xhprof_html/index.php?run=t11_4bdf44d21121f&amp;amp;source=xhprof_testing
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;报告表例子&quot;&gt;报告表例子&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/php/xhprof-1.png&quot; /&gt;
&lt;img src=&quot;/assets/images/php/xhprof-2.png&quot; /&gt;&lt;/p&gt;</content><author><name>Zhao Q.H.</name></author><category term="php" /><category term="xhprof" /><summary type="html">XHProf 最初由 Facebook 开源，曾是 PHP 性能分析的标杆工具；如今在社区的持续维护下，已实现对 PHP 8.4 的完整支持，凭借其低开销采样、多维度指标采集（时间、内存、调用栈）和可视化调用图能力，依然是 PHP 开发者在开发调试与生产诊断中进行性能瓶颈定位的高效利器。</summary></entry><entry><title type="html">docker 容器化构建php-laravel开发环境</title><link href="http://localhost:4000/php/2025/11/30/php-larvel/" rel="alternate" type="text/html" title="docker 容器化构建php-laravel开发环境" /><published>2025-11-30T00:00:00+08:00</published><updated>2025-11-30T00:00:00+08:00</updated><id>http://localhost:4000/php/2025/11/30/php-larvel</id><content type="html" xml:base="http://localhost:4000/php/2025/11/30/php-larvel/">&lt;h2 id=&quot;构建php-laravel84151-fpm-xdebug镜像&quot;&gt;构建php-laravel:8.4.15.1-fpm-xdebug镜像&lt;/h2&gt;
&lt;p&gt;使用php8.4.15-fpm镜像作为基础镜像构建8.4.15.1-fpm-xdebug镜像。&lt;/p&gt;
&lt;h2 id=&quot;laravel&quot;&gt;laravel&lt;/h2&gt;
&lt;p&gt;laravel版本是12&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@bcb209344039:/app/app# php artisan -V
Laravel Framework 12.39.0
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;php&quot;&gt;php&lt;/h2&gt;
&lt;p&gt;使用&lt;/p&gt;
&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;root@bcb209344039:/app/app# php --version
PHP 8.4.15 (cli) (built: Nov 20 2025 19:53:54) (NTS)
Copyright (c) The PHP Group
Built by https://github.com/docker-library/php
Zend Engine v4.4.15, Copyright (c) Zend Technologies
    with Zend OPcache v8.4.15, Copyright (c), by Zend Technologies
    with Xdebug v3.4.7, Copyright (c) 2002-2025, by Derick Rethans
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;

&lt;h2 id=&quot;docker-compose&quot;&gt;docker-compose&lt;/h2&gt;

&lt;div class=&quot;highlighter-rouge&quot;&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;pre class=&quot;highlight&quot;&gt;&lt;code&gt;services:
  laravel-svc:
    container_name: laravel-ctr
    build: ./build/
    command: sh -c &quot;cd /app/app &amp;amp;&amp;amp; npm install &amp;amp;&amp;amp; npm run build &amp;amp;&amp;amp;
            composer run dev&quot;
    image: php-laravel:8.4.15.1-fpm-xdebug
    restart: always
    ports:
      - 8000:8000
    volumes:
      - ./app/app:/app/app
      - ./build/etc/docker-php-ext-xdebug.ini:/usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini 
    networks:
      - laravel_network
    environment:
      PWD: /app/app
      PHP_PORT: 8000
      DB_CONNECTION: mysql
      DB_HOST: laravel-db-svc
      DB_PORT: 3306
      DB_DATABASE: laravel_db
      DB_USERNAME: zhaoqhu
      DB_PASSWORD: larH2025,.
    # command: [&quot;php&quot;, &quot;-S&quot;, &quot;0.0.0.0:8000&quot;, &quot;-t&quot;, &quot;/var/www/html&quot;]
  laravel-db-svc:
    container_name: laravel-db-ctr
    image: mysql:8.0
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: larH20025,.
      MYSQL_DATABASE: laravel_db
      MYSQL_USER: zhaoqhu
      MYSQL_PASSWORD: larH2025,.
    ports:
      - 3206:3306
    volumes:
      - ./db:/var/lib/mysql
    networks:
      - laravel_network
volumes:
  html:
  db:
networks:
  laravel_network:
    driver: bridge

&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;
&lt;h2 id=&quot;运行效果&quot;&gt;运行效果&lt;/h2&gt;
&lt;p&gt;&lt;img src=&quot;/assets/images/php/laravel-12.png&quot; /&gt;
&lt;img src=&quot;/assets/images/php/laravel-debug.png&quot; /&gt;&lt;/p&gt;</content><author><name>Zhao Q.H.</name></author><category term="php" /><category term="laravel" /><summary type="html">构建php-laravel:8.4.15.1-fpm-xdebug镜像 使用php8.4.15-fpm镜像作为基础镜像构建8.4.15.1-fpm-xdebug镜像。 laravel laravel版本是12 root@bcb209344039:/app/app# php artisan -V Laravel Framework 12.39.0 php 使用 root@bcb209344039:/app/app# php --version PHP 8.4.15 (cli) (built: Nov 20 2025 19:53:54) (NTS) Copyright (c) The PHP Group Built by https://github.com/docker-library/php Zend Engine v4.4.15, Copyright (c) Zend Technologies with Zend OPcache v8.4.15, Copyright (c), by Zend Technologies with Xdebug v3.4.7, Copyright (c) 2002-2025, by Derick Rethans</summary></entry><entry><title type="html">Hugging face 学习记录</title><link href="http://localhost:4000/2025/10/21/huggingface/" rel="alternate" type="text/html" title="Hugging face 学习记录" /><published>2025-10-21T00:00:00+08:00</published><updated>2025-10-21T00:00:00+08:00</updated><id>http://localhost:4000/2025/10/21/huggingface</id><content type="html" xml:base="http://localhost:4000/2025/10/21/huggingface/">&lt;h1 id=&quot;hugging-face&quot;&gt;Hugging face&lt;/h1&gt;

&lt;ul&gt;
  &lt;li&gt;hugging face入门教程，可以在macbook pro 15款上学习和练习huggging face吗？&lt;/li&gt;
  &lt;li&gt;macbook pro 15款8+256G的有docker环境，第一部分Huggingface的Python环境可以用docker的python环境吗？&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;环境准备&quot;&gt;环境准备&lt;/h2&gt;
&lt;h3 id=&quot;安装python-39&quot;&gt;安装Python 3.9&lt;/h3&gt;
&lt;h3 id=&quot;pip安装pytorch&quot;&gt;Pip安装PyTorch&lt;/h3&gt;
&lt;h3 id=&quot;pip安装hugging-face核心库transformer和datasets&quot;&gt;Pip安装Hugging Face核心库transformer和datasets&lt;/h3&gt;</content><author><name>Zhao Q.H.</name></author><summary type="html">Hugging face</summary></entry><entry><title type="html">mysql面试汇总</title><link href="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/10/11/mysql-ms/" rel="alternate" type="text/html" title="mysql面试汇总" /><published>2025-10-11T00:00:00+08:00</published><updated>2025-10-11T00:00:00+08:00</updated><id>http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/10/11/mysql-ms</id><content type="html" xml:base="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/10/11/mysql-ms/">&lt;h2 id=&quot;mysql&quot;&gt;MySQL&lt;/h2&gt;

&lt;h3 id=&quot;mysql索引用的是什么算法&quot;&gt;Mysql索引用的是什么算法&lt;/h3&gt;

&lt;p&gt;Mysql选用的是B+树，B+树主要是查询效率高，时间复杂度是O(logmN)，内部节点可以拥有多个子节点，通常大于2，这使得B+树比二叉树更宽，更矮时间复杂度是O(log2N)有助于减少树的高度，进而减少磁盘I/O操作。
总结：Mysql中创建索引的目的是为了更快的查询，索引选用B+树的数据结构，这种结构的查找算法的时间复杂度是O(logmN)，查找的效率快，磁盘I/O操作少。&lt;/p&gt;

&lt;h3 id=&quot;mysql事务的关键特性&quot;&gt;MySQL事务的关键特性&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;原子性&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;事务是操作的最小单元，要么全成功，要么全回滚。
原子性是指开启事务后数据库的修改操作要么都成功，要么都失败，回滚到事务之前的状态。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;一致性&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;事务执行前后，数据库从一个合法状态变为另一个合法状态（如转账总金额不变）。&lt;/p&gt;

&lt;p&gt;一致性是指遵守资金守恒原则，例如银行转账操作A账户转出一定的金额给B账户，为了得到一致性这个事务需要确保金额从A减少并在增加。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;隔离性&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;多事务并发时互不干扰，默认隔离级别REPEATABLE READ通过MVCC和间隙锁避免脏读、不可重复读、部分幻读
隔离性，在并发事务T1和T2都需要更新同一个账户的余额，若没有隔离措施，T1和T2可能会使用同样的金额进行计算，从而导致结果错误。&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;持久性&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;mysql事务提交后永久保存，宕机不丢失。&lt;/p&gt;

&lt;h3 id=&quot;mysql中锁&quot;&gt;Mysql中锁&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;锁类型&lt;/th&gt;
      &lt;th&gt;触发方式&lt;/th&gt;
      &lt;th&gt;作用范围&lt;/th&gt;
      &lt;th&gt;兼容性&lt;/th&gt;
      &lt;th&gt;使用场景&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;记录锁（Record Lock）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：&lt;code class=&quot;highlighter-rouge&quot;&gt;UPDATE&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;DELETE&lt;/code&gt; 自动加锁&lt;br /&gt;显式：&lt;code class=&quot;highlighter-rouge&quot;&gt;SELECT ... FOR UPDATE&lt;/code&gt; 精确匹配唯一索引&lt;/td&gt;
      &lt;td&gt;索引中的某一行记录&lt;/td&gt;
      &lt;td&gt;与 X 锁互斥，与 S 锁互斥&lt;/td&gt;
      &lt;td&gt;精确修改/删除单行数据，如库存扣减、账户余额更新&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;间隙锁（Gap Lock）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：&lt;code class=&quot;highlighter-rouge&quot;&gt;UPDATE&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;DELETE&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;SELECT ... FOR UPDATE/FOR SHARE&lt;/code&gt; 在 &lt;strong&gt;REPEATABLE READ&lt;/strong&gt; 下执行范围查询（非唯一索引或范围条件）&lt;/td&gt;
      &lt;td&gt;索引记录之间的间隙（不含记录本身）&lt;/td&gt;
      &lt;td&gt;阻止其他事务在间隙插入新行；S/X 锁均互斥插入&lt;/td&gt;
      &lt;td&gt;防止幻读（写时），如锁定某价格区间不允许新增商品&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;临键锁（Next-Key Lock）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：InnoDB 在 &lt;strong&gt;REPEATABLE READ&lt;/strong&gt; 下默认对范围查询加锁（记录锁+间隙锁）&lt;/td&gt;
      &lt;td&gt;左开右闭区间，如 (10, 20]&lt;/td&gt;
      &lt;td&gt;阻止插入、修改、删除区间内数据&lt;/td&gt;
      &lt;td&gt;RR 级别默认防幻读机制，无需手动控制&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;共享锁（S 锁）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;显式：&lt;code class=&quot;highlighter-rouge&quot;&gt;SELECT ... FOR SHARE&lt;/code&gt;（MySQL 8.0+）&lt;br /&gt;显式：&lt;code class=&quot;highlighter-rouge&quot;&gt;SELECT ... LOCK IN SHARE MODE&lt;/code&gt;（旧语法）&lt;/td&gt;
      &lt;td&gt;加在索引记录上&lt;/td&gt;
      &lt;td&gt;多个 S 锁相容，与 X 锁互斥&lt;/td&gt;
      &lt;td&gt;读多写少场景，允许多事务同时读但阻止修改，如读取配置表、基础字典数据&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;排他锁（X 锁）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;显式：&lt;code class=&quot;highlighter-rouge&quot;&gt;SELECT ... FOR UPDATE&lt;/code&gt;&lt;br /&gt;隐式：&lt;code class=&quot;highlighter-rouge&quot;&gt;UPDATE&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;DELETE&lt;/code&gt;、&lt;code class=&quot;highlighter-rouge&quot;&gt;INSERT&lt;/code&gt; 自动加锁&lt;/td&gt;
      &lt;td&gt;加在索引记录上&lt;/td&gt;
      &lt;td&gt;与任何 S/X 锁互斥&lt;/td&gt;
      &lt;td&gt;写冲突严重场景，需独占数据，如订单状态变更、库存扣减、资金转账&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;意向共享锁（IS 锁）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：InnoDB 自动在加行级 S 锁前于表级加 IS 锁&lt;/td&gt;
      &lt;td&gt;表级&lt;/td&gt;
      &lt;td&gt;与 IX 锁相容，与表级 X 锁互斥&lt;/td&gt;
      &lt;td&gt;内部机制，提高表锁与行锁兼容性检查效率，DBA 一般不直接使用&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;意向排他锁（IX 锁）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：InnoDB 自动在加行级 X 锁前于表级加 IX 锁&lt;/td&gt;
      &lt;td&gt;表级&lt;/td&gt;
      &lt;td&gt;与 IS 锁相容，与表级 X 锁互斥&lt;/td&gt;
      &lt;td&gt;内部机制，同上&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;自增锁（AUTO-INC Lock）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：插入含 &lt;code class=&quot;highlighter-rouge&quot;&gt;AUTO_INCREMENT&lt;/code&gt; 列时自动加&lt;/td&gt;
      &lt;td&gt;表级（语句级或事务级，取决于 &lt;code class=&quot;highlighter-rouge&quot;&gt;innodb_autoinc_lock_mode&lt;/code&gt;）&lt;/td&gt;
      &lt;td&gt;阻塞其他会话的自增 ID 分配&lt;/td&gt;
      &lt;td&gt;保证自增主键唯一性，批量插入时可调模式平衡连续性与并发性能&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;&lt;strong&gt;元数据锁（MDL 锁）&lt;/strong&gt;&lt;/td&gt;
      &lt;td&gt;隐式：任何 DML/DDL 操作自动加&lt;/td&gt;
      &lt;td&gt;表级&lt;/td&gt;
      &lt;td&gt;读锁（SHARED）相容，写锁（EXCLUSIVE）互斥&lt;/td&gt;
      &lt;td&gt;防止 DML 与 DDL 并发修改表结构，需注意长事务会阻塞 DDL&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h3 id=&quot;mysql事务隔离级别&quot;&gt;MySQL事务隔离级别&lt;/h3&gt;

&lt;table&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt;隔离级别&lt;/th&gt;
      &lt;th&gt;脏读&lt;/th&gt;
      &lt;th&gt;不可重复读&lt;/th&gt;
      &lt;th&gt;幻读&lt;/th&gt;
      &lt;th&gt;MySQL 默认&lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt;READ UNCOMMITTED&lt;/td&gt;
      &lt;td&gt;❌ 可能&lt;/td&gt;
      &lt;td&gt;❌ 可能&lt;/td&gt;
      &lt;td&gt;❌ 可能&lt;/td&gt;
      &lt;td&gt;否&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;READ COMMITTED&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;❌ 可能&lt;/td&gt;
      &lt;td&gt;❌ 可能&lt;/td&gt;
      &lt;td&gt;否&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;REPEATABLE READ&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;⚠️ 可能（但 InnoDB 通过 MVCC + 间隙锁避免）&lt;/td&gt;
      &lt;td&gt;✅ 是&lt;/td&gt;
    &lt;/tr&gt;
    &lt;tr&gt;
      &lt;td&gt;SERIALIZABLE&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;✅ 避免&lt;/td&gt;
      &lt;td&gt;否&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;ul&gt;
  &lt;li&gt;读未提交（READ UNCOMMITTED）
  A事务可以读取B事务未调教的数据，引发脏读。&lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;读已提交（READ COMMITTED）&lt;/p&gt;

    &lt;p&gt;A事务可以读取B事务已提交的数据&lt;/p&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;font color=&quot;red&quot;&gt;可重复读（REPEATABLE READ）&lt;/font&gt;
    &lt;p&gt;默认的事务隔离级别，事务开启时，不在允许修改操作，可避免脏读，也可以通过在查询时加排它锁避免幻读。&lt;/p&gt;
    &lt;ol&gt;
      &lt;li&gt;读幻读​ → 靠 RR 隔离级别 + 普通 SELECT（MVCC 自动处理）。&lt;/li&gt;
      &lt;li&gt;写幻读​ → 用 SELECT … FOR UPDATE触发 Next-Key Lock（PHP 中就是执行这条 SQL 并开启事务）。&lt;/li&gt;
      &lt;li&gt;两者结合，即可在业务代码中可靠防止幻读。&lt;/li&gt;
    &lt;/ol&gt;
  &lt;/li&gt;
  &lt;li&gt;
    &lt;p&gt;串行（SERIALIZABLE）&lt;/p&gt;

    &lt;p&gt;串行是最高的隔离级别，可以避免脏读、幻读、可重复读，但是性能太差。&lt;/p&gt;
  &lt;/li&gt;
&lt;/ul&gt;

&lt;h3 id=&quot;mysql存储引擎&quot;&gt;MySQL存储引擎&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;InnoDB&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;InnoDB是默认的存储引擎，支持事务、行锁，支持多版本并发控制。&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;MyIsAm&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;MyIsAm在5.5版本之前是默认的选项，不支持事务、行锁，支持表锁。适合读密集应用，数据压缩能力强，适合只读数据存储。&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Memory&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;将所有数据保存在内存中，数据易丢失。&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Archive&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;设计用于存储大量的归档数据，具有高压缩率。只支持Insert和Select操作，非常适合存储日志数据或其他很少需要修改的数据。&lt;/p&gt;

&lt;h3 id=&quot;mysql高可用方案&quot;&gt;MySQL高可用方案&lt;/h3&gt;

&lt;ul&gt;
  &lt;li&gt;主从复制&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;适合读密集型应用&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;InnoDB Cluster&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;适合大规模并发写入应用。&lt;/p&gt;

&lt;h3 id=&quot;mysql中utf8和utf8mb4的区别&quot;&gt;MySQL中utf8和utf8mb4的区别&lt;/h3&gt;

&lt;p&gt;mysql在5.5.3之后增加了utf8mb4的编码，mb4就是most bytes4，utf8编码最大字符长度为3字节，如果遇到4字节的宽字符就会插入异常。utf8mb4就是most bytes4的意思，专门用来兼容4字节的unicode字符。&lt;/p&gt;

&lt;h3 id=&quot;mysql中乐观锁和悲观锁的区别&quot;&gt;MySQL中乐观锁和悲观锁的区别？&lt;/h3&gt;

&lt;p&gt;传统的关系型数据库里边就用到了很多这种锁机制，比如行锁、表锁等，读锁、写锁等。都是在做操作之前先上锁。
乐观锁和悲观锁主要是为了解决并发事务中的数据一致性问题，他们的设计初衷是为了在多用户或进程同时访问和修改相同数据时，保证数据的一致性和完整性。举例：在秒杀场景下对库存的查询加锁，在这个事务结束前，其他并发事务需要阻塞排队等待。&lt;/p&gt;

&lt;h3 id=&quot;mysql索引主要是哪些&quot;&gt;MySQL索引主要是哪些？&lt;/h3&gt;

&lt;p&gt;索引的目的是提高查询效率，索引的类型有唯一索引、普通索引、主键索引、组合索引。唯一索引不可以出现相同的值，可以有Null值。&lt;/p&gt;

&lt;p&gt;索引使用技巧，1.使用短索引，如果有一个char(255)列，可以在前10个或20个字符内做短索引。2.使用like语句%aaa%，不会使用索引，而 “aaa%”可以使用索引。3.where和join的列键索引。&lt;/p&gt;

&lt;h3 id=&quot;组合索引最左匹配原则&quot;&gt;组合索引最左匹配原则？&lt;/h3&gt;

&lt;p&gt;在查询数据时，从联合索引的最左边开始匹配。MySQL会一直向右匹配直到遇到范围查询(&amp;gt;、&amp;lt;、betwwen、like就停止匹配了)，比如索引列(abcd) where a=1 and c=2 and b&amp;gt;5 and d=6，这样c和d都不会用到索引。&lt;/p&gt;

&lt;h3 id=&quot;聚簇索引和非聚簇索引的区别&quot;&gt;聚簇索引和非聚簇索引的区别？&lt;/h3&gt;

&lt;p&gt;MyIsAM存储引擎是非聚簇索引，InnnoDB是聚簇索引。聚簇索引中主键索引存放数据，二级索引存储索引列和主键列。非聚簇索引主键索引和二级索引都存放完整的数据。聚簇索引会额外占用空间，但查询效率高。&lt;/p&gt;

&lt;h3 id=&quot;如何查询一个字段是否命中了索引&quot;&gt;如何查询一个字段是否命中了索引？&lt;/h3&gt;

&lt;p&gt;使用explain分析SQL是否走了索引。&lt;/p&gt;

&lt;h3 id=&quot;mysql中的mvcc是什么&quot;&gt;Mysql中的MVCC是什么？&lt;/h3&gt;

&lt;p&gt;多版本并发控制Multiversion concurrency control，多版本并发控制常用的是所，给当前事务DQL加毒素哦，给DML加写锁，这种锁是一种悲观锁的实现方式，会阻塞其他事务，从而影响数据库性能。&lt;/p&gt;

&lt;h3 id=&quot;mysql读写分离以及主从同步&quot;&gt;MySQL读写分离以及主从同步。&lt;/h3&gt;

&lt;p&gt;原理，主库将变更写binlog日志，然后从库链接到主库后，从库有一个IO线程将主库的binlog日志拷贝到自己本地，写入一个中继日志，接着从库有一个sql线程从中继日志读取binlog然后执行binlog日志的内容。&lt;/p&gt;

&lt;h3 id=&quot;mysql如何保证一致性和持久性&quot;&gt;Mysql如何保证一致性和持久性？&lt;/h3&gt;

&lt;p&gt;Mysql为了保证ACID中的一致性和持久性，使用了WAL(Write A head logging)，先写日志在写磁盘。Redolog就是一张WAL的应用，当数据库忽然断点在重新启动时，Mysql可以通过Redolog还原数据。&lt;/p&gt;

&lt;h3 id=&quot;为什么选b树作为索引结构&quot;&gt;为什么选B+树作为索引结构？&lt;/h3&gt;
&lt;p&gt;1.非叶子节点仅存索引（键值和指针），支持高效范围查询。2.叶子节点存数据并链表连接天然支持水平扩展理论存储容量仅受磁盘总空间限制。3.B+树的节点（非叶子和叶子）大小设计为磁盘页（16KB）大小，让B+树查询时用最少的I/O定位数据。&lt;/p&gt;

&lt;h3 id=&quot;innnodb的行锁模式&quot;&gt;InnnoDB的行锁模式？&lt;/h3&gt;

&lt;p&gt;1.共享锁(s)，用法lock in share mode又称读锁，2. 排它锁，又称写锁。
s锁，若事务T对数据对象A加上S锁，其他事务智能对A加S锁，而不能加X锁。
x锁，若事务T对数据对象加上X锁，事务T可以读A也可以写A，其他事务不能在对A加任何锁，X锁用法for update。&lt;/p&gt;

&lt;h3 id=&quot;哈希hash比树tree更快索引结构为什么设计成树形&quot;&gt;哈希(hash)比树(tree)更快，索引结构为什么设计成树形&lt;/h3&gt;

&lt;p&gt;哈希查询、插入、修改、删除的平均响应时间复杂度都是O(1)，树的平均响应时间复杂度是O(logmN)，哈希只能满足等值查询，不能满足范围和大小查询，其次不可以排序。&lt;/p&gt;

&lt;h3 id=&quot;为什么索引的key长度不能太长&quot;&gt;为什么索引的key长度不能太长。&lt;/h3&gt;

&lt;p&gt;key太长会导致一个页当中能够村昂的key数目变小，间接导致索引树的页数变多，索引层次增加。从而影响查询效率。&lt;/p&gt;

&lt;h3 id=&quot;mysql的数据如何恢复到任意时间点&quot;&gt;MySQL的数据如何恢复到任意时间点&lt;/h3&gt;

&lt;p&gt;1.启用二进制日志。2.首先使用最近一次的备份恢复数据库。3.使用mysqlbinlog工具将binlog文件合并，然后使用mysql工具导入已合并的sql文件。&lt;/p&gt;

&lt;h3 id=&quot;mysql为什么加了索引可以加快查询&quot;&gt;Mysql为什么加了索引可以加快查询&lt;/h3&gt;

&lt;p&gt;使用索引后再查询时不用扫描全表来定位。&lt;/p&gt;

&lt;h3 id=&quot;explain命令有什么用&quot;&gt;Explain命令有什么用&lt;/h3&gt;

&lt;p&gt;分析慢查询语句有没有命中索引。&lt;/p&gt;</content><author><name>Zhao Q.H.</name></author><category term="面试" /><category term="mysql" /><summary type="html">MySQL</summary></entry></feed>