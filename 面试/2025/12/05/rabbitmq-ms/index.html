
<!doctype html>














<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/assets/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  

  

  

  

  

  
    
    
    <!--<link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">-->
  






<link href="/assets/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/assets/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="rabbitmq," />





  <link rel="alternate" href="/atom.xml" title="Zhao Q.H.'s Notes" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/assets/favicon.png?v=5.1.1" />
















<meta name="description" content="æ¶ˆæ¯é˜Ÿåˆ— ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¾€äº¤æ¢æœºï¼Œäº¤æ¢æœºä¾æ®è·¯ç”±è§„åˆ™å’Œç»‘å®šå…³ç³»å°†æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼›é˜Ÿåˆ—æŒä¹…åŒ–å­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆåå‘é€ ACKï¼ŒRabbitMQ ç¡®è®¤ååˆ é™¤æ¶ˆæ¯ â€”â€” å½¢æˆä¸€æ¡å®Œæ•´ã€å¯é ã€å¯æ§çš„æ¶ˆæ¯æµè½¬é“¾è·¯ã€‚">
<meta name="keywords" content="rabbitmq">
<meta property="og:type" content="article">
<meta property="og:title" content="Rabbitmqé¢è¯•æ±‡æ€»">
<meta property="og:url" content="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms/">
<meta property="og:site_name" content="Zhao Q.H.'s Notes">
<meta property="og:description" content="æ¶ˆæ¯é˜Ÿåˆ— ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¾€äº¤æ¢æœºï¼Œäº¤æ¢æœºä¾æ®è·¯ç”±è§„åˆ™å’Œç»‘å®šå…³ç³»å°†æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼›é˜Ÿåˆ—æŒä¹…åŒ–å­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆåå‘é€ ACKï¼ŒRabbitMQ ç¡®è®¤ååˆ é™¤æ¶ˆæ¯ â€”â€” å½¢æˆä¸€æ¡å®Œæ•´ã€å¯é ã€å¯æ§çš„æ¶ˆæ¯æµè½¬é“¾è·¯ã€‚">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Rabbitmqé¢è¯•æ±‡æ€»">
<meta name="twitter:description" content="æ¶ˆæ¯é˜Ÿåˆ— ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¾€äº¤æ¢æœºï¼Œäº¤æ¢æœºä¾æ®è·¯ç”±è§„åˆ™å’Œç»‘å®šå…³ç³»å°†æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼›é˜Ÿåˆ—æŒä¹…åŒ–å­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆåå‘é€ ACKï¼ŒRabbitMQ ç¡®è®¤ååˆ é™¤æ¶ˆæ¯ â€”â€” å½¢æˆä¸€æ¡å®Œæ•´ã€å¯é ã€å¯æ§çš„æ¶ˆæ¯æµè½¬é“¾è·¯ã€‚">


<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Pisces',
    sidebar: {"position":"right","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'åšä¸»'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://localhost:4000/"/>





  <title>Rabbitmqé¢è¯•æ±‡æ€» | Zhao Q.H.'s Notes</title>
  
















</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  

  <div class="container sidebar-position-right page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Zhao Q.H.'s Notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            åˆ†ç±»
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      
        
        
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            æ ‡ç­¾
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            æœç´¢
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="æœç´¢..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

<div id="posts" class="posts-expand">
  
  

  

  
  
  

  <article class="post post-type- " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://localhost:4000/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zhao Q.H.">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="assets/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Zhao Q.H.'s Notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
          
          
            Rabbitmqé¢è¯•æ±‡æ€»
          
        </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              
              <time title="åˆ›å»ºäº" itemprop="dateCreated datePublished" datetime="2025-12-05T00:00:00+08:00">
                2025-12-05
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">æ›´æ–°äº</span>
              
              <time title="æ›´æ–°äº" itemprop="dateModified" datetime="">
                
              </time>
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/category/#/%E9%9D%A2%E8%AF%95" itemprop="url" rel="index">
                    <span itemprop="name">é¢è¯•</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          
            
                <div class="post-description">
                    
                </div>
            
          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
  
  












  <h2 id="æ¶ˆæ¯é˜Ÿåˆ—">æ¶ˆæ¯é˜Ÿåˆ—</h2>
<p>ç”Ÿäº§è€…å°†æ¶ˆæ¯å‘å¾€äº¤æ¢æœºï¼Œäº¤æ¢æœºä¾æ®è·¯ç”±è§„åˆ™å’Œç»‘å®šå…³ç³»å°†æ¶ˆæ¯æŠ•é€’åˆ°æŒ‡å®šé˜Ÿåˆ—ï¼›é˜Ÿåˆ—æŒä¹…åŒ–å­˜å‚¨æ¶ˆæ¯ï¼Œæ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ—è·å–æ¶ˆæ¯ï¼Œå¤„ç†å®Œæˆåå‘é€ ACKï¼ŒRabbitMQ ç¡®è®¤ååˆ é™¤æ¶ˆæ¯ â€”â€” å½¢æˆä¸€æ¡å®Œæ•´ã€å¯é ã€å¯æ§çš„æ¶ˆæ¯æµè½¬é“¾è·¯ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10</pre></td><td class="code"><pre class="highlight"><code>+----------------+      è·¯ç”±       +-------------+      å­˜å‚¨      +-------------+
| ç”Ÿäº§è€…å‘é€æ¶ˆæ¯ | -------------&gt; | äº¤æ¢æœºè·¯ç”±  | -------------&gt; | é˜Ÿåˆ—å­˜å‚¨æ¶ˆæ¯ |
+----------------+               +-------------+               +-------------+
                                       â†‘
                                       ç»‘å®šå…³ç³»ï¼ˆExchange-Queueï¼‰
                                       â†“
+----------------+      è®¢é˜…/ACK      +-------------+
| æ¶ˆè´¹è€…ç›‘å¬é˜Ÿåˆ— | &lt;------------------ | æ¶ˆæ¯å¤„ç†å®Œæˆ |
+----------------+                   +-------------+

</code></pre></td></tr></tbody></table></div></div>

<h2 id="ç”Ÿäº§è€…">ç”Ÿäº§è€…</h2>

<h3 id="-å¦‚ä½•ç¡®ä¿å‡ ä¹-100ä¸ä¸¢-5-å±‚é˜²æŠ¤è¯¦è§£">âœ… å¦‚ä½•ç¡®ä¿â€œå‡ ä¹ 100%â€ä¸ä¸¢ï¼Ÿâ€”â€” 5 å±‚é˜²æŠ¤è¯¦è§£</h3>

<table>
  <thead>
    <tr>
      <th>å±‚çº§</th>
      <th>æœºåˆ¶</th>
      <th>è§£å†³çš„é—®é¢˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1ï¸âƒ£ å¹‚ç­‰æ§åˆ¶</td>
      <td>Redis <code class="highlighter-rouge">SET NX</code></td>
      <td>é˜²æ­¢å¹¶å‘å‹æµ‹å¯¼è‡´é‡å¤å‘é€</td>
    </tr>
    <tr>
      <td>2ï¸âƒ£ æŒä¹…åŒ–</td>
      <td><code class="highlighter-rouge">delivery_mode=2</code> + <code class="highlighter-rouge">durable=true</code></td>
      <td>é˜²æ­¢ Broker é‡å¯ä¸¢æ¶ˆæ¯</td>
    </tr>
    <tr>
      <td>3ï¸âƒ£ Publisher Confirms</td>
      <td><code class="highlighter-rouge">ack</code>/<code class="highlighter-rouge">nack</code></td>
      <td>ç¡®è®¤æ¶ˆæ¯è¢« Broker æ¥æ”¶å¹¶æŒä¹…åŒ–</td>
    </tr>
    <tr>
      <td>4ï¸âƒ£ Mandatory + Return</td>
      <td>è·¯ç”±å¤±è´¥è¿”å›</td>
      <td>é˜²æ­¢æ¶ˆæ¯å› è·¯ç”±é”™è¯¯è¢«é™é»˜ä¸¢å¼ƒ</td>
    </tr>
    <tr>
      <td>5ï¸âƒ£ å¤±è´¥å›æ»š</td>
      <td>åˆ é™¤ Redis æ ‡è®°</td>
      <td>å…è®¸é‡è¯•ï¼Œé¿å…æ°¸ä¹…é˜»å¡</td>
    </tr>
  </tbody>
</table>

<h3 id="ç”Ÿäº§ç¯å¢ƒä¸­ç”Ÿäº§è€…çš„æ ‡å‡†ç­”æ¡ˆ">ç”Ÿäº§ç¯å¢ƒä¸­ç”Ÿäº§è€…çš„æ ‡å‡†ç­”æ¡ˆ</h3>
<p>æ²¡æœ‰ä¸€ä¸ª basic_publish()èƒ½ä¿è¯æ¶ˆæ¯å…¥é˜Ÿï¼Œä½†â€œæŒä¹…åŒ– + confirms + mandatory + return + å¹‚ç­‰ + é‡è¯•â€çš„ç»„åˆæ‹³ï¼Œå¯ä»¥è®©æ¶ˆæ¯ä¸¢å¤±æ¦‚ç‡ä½äº 0.001%ï¼Œè¾¾åˆ°å·¥ä¸šçº§å¯é æ€§</p>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45<br/>46<br/>47<br/>48<br/>49<br/>50<br/>51<br/>52<br/>53<br/>54<br/>55<br/>56<br/>57<br/>58<br/>59<br/>60<br/>61<br/>62<br/>63<br/>64<br/>65<br/>66<br/>67<br/>68<br/>69<br/>70<br/>71<br/>72<br/>73<br/>74<br/>75<br/>76<br/>77<br/>78<br/>79<br/>80<br/>81<br/>82<br/>83<br/>84<br/>85<br/>86<br/>87<br/>88<br/>89<br/>90<br/>91<br/>92<br/>93<br/>94<br/>95<br/>96<br/>97<br/>98<br/>99<br/>100<br/>101<br/>102<br/>103<br/>104<br/>105<br/>106<br/>107<br/>108<br/>109<br/>110<br/>111<br/>112<br/>113<br/>114<br/>115<br/>116<br/>117<br/>118<br/>119<br/>120<br/>121<br/>122<br/>123<br/>124<br/>125<br/>126<br/>127<br/>128<br/>129<br/>130<br/>131<br/>132<br/>133<br/>134<br/>135<br/>136</pre></td><td class="code"><pre class="highlight"><code>&lt;?php
require_once __DIR__ . '/vendor/autoload.php';

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;
use PhpAmqpLib\Exception\AMQPTimeoutException;

class ReliableRabbitMQProducer
{
    private $connection;
    private $redis; // ç”¨äºå¹‚ç­‰æ§åˆ¶

    public function __construct()
    {
        // 1. å»ºç«‹ RabbitMQ è¿æ¥ï¼ˆè¿›ç¨‹å†…å¤ç”¨ï¼‰
        $this-&gt;connection = new AMQPStreamConnection(
            'rabbitmq', 5672, 'guest', 'guest',
            '/', false, 'plain', null, 'en_US',
            3.0, 3.0, null, false, 60
        );

        // 2. åˆå§‹åŒ– Redisï¼ˆç”¨äºå¹‚ç­‰ï¼‰
        $this-&gt;redis = new Redis();
        $this-&gt;redis-&gt;connect('redis', 6379);
    }

    /**
     * å¯é å‘é€æ¶ˆæ¯ï¼ˆå¤šå±‚é˜²æŠ¤ï¼‰
     * @param string $orderId ä¸šåŠ¡å”¯ä¸€ID
     * @param array $orderData è®¢å•æ•°æ®
     * @return bool æ˜¯å¦æˆåŠŸ
     */
    public function sendOrderCreated(string $orderId, array $orderData): bool
    {
        $lockKey = "sent:order:{$orderId}";

        // === ç¬¬1å±‚ï¼šå¹‚ç­‰æ§åˆ¶ï¼ˆé˜²å¹¶å‘å‹æµ‹ï¼‰===
        $isFirstSend = $this-&gt;redis-&gt;set($lockKey, 1, ['nx', 'ex' =&gt; 86400]);
        if (!$isFirstSend) {
            error_log("Duplicate request ignored: {$orderId}");
            return true; // å¹‚ç­‰è¿”å›æˆåŠŸ
        }

        $channel = null;
        try {
            $channel = $this-&gt;connection-&gt;channel();

            // === ç¬¬2å±‚ï¼šå£°æ˜èµ„æºï¼ˆå¹‚ç­‰æ“ä½œï¼‰===
            $exchange = 'orders';
            $queue = 'order.created';
            $routingKey = 'order.created';

            $channel-&gt;exchange_declare($exchange, 'direct', false, true, false);
            $channel-&gt;queue_declare($queue, false, true, false, false);
            $channel-&gt;queue_bind($queue, $exchange, $routingKey);

            // === ç¬¬3å±‚ï¼šæ„é€ æŒä¹…åŒ–æ¶ˆæ¯ + mandatory ===
            $messageId = 'order:' . $orderId . ':' . str_replace('.', '', microtime(true));
            $msg = new AMQPMessage(
                json_encode([
                    'message_id' =&gt; $messageId,
                    'order_id'   =&gt; $orderId,
                    'data'       =&gt; $orderData,
                    'timestamp'  =&gt; time()
                ]),
                [
                    'delivery_mode' =&gt; AMQPMessage::DELIVERY_MODE_PERSISTENT, // æŒä¹…åŒ–
                    'content_type'  =&gt; 'application/json',
                    'message_id'    =&gt; $messageId,
                    'mandatory'     =&gt; true  // å…³é”®ï¼šè·¯ç”±å¤±è´¥è¿”å›ç»™ç”Ÿäº§è€…
                ]
            );

            // === ç¬¬4å±‚ï¼šå¼€å¯ Publisher Confirms ===
            $channel-&gt;confirm_select();

            $acked = false;
            $nacked = false;
            $returned = false;

            // è®¾ç½® ack/nack å›è°ƒ
            $channel-&gt;set_ack_handler(function (AMQPMessage $message) use (&amp;$acked, $messageId) {
                if ($message-&gt;get('message_id') === $messageId) {
                    $acked = true;
                    error_log("âœ… [CONFIRMED] Message acked: {$messageId}");
                }
            });

            $channel-&gt;set_nack_handler(function (AMQPMessage $message) use (&amp;$nacked, $messageId) {
                if ($message-&gt;get('message_id') === $messageId) {
                    $nacked = true;
                    error_log("âŒ [FAILED] Message nacked: {$messageId}");
                }
            });

            // è®¾ç½® return å›è°ƒï¼ˆè·¯ç”±å¤±è´¥ï¼‰
            $channel-&gt;set_return_listener(function ($replyCode, $replyText, $exchange, $routingKey, AMQPMessage $message) use (&amp;$returned, $messageId) {
                $returned = true;
                error_log("ğŸš¨ [RETURNED] Message returned: {$replyCode} {$replyText}, msg: {$messageId}");
                // å¯è®°å½•åˆ°æ•°æ®åº“ï¼Œäººå·¥å¤„ç†
            });

            // === ç¬¬5å±‚ï¼šå‘é€æ¶ˆæ¯ ===
            $channel-&gt;basic_publish($msg, $exchange, $routingKey);

            // === ç¬¬6å±‚ï¼šç­‰å¾… Broker ç¡®è®¤ï¼ˆåŒæ­¥é˜»å¡ï¼Œæœ€å¤š5ç§’ï¼‰===
            $channel-&gt;wait_for_pending_acks_returns(5.0);

            // === ç¬¬7å±‚ï¼šåˆ¤æ–­ç»“æœ ===
            if ($nacked) {
                throw new Exception("Broker nack'd the message (e.g., queue full)");
            }
            if ($returned) {
                throw new Exception("Message was returned (routing failed)");
            }
            if (!$acked) {
                throw new Exception("No ack received (network issue or broker down)");
            }

            // âœ… æˆåŠŸï¼šæ¶ˆæ¯å·²å…¥é˜Ÿå¹¶æŒä¹…åŒ–
            error_log("ğŸ‰ Message successfully persisted to queue: {$messageId}");
            return true;

        } catch (Exception $e) {
            // === ç¬¬8å±‚ï¼šå¤±è´¥å›æ»šå¹‚ç­‰æ ‡è®°ï¼ˆå…è®¸é‡è¯•ï¼‰===
            $this-&gt;redis-&gt;del($lockKey);
            error_log("âŒ Send failed: {$e-&gt;getMessage()} | Order: {$orderId}");
            return false;
        } finally {
            // æ¸…ç†èµ„æº
            if ($channel &amp;&amp; $channel-&gt;is_open()) {
                $channel-&gt;close();
            }
        }
    }
}
</code></pre></td></tr></tbody></table></div></div>
<h3 id="è°ƒç”¨ç¤ºä¾‹">è°ƒç”¨ç¤ºä¾‹</h3>
<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8</pre></td><td class="code"><pre class="highlight"><code>$producer = new ReliableRabbitMQProducer();
$success = $producer-&gt;sendOrderCreated('123456', ['amount' =&gt; 99.9, 'user_id' =&gt; 789]);

if ($success) {
    echo "æ¶ˆæ¯å·²å¯é æŠ•é€’\n";
} else {
    echo "æŠ•é€’å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–å‘Šè­¦\n";
}
</code></pre></td></tr></tbody></table></div></div>
<h3 id="æ¶ˆæ¯æŒä¹…åŒ–">æ¶ˆæ¯æŒä¹…åŒ–</h3>

<h3 id="å¹‚ç­‰å¤„ç†">å¹‚ç­‰å¤„ç†</h3>
<ul>
  <li>æµç¨‹å›¾
    <div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17</pre></td><td class="code"><pre class="highlight"><code>+----------------+     +------------------+     +------------------+
|   HTTP Client  | --&gt; |   PHP-FPM        | --&gt; |   RabbitMQ       |
| (å¹¶å‘å‹æµ‹)     |     | (ç”Ÿäº§è€…é€»è¾‘)      |     | (æ¶ˆæ¯é˜Ÿåˆ—)       |
+----------------+     +------------------+     +------------------+
                           |
                           | 1. æå– order_id
                           v
                     +------------------+
                     |   Redis: SET NX  |
                     | sent:order:X     |
                     | NX EX 3600       |
                     +------------------+
                           |
                  true â†’ å‘é€æ¶ˆæ¯
                          â†³ success â†’ å®Œæˆ âœ…
                          â†³ failure â†’ DEL æ ‡è®° â†’ è¿”å›é”™è¯¯ âš ï¸
                  false â†’ è¿”å›æˆåŠŸï¼ˆå¹‚ç­‰ï¼‰âœ…
</code></pre></td></tr></tbody></table></div>    </div>
  </li>
  <li>ä»£ç 
    <div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23</pre></td><td class="code"><pre class="highlight"><code>public function sendOrderCreated(string $orderId, array $data): bool
{
  $lockKey = "sent:order:{$orderId}";
  $tempKey = "temp:order:{$orderId}"; // å¯é€‰ï¼šç”¨ä¸´æ—¶æ ‡è®°

  // æ–¹æ¡ˆ Aï¼šç›´æ¥ SET NXï¼ˆç®€å•ï¼‰
  $isFirst = $this-&gt;redis-&gt;set($lockKey, 1, ['nx', 'ex' =&gt; 3600]);

  if (!$isFirst) {
      return true; // å¹‚ç­‰
  }

  // å‘é€æ¶ˆæ¯
  try {
      $this-&gt;doPublish($orderId, $data);
      return true; // æˆåŠŸ
  } catch (Exception $e) {
      // å…³é”®ï¼šå‘é€å¤±è´¥ï¼Œæ¸…é™¤æ ‡è®°ï¼
      $this-&gt;redis-&gt;del($lockKey);
      error_log("Publish failed, rollback mark: {$orderId}");
      return false;
  }
}
</code></pre></td></tr></tbody></table></div>    </div>
    <h2 id="ï¸-rabbitmq-æ¶ˆè´¹è€…é˜²é‡å¤æ¶ˆè´¹ä¸å¹‚ç­‰å¤„ç†å®Œæ•´æ–¹æ¡ˆ">ğŸ›¡ï¸ RabbitMQ æ¶ˆè´¹è€…é˜²é‡å¤æ¶ˆè´¹ä¸å¹‚ç­‰å¤„ç†å®Œæ•´æ–¹æ¡ˆ</h2>
  </li>
</ul>

<blockquote>
  <p><strong>æ ¸å¿ƒæ€æƒ³</strong>ï¼šRabbitMQ åªä¿è¯â€œè‡³å°‘ä¸€æ¬¡â€æˆ–â€œè‡³å¤šä¸€æ¬¡â€äº¤ä»˜ï¼Œ<strong>ä¸ä¿è¯â€œæ°å¥½ä¸€æ¬¡â€</strong>ã€‚å› æ­¤ï¼Œæ¶ˆè´¹è€…å¿…é¡»å…·å¤‡<strong>è¯†åˆ«é‡å¤æ¶ˆæ¯ã€å®‰å…¨å¿½ç•¥é‡å¤ã€ä¿è¯ä¸šåŠ¡å¹‚ç­‰</strong>çš„èƒ½åŠ›ï¼Œå¦åˆ™å°†å¯¼è‡´èµ„æŸã€æ•°æ®é”™ä¹±ç­‰ä¸¥é‡é—®é¢˜ã€‚</p>
</blockquote>

<hr />

<h3 id="ä¸€ä¸ºä»€ä¹ˆå¿…é¡»å¤„ç†é‡å¤æ¶ˆè´¹">ä¸€ã€ä¸ºä»€ä¹ˆå¿…é¡»å¤„ç†é‡å¤æ¶ˆè´¹ï¼Ÿ</h3>

<table>
  <thead>
    <tr>
      <th>åŸå› </th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ğŸ” ç½‘ç»œæŠ–åŠ¨æˆ–å¤„ç†è¶…æ—¶</td>
      <td>RabbitMQ æœªæ”¶åˆ° ACKï¼Œé‡æŠ•æ¶ˆæ¯</td>
    </tr>
    <tr>
      <td>ğŸ’¥ æ¶ˆè´¹è€…å´©æºƒ</td>
      <td>ä¸šåŠ¡å·²æ‰§è¡Œä½†æœª ACKï¼Œé‡å¯åæ¶ˆæ¯é‡å‘</td>
    </tr>
    <tr>
      <td>ğŸ§± æ‰‹åŠ¨ ACK é—æ¼</td>
      <td>ä»£ç  Bug å¯¼è‡´å¿˜è®° <code class="highlighter-rouge">basic_ack()</code></td>
    </tr>
    <tr>
      <td>ğŸ”„ é›†ç¾¤ HA åˆ‡æ¢</td>
      <td>é•œåƒé˜Ÿåˆ—ä¸»ä»åˆ‡æ¢å¯èƒ½è§¦å‘é‡å‘</td>
    </tr>
    <tr>
      <td>ğŸ“¤ ç”Ÿäº§è€…é‡è¯•</td>
      <td>ç½‘ç»œé—®é¢˜å¯¼è‡´åŒä¸€æ¡æ¶ˆæ¯è¢«å‘å¤šæ¬¡</td>
    </tr>
  </tbody>
</table>

<p>ğŸ‘‰ <strong>ç»“è®ºï¼šé‡å¤æ¶ˆè´¹æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¸¸æ€ï¼Œå¿…é¡»è®¾è®¡å¹‚ç­‰æœºåˆ¶åº”å¯¹ã€‚</strong></p>

<hr />

<h3 id="äºŒå¹‚ç­‰æ€§æ¶ˆè´¹è€…çš„ç”Ÿå‘½çº¿">äºŒã€å¹‚ç­‰æ€§ï¼šæ¶ˆè´¹è€…çš„ç”Ÿå‘½çº¿</h3>

<blockquote>
  <p><strong>å®šä¹‰</strong>ï¼šæ— è®ºåŒä¸€æ¡æ¶ˆæ¯è¢«æ¶ˆè´¹å¤šå°‘æ¬¡ï¼Œç³»ç»Ÿçš„ä¸šåŠ¡çŠ¶æ€å’Œæœ€ç»ˆç»“æœéƒ½ä¸åªæ¶ˆè´¹ä¸€æ¬¡ç›¸åŒã€‚</p>
</blockquote>

<h4 id="-å¹‚ç­‰ä¸æ˜¯å¯é€‰é¡¹è€Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…é€‰é¡¹">âœ… å¹‚ç­‰ä¸æ˜¯â€œå¯é€‰é¡¹â€ï¼Œè€Œæ˜¯<strong>ç”Ÿäº§ç¯å¢ƒçš„å¿…é€‰é¡¹</strong>ã€‚</h4>

<hr />

<h3 id="ä¸‰äº”å¤§å¹‚ç­‰ç­–ç•¥æŒ‰æ¨èåº¦æ’åº">ä¸‰ã€äº”å¤§å¹‚ç­‰ç­–ç•¥ï¼ˆæŒ‰æ¨èåº¦æ’åºï¼‰</h3>

<table>
  <thead>
    <tr>
      <th>æ–¹æ¡ˆ</th>
      <th>åŸç†</th>
      <th>é€‚ç”¨åœºæ™¯</th>
      <th>ä¼˜ç‚¹</th>
      <th>ç¼ºç‚¹</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1ï¸âƒ£ <strong>åŸºäº <code class="highlighter-rouge">message_id</code> + Redis/NX</strong></td>
      <td>æ¶ˆè´¹å‰ç”¨ <code class="highlighter-rouge">SET message_id NX EX</code> åˆ¤æ–­æ˜¯å¦å·²å¤„ç†</td>
      <td>é€šç”¨åœºæ™¯ï¼Œå°¤å…¶å¼‚æ­¥æ¶ˆæ¯</td>
      <td>âœ… ç®€å•é«˜æ•ˆ<br />âœ… åˆ†å¸ƒå¼å‹å¥½<br />âœ… å¯è®¾ç½®è¿‡æœŸ</td>
      <td>âŒ ä¾èµ– Redis å¯ç”¨æ€§</td>
    </tr>
    <tr>
      <td>2ï¸âƒ£ <strong>åŸºäºä¸šåŠ¡ä¸»é”®ï¼ˆå¦‚ order_idï¼‰</strong></td>
      <td>ç”¨ä¸šåŠ¡å”¯ä¸€ ID åˆ¤æ–­æ˜¯å¦å·²å¤„ç†</td>
      <td>æœ‰æ˜ç¡®ä¸šåŠ¡æ ‡è¯†çš„åœºæ™¯</td>
      <td>âœ… æ— éœ€å…¨å±€ ID<br />âœ… è´´è¿‘ä¸šåŠ¡é€»è¾‘</td>
      <td>âŒ åŒä¸€ä¸šåŠ¡å¯èƒ½å¤šæ¬¡åˆæ³•æ›´æ–°ï¼ˆå¦‚çŠ¶æ€å˜æ›´ï¼‰</td>
    </tr>
    <tr>
      <td>3ï¸âƒ£ <strong>æ•°æ®åº“å”¯ä¸€çº¦æŸ</strong></td>
      <td>æ’å…¥æ—¶ä¾èµ– <code class="highlighter-rouge">UNIQUE KEY</code> æŠ¥é”™</td>
      <td>æ•°æ®å…¥åº“ã€ç”¨æˆ·æ³¨å†Œç­‰</td>
      <td>âœ… å¼ºä¸€è‡´æ€§<br />âœ… ä¸ä¾èµ–å¤–éƒ¨ç¼“å­˜</td>
      <td>âŒ æ€§èƒ½å·®<br />âŒ éœ€æ•è·å¼‚å¸¸</td>
    </tr>
    <tr>
      <td>4ï¸âƒ£ <strong>çŠ¶æ€æœºæ§åˆ¶</strong></td>
      <td>ä¸šåŠ¡çŠ¶æ€åªèƒ½å•å‘æµè½¬ï¼ˆå¦‚ï¼šå¾…æ”¯ä»˜ â†’ å·²æ”¯ä»˜ï¼‰</td>
      <td>æœ‰ä¸¥æ ¼çŠ¶æ€æµè½¬çš„ä¸šåŠ¡</td>
      <td>âœ… å¤©ç„¶é˜²é‡<br />âœ… æ— é¢å¤–å­˜å‚¨</td>
      <td>âŒ ä¸é€‚ç”¨äºå¹‚ç­‰æ›´æ–°ï¼ˆå¦‚å¤šæ¬¡åŠ ç§¯åˆ†ï¼‰</td>
    </tr>
    <tr>
      <td>5ï¸âƒ£ <strong>æœ¬åœ°æ–‡ä»¶æˆ–å†…å­˜æ ‡è®°</strong></td>
      <td>å•æœºè„šæœ¬å¯ç”¨ <code class="highlighter-rouge">flock()</code> æˆ–æ•°ç»„ç¼“å­˜</td>
      <td>å•æœºã€ä½é¢‘åœºæ™¯</td>
      <td>âœ… ç®€å•</td>
      <td>âŒ ä¸æ”¯æŒåˆ†å¸ƒå¼<br />âŒ é‡å¯ä¸¢å¤±</td>
    </tr>
  </tbody>
</table>

<blockquote>
  <p>âœ… <strong>æ¨èç»„åˆ</strong>ï¼š</p>
  <ul>
    <li>å¸¸è§„ä¸šåŠ¡ï¼š<strong>æ–¹æ¡ˆ 1ï¼ˆ<code class="highlighter-rouge">message_id</code> + Redisï¼‰</strong></li>
    <li>æ ¸å¿ƒäº¤æ˜“ï¼š<strong>æ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 3ï¼ˆæ•°æ®åº“å”¯ä¸€é”®ï¼‰åŒé‡ä¿é™©</strong></li>
    <li>çŠ¶æ€é©±åŠ¨ï¼š<strong>æ–¹æ¡ˆ 4ï¼ˆçŠ¶æ€æœºï¼‰ä¸ºä¸»ï¼Œè¾…ä»¥æ–¹æ¡ˆ 1</strong></li>
  </ul>
</blockquote>

<hr />

<h3 id="å››æ¶ˆè´¹è€…å¼€å‘åå¤§å…³é”®å®è·µæ•´åˆå¯é æ€§ä¸å¯ç»´æŠ¤æ€§">å››ã€æ¶ˆè´¹è€…å¼€å‘åå¤§å…³é”®å®è·µï¼ˆæ•´åˆå¯é æ€§ä¸å¯ç»´æŠ¤æ€§ï¼‰</h3>

<table>
  <thead>
    <tr>
      <th>ç±»åˆ«</th>
      <th>å®è·µè¦ç‚¹</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>ğŸ” <strong>1. æ‰‹åŠ¨ ACK</strong></td>
      <td>ç¦ç”¨ <code class="highlighter-rouge">auto_ack=true</code>ï¼Œä¸šåŠ¡å®Œæˆå <code class="highlighter-rouge">basic_ack()</code></td>
      <td>é˜²æ­¢æœªå¤„ç†å®Œå°±ç¡®è®¤ï¼Œé¿å…æ¶ˆæ¯ä¸¢å¤±</td>
    </tr>
    <tr>
      <td>âš–ï¸ <strong>2. å…¬å¹³åˆ†å‘ï¼ˆQoSï¼‰</strong></td>
      <td><code class="highlighter-rouge">basic_qos(null, 1, null)</code> æ§åˆ¶æœª ACK æ¶ˆæ¯æ•°</td>
      <td>é¿å…æŸæ¶ˆè´¹è€…è¿‡è½½ï¼Œæå‡è´Ÿè½½å‡è¡¡</td>
    </tr>
    <tr>
      <td>ğŸ§¼ <strong>3. ä¼˜é›…å…³é—­</strong></td>
      <td>æ•è· <code class="highlighter-rouge">SIGTERM</code>ï¼Œåœæ­¢ <code class="highlighter-rouge">wait()</code> å¹¶ç­‰å¾…å½“å‰æ¶ˆæ¯å¤„ç†å®Œ</td>
      <td>é˜²æ­¢å¼ºåˆ¶é€€å‡ºå¯¼è‡´æ¶ˆæ¯é‡æŠ•</td>
    </tr>
    <tr>
      <td>ğŸ—‘ï¸ <strong>4. æ­»ä¿¡é˜Ÿåˆ—ï¼ˆDLXï¼‰</strong></td>
      <td>é…ç½® DLX å¤„ç†é‡è¯•è¶…é™çš„æ¶ˆæ¯</td>
      <td>é¿å…æ— é™é‡å…¥é˜Ÿï¼Œä¾¿äºé—®é¢˜æ’æŸ¥</td>
    </tr>
    <tr>
      <td>ğŸ•’ <strong>5. æ§åˆ¶å¤„ç†æ—¶é•¿</strong></td>
      <td>é¿å…é˜»å¡æ“ä½œï¼Œè®¾ç½® <code class="highlighter-rouge">read_write_timeout</code></td>
      <td>é˜²æ­¢å¿ƒè·³è¶…æ—¶å¯¼è‡´è¿æ¥æ–­å¼€</td>
    </tr>
    <tr>
      <td>ğŸ” <strong>6. é‡è¯•ç­–ç•¥</strong></td>
      <td>å¤±è´¥å <code class="highlighter-rouge">nack(true)</code> é‡è¯•æœ‰é™æ¬¡æ•°ï¼ˆå¦‚ 3 æ¬¡ï¼‰</td>
      <td>é˜²æ­»å¾ªç¯ï¼Œç»“åˆ DLX ä½¿ç”¨</td>
    </tr>
    <tr>
      <td>ğŸ“Š <strong>7. æ—¥å¿—ä¸ç›‘æ§</strong></td>
      <td>è®°å½• <code class="highlighter-rouge">message_id</code>ã€å¤„ç†ç»“æœã€é‡è¯•æ¬¡æ•°</td>
      <td>ä¾¿äºè¿½è¸ªé—®é¢˜ï¼Œæ”¯æŒå¯¹è´¦</td>
    </tr>
    <tr>
      <td>ğŸ†” <strong>8. å”¯ä¸€æ ‡è¯†ä¼ é€’</strong></td>
      <td>æ¶ˆæ¯ä½“å¿…é¡»åŒ…å« <code class="highlighter-rouge">message_id</code>ï¼ˆç”Ÿäº§è€…ç”Ÿæˆï¼‰</td>
      <td>å¹‚ç­‰å»é‡çš„ä¾æ®</td>
    </tr>
    <tr>
      <td>ğŸ§© <strong>9. å¹‚ç­‰ä¼˜å…ˆäºé‡è¯•</strong></td>
      <td>å…ˆåˆ¤æ–­æ˜¯å¦å·²å¤„ç†ï¼Œå†å†³å®šæ˜¯å¦æ‰§è¡Œä¸šåŠ¡</td>
      <td>å‡å°‘æ— æ•ˆé‡è¯•ï¼Œæå‡æ€§èƒ½</td>
    </tr>
    <tr>
      <td>ğŸ§ª <strong>10. å‹æµ‹éªŒè¯</strong></td>
      <td>æ¨¡æ‹Ÿç½‘ç»œæŠ–åŠ¨ã€æ¶ˆè´¹è€…å´©æºƒï¼ŒéªŒè¯å»é‡æœ‰æ•ˆæ€§</td>
      <td>ç¡®ä¿æ–¹æ¡ˆåœ¨ç”Ÿäº§ç¯å¢ƒå¯é </td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="äº”å®Œæ•´å¤„ç†æµç¨‹ä»¥-php-ä¸ºä¾‹">äº”ã€å®Œæ•´å¤„ç†æµç¨‹ï¼ˆä»¥ PHP ä¸ºä¾‹ï¼‰</h3>
<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15</pre></td><td class="code"><pre class="highlight"><code>[æ¥æ”¶æ¶ˆæ¯]
     â†“
[æå– message_id]
     â†“
[Redis SET message_id NX EX 86400]
     â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ å·²å­˜åœ¨ï¼ŸYES  â”‚ â†’ ç›´æ¥ ACKï¼Œè·³è¿‡ä¸šåŠ¡ âœ…
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“ NO
[æ‰§è¡Œä¸šåŠ¡é€»è¾‘]
     â†“
[æˆåŠŸ] â†’ ACK âœ…
[å¤±è´¥] â†’ å¯é€‰ï¼šåˆ é™¤ Redis æ ‡è®° â†’ NACKï¼ˆé‡è¯•æˆ–è¿› DLXï¼‰âš ï¸

</code></pre></td></tr></tbody></table></div></div>

<blockquote>
  <p>âœ… å…³é”®ç‚¹ï¼š</p>
  <ul>
    <li><code class="highlighter-rouge">SET NX</code> æ˜¯åŸå­æ“ä½œï¼Œé˜²å¹¶å‘é‡å¤å¤„ç†</li>
    <li>ä¸šåŠ¡æˆåŠŸåæ‰ ACKï¼Œå¤±è´¥å¯å›æ»šæ ‡è®°å…è®¸é‡è¯•</li>
    <li>é‡è¯•æ¬¡æ•°è¶…é™ â†’ è¿› DLXï¼Œäººå·¥ä»‹å…¥</li>
  </ul>
</blockquote>

<hr />

<h3 id="å…­æ€»ç»“æ„å»ºé›¶èµ„æŸæ¶ˆè´¹è€…ä½“ç³»çš„å››å¤§æ”¯æŸ±">å…­ã€æ€»ç»“ï¼šæ„å»ºâ€œé›¶èµ„æŸâ€æ¶ˆè´¹è€…ä½“ç³»çš„å››å¤§æ”¯æŸ±</h3>

<table>
  <thead>
    <tr>
      <th>æ”¯æŸ±</th>
      <th>å†…æ¶µ</th>
      <th>è½åœ°åŠ¨ä½œ</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1ï¸âƒ£ <strong>è®¤çŸ¥åˆ°ä½</strong></td>
      <td>æ¥å—â€œé‡å¤æ¶ˆè´¹æ˜¯å¸¸æ€â€</td>
      <td>è®¾è®¡æ—¶é»˜è®¤æ¶ˆæ¯å¯èƒ½é‡å¤</td>
    </tr>
    <tr>
      <td>2ï¸âƒ£ <strong>å¹‚ç­‰ä¼˜å…ˆ</strong></td>
      <td>ä¸šåŠ¡å±‚å…·å¤‡å»é‡èƒ½åŠ›</td>
      <td>é‡‡ç”¨ <code class="highlighter-rouge">message_id</code> + Redis ç­‰æ–¹æ¡ˆ</td>
    </tr>
    <tr>
      <td>3ï¸âƒ£ <strong>æœºåˆ¶å¥å…¨</strong></td>
      <td>ACKã€QoSã€DLXã€ç›‘æ§å…¨è¦†ç›–</td>
      <td>é¿å…æŠ€æœ¯æ€§é‡å¤ï¼ˆå¦‚æœª ACKï¼‰</td>
    </tr>
    <tr>
      <td>4ï¸âƒ£ <strong>éªŒè¯å……åˆ†</strong></td>
      <td>å‹æµ‹ + å¯¹è´¦ + ç›‘æ§</td>
      <td>ç¡®ä¿æ–¹æ¡ˆåœ¨çœŸå®åœºæ™¯ä¸­å¯é </td>
    </tr>
  </tbody>
</table>

<hr />

<h3 id="-æœ€ç»ˆå»ºè®®">âœ… æœ€ç»ˆå»ºè®®</h3>

<ul>
  <li><strong>ä¸è¦ä¾èµ– RabbitMQ ä¿è¯â€œåªæ¶ˆè´¹ä¸€æ¬¡â€</strong> â€”â€” å®ƒæ²¡æœ‰è¿™ä¸ªè¯­ä¹‰ã€‚</li>
  <li><strong>ä¸è¦æŠŠâ€œæ²¡æŠ¥é”™â€å½“æˆâ€œæˆåŠŸâ€</strong> â€”â€” å¿…é¡» ACK æ‰ç®—å®Œæˆã€‚</li>
  <li><strong>ä¸è¦æŠŠâ€œé‡è¯•â€å½“â€œå®¹é”™â€</strong> â€”â€” æ— å¹‚ç­‰çš„é‡è¯•æ˜¯ç¾éš¾ã€‚</li>
  <li><strong>æŠŠâ€œå¹‚ç­‰â€å½“ä½œå’Œâ€œä¸šåŠ¡é€»è¾‘â€åŒç­‰é‡è¦çš„æ¨¡å—æ¥è®¾è®¡</strong>ã€‚</li>
</ul>

<hr />

<p>ğŸ’¡ <strong>é‡‘å¥æ€»ç»“</strong>ï¼š</p>
<blockquote>
  <p><strong>åœ¨æ¶ˆæ¯é©±åŠ¨çš„ç³»ç»Ÿä¸­ï¼Œæ¶ˆè´¹è€…ä¸æ˜¯â€œæ‰§è¡Œè€…â€ï¼Œè€Œæ˜¯â€œå†³ç­–è€…â€â€”â€”å®ƒå¿…é¡»åˆ¤æ–­ï¼šè¿™æ¡æ¶ˆæ¯æˆ‘ä»¥å‰è§è¿‡å—ï¼Ÿæˆ‘ç°åœ¨è¯¥å¤„ç†å—ï¼Ÿå¤„ç†é”™äº†èƒ½å›æ»šå—ï¼Ÿåªæœ‰æƒ³æ¸…æ¥šè¿™ä¸‰ä¸ªé—®é¢˜ï¼Œç³»ç»Ÿæ‰èƒ½çœŸæ­£å¯é ã€‚</strong></p>
</blockquote>

<h3 id="ä¸€äº”å¤§æ ¸å¿ƒæ¨¡å—ç³»ç»Ÿéª¨æ¶">ä¸€ã€äº”å¤§æ ¸å¿ƒæ¨¡å—ï¼ˆç³»ç»Ÿéª¨æ¶ï¼‰</h3>

<table>
  <thead>
    <tr>
      <th>æ¨¡å—</th>
      <th>èŒè´£</th>
      <th>å¯¹åº”ä»£ç æ–‡ä»¶</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1ï¸âƒ£ <strong>é…ç½®ç®¡ç†å±‚</strong></td>
      <td>ç»Ÿä¸€ç®¡ç† RabbitMQã€Redisã€é˜Ÿåˆ—ã€æ­»ä¿¡ç­‰å‚æ•°ï¼Œä¸ç¯å¢ƒè§£è€¦ï¼Œæ”¯æŒå¤šç¯å¢ƒçµæ´»åˆ‡æ¢</td>
      <td><code class="highlighter-rouge">config/rabbitmq.php</code></td>
    </tr>
    <tr>
      <td>2ï¸âƒ£ <strong>è¿æ¥èµ„æºç®¡ç†</strong></td>
      <td>åˆå§‹åŒ–å¹¶ç»´æŠ¤ RabbitMQ è¿æ¥ã€Channelã€Redis è¿æ¥æ± ï¼Œç¡®ä¿èµ„æºç”Ÿå‘½å‘¨æœŸå®‰å…¨ã€å¼‚å¸¸è‡ªåŠ¨æ¸…ç†</td>
      <td><code class="highlighter-rouge">BaseConsumer::initializeRabbitMQ()</code><br /><code class="highlighter-rouge">BaseConsumer::initializeRedis()</code></td>
    </tr>
    <tr>
      <td>3ï¸âƒ£ <strong>æ¶ˆæ¯æ¶ˆè´¹å¼•æ“</strong></td>
      <td>å®ç°æ¶ˆè´¹å¾ªç¯ã€å›è°ƒåˆ†å‘ã€æ‰‹åŠ¨ ACK/NACK æ§åˆ¶ã€QoS å…¬å¹³åˆ†å‘ï¼Œä¿éšœæ¶ˆæ¯å¯é æŠ•é€’ä¸è´Ÿè½½å‡è¡¡</td>
      <td><code class="highlighter-rouge">BaseConsumer::startConsuming()</code></td>
    </tr>
    <tr>
      <td>4ï¸âƒ£ <strong>ä¸šåŠ¡å¤„ç†æ ¸å¿ƒ</strong></td>
      <td>æŠ½è±¡ä¸šåŠ¡å¤„ç†é€»è¾‘ï¼Œå†…ç½®å¹‚ç­‰å»é‡ã€äº‹åŠ¡æ§åˆ¶ã€é‡è¯•æœºåˆ¶ã€æ­»ä¿¡ç­–ç•¥ï¼Œç¡®ä¿ä¸šåŠ¡æ‰§è¡Œçš„å‡†ç¡®æ€§å’Œå®¹é”™æ€§</td>
      <td><code class="highlighter-rouge">BaseConsumer::onMessage()</code><br />+ å­ç±» <code class="highlighter-rouge">processMessage()</code></td>
    </tr>
    <tr>
      <td>5ï¸âƒ£ <strong>è¿ç»´æ”¯æ’‘ä½“ç³»</strong></td>
      <td>æä¾›ç»“æ„åŒ–æ—¥å¿—ã€ç›‘æ§åŸ‹ç‚¹ã€ä¼˜é›…å…³é—­ï¼ˆä¿¡å·å¤„ç†ï¼‰ã€Supervisor è¿›ç¨‹æ‰˜ç®¡ï¼Œä¿éšœç³»ç»Ÿå¯è§‚æµ‹æ€§ä¸é«˜å¯ç”¨</td>
      <td><code class="highlighter-rouge">BaseConsumer::signalHandler()</code><br /><code class="highlighter-rouge">bin/consumer.php</code><br /><code class="highlighter-rouge">supervisor/*.conf</code></td>
    </tr>
  </tbody>
</table>

<ul>
  <li>ä¸€ã€ é…ç½®æ–‡ä»¶ (config/rabbitmq.php)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45<br/>46<br/>47<br/>48<br/>49<br/>50<br/>51<br/>52</pre></td><td class="code"><pre class="highlight"><code>&lt;?php
return [
    // RabbitMQ è¿æ¥é…ç½®
    'rabbitmq' =&gt; [
        'host' =&gt; 'rabbitmq-host',
        'port' =&gt; 5672,
        'username' =&gt; 'your_username',
        'password' =&gt; 'your_password',
        'vhost' =&gt; '/',
        'heartbeat' =&gt; 60,
        'read_write_timeout' =&gt; 60,
    ],
    
    // é˜Ÿåˆ—é…ç½®
    'queues' =&gt; [
        'order.created' =&gt; [
            'name' =&gt; 'order.created',
            'exchange' =&gt; 'orders',
            'routing_key' =&gt; 'order.created',
            'durable' =&gt; true,
            'prefetch' =&gt; 1, // å…¬å¹³åˆ†å‘
            'retry_count' =&gt; 3, // æœ€å¤§é‡è¯•æ¬¡æ•°
            'retry_delay' =&gt; 5000, // é‡è¯•å»¶è¿Ÿ(æ¯«ç§’)
        ],
        'payment.success' =&gt; [
            'name' =&gt; 'payment.success',
            'exchange' =&gt; 'payments',
            'routing_key' =&gt; 'payment.success',
            'durable' =&gt; true,
            'prefetch' =&gt; 2,
            'retry_count' =&gt; 5,
            'retry_delay' =&gt; 10000,
        ],
    ],
    
    // Redis é…ç½®ï¼ˆç”¨äºå¹‚ç­‰ï¼‰
    'redis' =&gt; [
        'host' =&gt; 'redis-host',
        'port' =&gt; 6379,
        'password' =&gt; '',
        'database' =&gt; 0,
        'timeout' =&gt; 3,
    ],
    
    // æ­»ä¿¡é˜Ÿåˆ—é…ç½®
    'dead_letter' =&gt; [
        'enabled' =&gt; true,
        'exchange' =&gt; 'dlx.orders',
        'queue' =&gt; 'dlx.order.created',
        'ttl' =&gt; 60000, // æ¶ˆæ¯åœ¨é˜Ÿåˆ—ä¸­å­˜æ´»æ—¶é—´(æ¯«ç§’)
    ],
];
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>äºŒã€ æ ¸å¿ƒæ¶ˆè´¹è€…ç±» (app/Consumers/BaseConsumer.php)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45<br/>46<br/>47<br/>48<br/>49<br/>50<br/>51<br/>52<br/>53<br/>54<br/>55<br/>56<br/>57<br/>58<br/>59<br/>60<br/>61<br/>62<br/>63<br/>64<br/>65<br/>66<br/>67<br/>68<br/>69<br/>70<br/>71<br/>72<br/>73<br/>74<br/>75<br/>76<br/>77<br/>78<br/>79<br/>80<br/>81<br/>82<br/>83<br/>84<br/>85<br/>86<br/>87<br/>88<br/>89<br/>90<br/>91<br/>92<br/>93<br/>94<br/>95<br/>96<br/>97<br/>98<br/>99<br/>100<br/>101<br/>102<br/>103<br/>104<br/>105<br/>106<br/>107<br/>108<br/>109<br/>110<br/>111<br/>112<br/>113<br/>114<br/>115<br/>116<br/>117<br/>118<br/>119<br/>120<br/>121<br/>122<br/>123<br/>124<br/>125<br/>126<br/>127<br/>128<br/>129<br/>130<br/>131<br/>132<br/>133<br/>134<br/>135<br/>136<br/>137<br/>138<br/>139<br/>140<br/>141<br/>142<br/>143<br/>144<br/>145<br/>146<br/>147<br/>148<br/>149<br/>150<br/>151<br/>152<br/>153<br/>154<br/>155<br/>156<br/>157<br/>158<br/>159<br/>160<br/>161<br/>162<br/>163<br/>164<br/>165<br/>166<br/>167<br/>168<br/>169<br/>170<br/>171<br/>172<br/>173<br/>174<br/>175<br/>176<br/>177<br/>178<br/>179<br/>180<br/>181<br/>182<br/>183<br/>184<br/>185<br/>186<br/>187<br/>188<br/>189<br/>190<br/>191<br/>192<br/>193<br/>194<br/>195<br/>196<br/>197<br/>198<br/>199<br/>200<br/>201<br/>202<br/>203<br/>204<br/>205<br/>206<br/>207<br/>208<br/>209<br/>210<br/>211<br/>212<br/>213<br/>214<br/>215<br/>216<br/>217<br/>218<br/>219<br/>220<br/>221<br/>222<br/>223<br/>224<br/>225<br/>226<br/>227<br/>228<br/>229<br/>230<br/>231<br/>232<br/>233<br/>234<br/>235<br/>236<br/>237<br/>238<br/>239<br/>240<br/>241<br/>242<br/>243<br/>244<br/>245<br/>246<br/>247<br/>248<br/>249<br/>250<br/>251<br/>252<br/>253<br/>254<br/>255<br/>256<br/>257<br/>258<br/>259<br/>260<br/>261<br/>262<br/>263<br/>264<br/>265<br/>266<br/>267<br/>268<br/>269<br/>270<br/>271<br/>272<br/>273<br/>274<br/>275<br/>276<br/>277<br/>278<br/>279<br/>280<br/>281<br/>282<br/>283<br/>284<br/>285<br/>286<br/>287<br/>288<br/>289<br/>290<br/>291<br/>292<br/>293<br/>294<br/>295<br/>296<br/>297<br/>298<br/>299<br/>300<br/>301<br/>302<br/>303<br/>304<br/>305<br/>306<br/>307<br/>308<br/>309<br/>310<br/>311<br/>312<br/>313<br/>314<br/>315<br/>316<br/>317<br/>318<br/>319<br/>320<br/>321<br/>322<br/>323<br/>324<br/>325<br/>326<br/>327<br/>328<br/>329<br/>330<br/>331<br/>332<br/>333<br/>334<br/>335<br/>336<br/>337<br/>338<br/>339<br/>340<br/>341<br/>342<br/>343<br/>344<br/>345<br/>346<br/>347<br/>348<br/>349<br/>350<br/>351<br/>352<br/>353<br/>354<br/>355<br/>356<br/>357<br/>358<br/>359<br/>360<br/>361<br/>362<br/>363<br/>364<br/>365<br/>366<br/>367<br/>368<br/>369<br/>370<br/>371<br/>372<br/>373<br/>374<br/>375<br/>376<br/>377<br/>378<br/>379<br/>380<br/>381<br/>382<br/>383<br/>384<br/>385<br/>386<br/>387<br/>388<br/>389<br/>390<br/>391<br/>392<br/>393<br/>394<br/>395<br/>396<br/>397<br/>398<br/>399<br/>400<br/>401<br/>402<br/>403<br/>404<br/>405<br/>406<br/>407<br/>408<br/>409<br/>410<br/>411<br/>412<br/>413<br/>414<br/>415<br/>416<br/>417<br/>418<br/>419<br/>420<br/>421<br/>422<br/>423<br/>424<br/>425<br/>426<br/>427<br/>428<br/>429<br/>430<br/>431<br/>432<br/>433<br/>434<br/>435<br/>436<br/>437<br/>438<br/>439<br/>440<br/>441<br/>442</pre></td><td class="code"><pre class="highlight"><code>&lt;?php
namespace App\Consumers;

use PhpAmqpLib\Connection\AMQPStreamConnection;
use PhpAmqpLib\Message\AMQPMessage;
use PhpAmqpLib\Exception\AMQPTimeoutException;
use Redis;
use Psr\Log\LoggerInterface;

abstract class BaseConsumer
{
    protected $connection;
    protected $channel;
    protected $redis;
    protected $logger;
    protected $config;
    
    // ä¿¡å·æ§åˆ¶
    protected $shouldStop = false;
    protected $currentMessage = null;
    protected $currentStartTime = 0;

    public function __construct(array $config, LoggerInterface $logger)
    {
        $this-&gt;config = $config;
        $this-&gt;logger = $logger;
        $this-&gt;setupSignalHandlers();
    }

    /**
     * åˆå§‹åŒ–è¿æ¥å’Œèµ„æº
     */
    public function initialize(): void
    {
        // åˆå§‹åŒ– Redis
        $this-&gt;initializeRedis();
        
        // åˆå§‹åŒ– RabbitMQ è¿æ¥
        $this-&gt;initializeRabbitMQ();
    }

    /**
     * åˆå§‹åŒ– Redis
     */
    protected function initializeRedis(): void
    {
        try {
            $this-&gt;redis = new Redis();
            $redisConfig = $this-&gt;config['redis'];
            
            if (!$this-&gt;redis-&gt;connect(
                $redisConfig['host'], 
                $redisConfig['port'], 
                $redisConfig['timeout']
            )) {
                throw new \Exception("Redis connection failed");
            }
            
            if (!empty($redisConfig['password'])) {
                $this-&gt;redis-&gt;auth($redisConfig['password']);
            }
            
            $this-&gt;redis-&gt;select($redisConfig['database']);
            
            $this-&gt;logger-&gt;info("Redis connected successfully");
        } catch (\Exception $e) {
            $this-&gt;logger-&gt;error("Redis initialization failed: " . $e-&gt;getMessage());
            throw $e;
        }
    }

    /**
     * åˆå§‹åŒ– RabbitMQ è¿æ¥
     */
    protected function initializeRabbitMQ(): void
    {
        try {
            $rabbitConfig = $this-&gt;config['rabbitmq'];
            
            $this-&gt;connection = new AMQPStreamConnection(
                $rabbitConfig['host'],
                $rabbitConfig['port'],
                $rabbitConfig['username'],
                $rabbitConfig['password'],
                $rabbitConfig['vhost'],
                false,
                'AMQPLAIN',
                null,
                'en_US',
                $rabbitConfig['read_write_timeout'],
                $rabbitConfig['read_write_timeout'],
                null,
                false,
                $rabbitConfig['heartbeat']
            );

            $this-&gt;channel = $this-&gt;connection-&gt;channel();
            
            // è®¾ç½® QoSï¼ˆå…¬å¹³åˆ†å‘ï¼‰
            $this-&gt;channel-&gt;basic_qos(null, $this-&gt;getPrefetchCount(), null);
            
            $this-&gt;logger-&gt;info("RabbitMQ connected successfully");
        } catch (\Exception $e) {
            $this-&gt;logger-&gt;error("RabbitMQ initialization failed: " . $e-&gt;getMessage());
            throw $e;
        }
    }

    /**
     * å£°æ˜é˜Ÿåˆ—å’Œç»‘å®š
     */
    protected function declareQueue(string $queueName): void
    {
        $queueConfig = $this-&gt;config['queues'][$queueName];
        
        // å£°æ˜æ­»ä¿¡äº¤æ¢æœºå’Œé˜Ÿåˆ—ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if ($this-&gt;config['dead_letter']['enabled']) {
            $this-&gt;declareDeadLetter($queueName);
        }

        // å£°æ˜ä¸»é˜Ÿåˆ—
        $args = [];
        if ($this-&gt;config['dead_letter']['enabled']) {
            $args['x-dead-letter-exchange'] = $this-&gt;config['dead_letter']['exchange'];
            $args['x-dead-letter-routing-key'] = $this-&gt;config['dead_letter']['queue'];
            $args['x-message-ttl'] = $this-&gt;config['dead_letter']['ttl'];
        }

        $this-&gt;channel-&gt;queue_declare(
            $queueConfig['name'],
            false, // passive
            $queueConfig['durable'], // durable
            false, // exclusive
            false, // auto_delete
            false, // nowait
            $args // arguments
        );

        // å£°æ˜äº¤æ¢æœº
        $this-&gt;channel-&gt;exchange_declare(
            $queueConfig['exchange'],
            'direct', // type
            false, // passive
            $queueConfig['durable'], // durable
            false // auto_delete
        );

        // ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº
        $this-&gt;channel-&gt;queue_bind(
            $queueConfig['name'],
            $queueConfig['exchange'],
            $queueConfig['routing_key']
        );

        $this-&gt;logger-&gt;info("Queue {$queueName} declared and bound successfully");
    }

    /**
     * å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
     */
    protected function declareDeadLetter(string $queueName): void
    {
        $dlxConfig = $this-&gt;config['dead_letter'];
        $queueConfig = $this-&gt;config['queues'][$queueName];

        // å£°æ˜æ­»ä¿¡äº¤æ¢æœº
        $this-&gt;channel-&gt;exchange_declare(
            $dlxConfig['exchange'],
            'direct',
            false,
            true,
            false
        );

        // å£°æ˜æ­»ä¿¡é˜Ÿåˆ—
        $this-&gt;channel-&gt;queue_declare(
            $dlxConfig['queue'] . '.' . $queueName,
            false,
            true,
            false,
            false
        );

        // ç»‘å®šæ­»ä¿¡é˜Ÿåˆ—
        $this-&gt;channel-&gt;queue_bind(
            $dlxConfig['queue'] . '.' . $queueName,
            $dlxConfig['exchange'],
            $queueConfig['routing_key']
        );
    }

    /**
     * æ¶ˆæ¯å¤„ç†å‡½æ•°ï¼ˆå­ç±»å¿…é¡»å®ç°ï¼‰
     */
    abstract protected function processMessage(array $data, array $headers): bool;

    /**
     * è·å–æ¶ˆæ¯å»é‡é”®
     */
    protected function getDeduplicationKey(AMQPMessage $message): string
    {
        $data = json_decode($message-&gt;getBody(), true);
        return $data['message_id'] ?? $message-&gt;getDeliveryTag() . '_' . md5($message-&gt;getBody());
    }

    /**
     * æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å¤„ç†ï¼ˆå¹‚ç­‰æ€§ï¼‰
     */
    protected function isMessageProcessed(string $deduplicationKey): bool
    {
        $key = "processed:message:{$deduplicationKey}";
        return $this-&gt;redis-&gt;exists($key);
    }

    /**
     * æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
     */
    protected function markMessageProcessed(string $deduplicationKey, int $ttl = 86400): void
    {
        $key = "processed:message:{$deduplicationKey}";
        $this-&gt;redis-&gt;setex($key, $ttl, 1);
    }

    /**
     * æ¶ˆæ¯æ¶ˆè´¹å›è°ƒ
     */
    public function onMessage(AMQPMessage $message): void
    {
        $this-&gt;currentMessage = $message;
        $this-&gt;currentStartTime = microtime(true);

        try {
            // æå–æ¶ˆæ¯å†…å®¹
            $data = json_decode($message-&gt;getBody(), true);
            if (json_last_error() !== JSON_ERROR_NONE) {
                throw new \Exception("Invalid JSON: " . json_last_error_msg());
            }

            $headers = $message-&gt;get_properties();
            $deduplicationKey = $this-&gt;getDeduplicationKey($message);

            $this-&gt;logger-&gt;info("Processing message", [
                'message_id' =&gt; $data['message_id'] ?? 'unknown',
                'delivery_tag' =&gt; $message-&gt;getDeliveryTag(),
                'redelivered' =&gt; $message-&gt;isRedelivered()
            ]);

            // å¹‚ç­‰æ€§æ£€æŸ¥
            if ($this-&gt;isMessageProcessed($deduplicationKey)) {
                $this-&gt;logger-&gt;info("Duplicate message detected, skipping", [
                    'message_id' =&gt; $data['message_id'] ?? 'unknown'
                ]);
                $message-&gt;ack();
                return;
            }

            // ä¸šåŠ¡å¤„ç†
            $success = $this-&gt;processMessage($data, $headers);

            if ($success) {
                // æ ‡è®°æ¶ˆæ¯å·²å¤„ç†
                $this-&gt;markMessageProcessed($deduplicationKey);
                
                // ç¡®è®¤æ¶ˆæ¯
                $message-&gt;ack();
                
                $processingTime = round((microtime(true) - $this-&gt;currentStartTime) * 1000, 2);
                $this-&gt;logger-&gt;info("Message processed successfully", [
                    'message_id' =&gt; $data['message_id'] ?? 'unknown',
                    'processing_time_ms' =&gt; $processingTime
                ]);
            } else {
                throw new \Exception("Business processing failed");
            }

        } catch (\Exception $e) {
            $this-&gt;handleProcessingFailure($message, $e);
        } finally {
            $this-&gt;currentMessage = null;
            $this-&gt;currentStartTime = 0;
        }
    }

    /**
     * å¤„ç†å¤„ç†å¤±è´¥
     */
    protected function handleProcessingFailure(AMQPMessage $message, \Exception $e): void
    {
        $data = json_decode($message-&gt;getBody(), true);
        $messageId = $data['message_id'] ?? 'unknown';
        
        $processingTime = round((microtime(true) - $this-&gt;currentStartTime) * 1000, 2);
        
        $this-&gt;logger-&gt;error("Message processing failed", [
            'message_id' =&gt; $messageId,
            'error' =&gt; $e-&gt;getMessage(),
            'processing_time_ms' =&gt; $processingTime,
            'delivery_tag' =&gt; $message-&gt;getDeliveryTag(),
            'redelivered' =&gt; $message-&gt;isRedelivered()
        ]);

        // æ ¹æ®é‡è¯•æ¬¡æ•°å†³å®šæ˜¯å¦é‡è¯•æˆ–æ‹’ç»
        $retryCount = $this-&gt;getCurrentRetryCount($message);
        $maxRetries = $this-&gt;getMaxRetryCount();

        if ($retryCount &lt; $maxRetries) {
            // é‡è¯•ï¼šé‡æ–°å…¥é˜Ÿ
            $this-&gt;logger-&gt;info("Retrying message", [
                'message_id' =&gt; $messageId,
                'retry_count' =&gt; $retryCount + 1,
                'max_retries' =&gt; $maxRetries
            ]);
            
            // å»¶è¿Ÿé‡è¯•ï¼ˆé€šè¿‡ TTL å®ç°ï¼‰
            $message-&gt;nack(false); // ä¸é‡æ–°å…¥é˜Ÿï¼Œç­‰å¾… TTL åè¿›å…¥æ­»ä¿¡æˆ–é‡æ–°å‘å¸ƒ
        } else {
            // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œæ‹’ç»æ¶ˆæ¯ï¼ˆè¿›å…¥æ­»ä¿¡é˜Ÿåˆ—ï¼‰
            $this-&gt;logger-&gt;warning("Max retries exceeded, sending to dead letter", [
                'message_id' =&gt; $messageId,
                'retry_count' =&gt; $retryCount
            ]);
            
            $message-&gt;nack(false); // æ‹’ç»ï¼Œä¸é‡æ–°å…¥é˜Ÿ
        }
    }

    /**
     * è·å–å½“å‰é‡è¯•æ¬¡æ•°
     */
    protected function getCurrentRetryCount(AMQPMessage $message): int
    {
        $headers = $message-&gt;get_properties();
        $retryCount = $headers['application_headers']['x-retry-count'][1] ?? 0;
        return (int)$retryCount;
    }

    /**
     * è·å–æœ€å¤§é‡è¯•æ¬¡æ•°
     */
    protected function getMaxRetryCount(): int
    {
        return $this-&gt;config['queues']['order.created']['retry_count'] ?? 3;
    }

    /**
     * è·å–é¢„å–è®¡æ•°
     */
    protected function getPrefetchCount(): int
    {
        return $this-&gt;config['queues']['order.created']['prefetch'] ?? 1;
    }

    /**
     * è®¾ç½®ä¿¡å·å¤„ç†å™¨ï¼ˆä¼˜é›…å…³é—­ï¼‰
     */
    protected function setupSignalHandlers(): void
    {
        pcntl_signal(SIGTERM, [$this, 'signalHandler']);
        pcntl_signal(SIGINT, [$this, 'signalHandler']);
        pcntl_signal(SIGHUP, [$this, 'signalHandler']);
    }

    /**
     * ä¿¡å·å¤„ç†
     */
    public function signalHandler(int $signal): void
    {
        $this-&gt;logger-&gt;info("Received signal {$signal}, shutting down gracefully...");
        $this-&gt;shouldStop = true;
    }

    /**
     * å¼€å§‹æ¶ˆè´¹
     */
    public function startConsuming(string $queueName): void
    {
        $this-&gt;declareQueue($queueName);

        $this-&gt;logger-&gt;info("Starting consumer for queue: {$queueName}");

        $callback = function (AMQPMessage $message) {
            // æ£€æŸ¥æ˜¯å¦éœ€è¦åœæ­¢
            pcntl_signal_dispatch();
            if ($this-&gt;shouldStop) {
                $this-&gt;logger-&gt;info("Stopping consumer due to shutdown signal");
                throw new \Exception("Consumer shutdown requested");
            }

            $this-&gt;onMessage($message);
        };

        $queueConfig = $this-&gt;config['queues'][$queueName];
        
        $this-&gt;channel-&gt;basic_consume(
            $queueConfig['name'],
            '', // consumer tag
            false, // no local
            false, // no ack (we do manual ack)
            false, // exclusive
            false, // no wait
            $callback
        );

        // ä¸»å¾ªç¯
        try {
            while (count($this-&gt;channel-&gt;callbacks) &amp;&amp; !$this-&gt;shouldStop) {
                $this-&gt;channel-&gt;wait(null, false, 1); // 1ç§’è¶…æ—¶ï¼Œä¾¿äºæ£€æŸ¥åœæ­¢ä¿¡å·
                pcntl_signal_dispatch();
            }
        } catch (\Exception $e) {
            $this-&gt;logger-&gt;info("Consumer stopped: " . $e-&gt;getMessage());
        }

        $this-&gt;logger-&gt;info("Consumer stopped gracefully");
    }

    /**
     * å…³é—­è¿æ¥
     */
    public function close(): void
    {
        try {
            if ($this-&gt;channel &amp;&amp; $this-&gt;channel-&gt;is_open()) {
                $this-&gt;channel-&gt;close();
            }
            if ($this-&gt;connection &amp;&amp; $this-&gt;connection-&gt;isConnected()) {
                $this-&gt;connection-&gt;close();
            }
            if ($this-&gt;redis) {
                $this-&gt;redis-&gt;close();
            }
            $this-&gt;logger-&gt;info("All connections closed");
        } catch (\Exception $e) {
            $this-&gt;logger-&gt;error("Error closing connections: " . $e-&gt;getMessage());
        }
    }

    public function __destruct()
    {
        $this-&gt;close();
    }
}
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>ä¸‰ã€ å…·ä½“ä¸šåŠ¡æ¶ˆè´¹è€… (app/Consumers/OrderCreatedConsumer.php)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45<br/>46<br/>47<br/>48<br/>49<br/>50<br/>51<br/>52<br/>53<br/>54<br/>55<br/>56<br/>57<br/>58<br/>59<br/>60<br/>61<br/>62<br/>63<br/>64<br/>65<br/>66<br/>67<br/>68<br/>69<br/>70<br/>71<br/>72<br/>73<br/>74<br/>75<br/>76<br/>77<br/>78<br/>79<br/>80<br/>81<br/>82<br/>83<br/>84<br/>85<br/>86<br/>87<br/>88</pre></td><td class="code"><pre class="highlight"><code>&lt;?php
namespace App\Consumers;

use Psr\Log\LoggerInterface;

class OrderCreatedConsumer extends BaseConsumer
{
    public function __construct(array $config, LoggerInterface $logger)
    {
        parent::__construct($config, $logger);
    }

    /**
     * ä¸šåŠ¡æ¶ˆæ¯å¤„ç†
     */
    protected function processMessage(array $data, array $headers): bool
    {
        try {
            $messageId = $data['message_id'] ?? 'unknown';
            $orderId = $data['order_id'] ?? null;
            $orderData = $data['data'] ?? [];

            if (!$orderId) {
                throw new \Exception("Missing order_id in message");
            }

            $this-&gt;logger-&gt;info("Processing order creation", [
                'order_id' =&gt; $orderId,
                'message_id' =&gt; $messageId
            ]);

            // æ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†ï¼šåˆ›å»ºè®¢å•ã€æ‰£åº“å­˜ã€å‘é€šçŸ¥ç­‰
            // è¿™é‡Œåº”è¯¥æ˜¯ä½ çš„å®é™…ä¸šåŠ¡é€»è¾‘
            $result = $this-&gt;createOrder($orderId, $orderData);
            
            if (!$result) {
                throw new \Exception("Order creation failed for order_id: {$orderId}");
            }

            // æ¨¡æ‹Ÿæ•°æ®åº“äº‹åŠ¡æäº¤
            $this-&gt;commitTransaction();

            return true;

        } catch (\Exception $e) {
            $this-&gt;rollbackTransaction();
            throw $e;
        }
    }

    /**
     * åˆ›å»ºè®¢å•ä¸šåŠ¡é€»è¾‘
     */
    private function createOrder(string $orderId, array $orderData): bool
    {
        // è¿™é‡Œå®ç°ä½ çš„è®¢å•åˆ›å»ºé€»è¾‘
        // ä¾‹å¦‚ï¼šå†™å…¥æ•°æ®åº“ã€è°ƒç”¨åº“å­˜æœåŠ¡ã€å‘é€é€šçŸ¥ç­‰
        
        // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
        usleep(rand(100000, 500000)); // 0.1-0.5ç§’
        
        // æ¨¡æ‹Ÿå¶å°”çš„å¤±è´¥ï¼ˆç”¨äºæµ‹è¯•é‡è¯•æœºåˆ¶ï¼‰
        if (rand(1, 100) &lt;= 5) { // 5% å¤±è´¥ç‡
            return false;
        }
        
        $this-&gt;logger-&gt;info("Order created successfully", ['order_id' =&gt; $orderId]);
        return true;
    }

    /**
     * æäº¤äº‹åŠ¡
     */
    private function commitTransaction(): void
    {
        // å®ç°ä½ çš„äº‹åŠ¡æäº¤é€»è¾‘
        // ä¾‹å¦‚ï¼šDB::commit() æˆ–å…¶ä»–æœåŠ¡çš„ç¡®è®¤
    }

    /**
     * å›æ»šäº‹åŠ¡
     */
    private function rollbackTransaction(): void
    {
        // å®ç°ä½ çš„äº‹åŠ¡å›æ»šé€»è¾‘
        // ä¾‹å¦‚ï¼šDB::rollBack() æˆ–å…¶ä»–æœåŠ¡çš„å–æ¶ˆ
    }
}
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>å››ã€ æ¶ˆè´¹è€…å¯åŠ¨è„šæœ¬ (bin/consumer.php)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21<br/>22<br/>23<br/>24<br/>25<br/>26<br/>27<br/>28<br/>29<br/>30<br/>31<br/>32<br/>33<br/>34<br/>35<br/>36<br/>37<br/>38<br/>39<br/>40<br/>41<br/>42<br/>43<br/>44<br/>45</pre></td><td class="code"><pre class="highlight"><code>#!/usr/bin/env php
<span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/../vendor/autoload.php'</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Consumers\OrderCreatedConsumer</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Monolog\Logger</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Monolog\Handler\RotatingFileHandler</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Monolog\Formatter\LineFormatter</span><span class="p">;</span>

<span class="c1">// åŠ è½½é…ç½®
</span><span class="nv">$config</span> <span class="o">=</span> <span class="k">require_once</span> <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/../config/rabbitmq.php'</span><span class="p">;</span>

<span class="c1">// åˆå§‹åŒ–æ—¥å¿—
</span><span class="nv">$logger</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Logger</span><span class="p">(</span><span class="s1">'rabbitmq_consumer'</span><span class="p">);</span>

<span class="c1">// æ–‡ä»¶å¤„ç†å™¨ï¼ˆæŒ‰å¤©è½®è½¬ï¼Œä¿ç•™30å¤©ï¼‰
</span><span class="nv">$fileHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">RotatingFileHandler</span><span class="p">(</span>
    <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/../logs/consumer.log'</span><span class="p">,</span>
    <span class="mi">30</span><span class="p">,</span> <span class="c1">// ä¿ç•™å¤©æ•°
</span>    <span class="nx">Logger</span><span class="o">::</span><span class="na">INFO</span>
<span class="p">);</span>

<span class="nv">$formatter</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LineFormatter</span><span class="p">(</span>
    <span class="s2">"[%datetime%] %channel%.%level_name%: %message% %context% %extra%</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span>
    <span class="s2">"Y-m-d H:i:s.u"</span>
<span class="p">);</span>
<span class="nv">$fileHandler</span><span class="o">-&gt;</span><span class="na">setFormatter</span><span class="p">(</span><span class="nv">$formatter</span><span class="p">);</span>
<span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">pushHandler</span><span class="p">(</span><span class="nv">$fileHandler</span><span class="p">);</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="c1">// åˆ›å»ºæ¶ˆè´¹è€…å®ä¾‹
</span>    <span class="nv">$consumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OrderCreatedConsumer</span><span class="p">(</span><span class="nv">$config</span><span class="p">,</span> <span class="nv">$logger</span><span class="p">);</span>
    
    <span class="c1">// åˆå§‹åŒ–è¿æ¥
</span>    <span class="nv">$consumer</span><span class="o">-&gt;</span><span class="na">initialize</span><span class="p">();</span>
    
    <span class="c1">// å¼€å§‹æ¶ˆè´¹ï¼ˆä¼˜é›…å…³é—­æ”¯æŒï¼‰
</span>    <span class="nv">$consumer</span><span class="o">-&gt;</span><span class="na">startConsuming</span><span class="p">(</span><span class="s1">'order.created'</span><span class="p">);</span>
    
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$logger</span><span class="o">-&gt;</span><span class="na">critical</span><span class="p">(</span><span class="s2">"Consumer failed to start: "</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">(),</span> <span class="p">[</span>
        <span class="s1">'exception'</span> <span class="o">=&gt;</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getTraceAsString</span><span class="p">()</span>
    <span class="p">]);</span>
    <span class="k">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></tbody></table></div></div>
<ul>
  <li>äº”ã€ Supervisor é…ç½® (supervisor/consumer.conf)</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4<br/>5<br/>6<br/>7<br/>8<br/>9<br/>10<br/>11<br/>12<br/>13<br/>14<br/>15<br/>16<br/>17<br/>18<br/>19<br/>20<br/>21</pre></td><td class="code"><pre class="highlight"><code>[program:rabbitmq-order-consumer]
process_name=%(program_name)s_%(process_num)02d
command=/usr/bin/php /path/to/your/project/bin/consumer.php
directory=/path/to/your/project
numprocs=2
autostart=true
autorestart=true
startretries=3
user=www-data
redirect_stderr=true
stdout_logfile=/path/to/your/project/logs/supervisor.log
stopwaitsecs=30
killasgroup=true
priority=999

; ç¯å¢ƒå˜é‡
environment=APP_ENV="production",APP_DEBUG="false"

; åœæ­¢ä¿¡å·ï¼ˆä¼˜é›…å…³é—­ï¼‰
stopsignal=TERM
stopasgroup=true
</code></pre></td></tr></tbody></table></div></div>

<h3 id="-ä½¿ç”¨æ–¹å¼">ğŸš€ ä½¿ç”¨æ–¹å¼</h3>

<ul>
  <li>ä¸€ã€ å®‰è£…ä¾èµ–ï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code>composer require php-amqplib/php-amqplib monolog/monolog predis/predis
</code></pre></td></tr></tbody></table></div></div>
<ul>
  <li>äºŒã€ é…ç½® Supervisorï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1<br/>2<br/>3<br/>4</pre></td><td class="code"><pre class="highlight"><code>sudo cp supervisor/consumer.conf /etc/supervisor/conf.d/
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start rabbitmq-order-consumer:*
</code></pre></td></tr></tbody></table></div></div>

<ul>
  <li>ä¸‰ã€ ç›‘æ§æ—¥å¿—ï¼š</li>
</ul>

<div class="highlighter-rouge"><div class="highlight"><table style="margin: 0px"><tbody><tr><td class="gutter"><pre>1</pre></td><td class="code"><pre class="highlight"><code>tail -f logs/consumer.log
</code></pre></td></tr></tbody></table></div></div>


      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        
  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>åšæŒåŸåˆ›æŠ€æœ¯åˆ†äº«ï¼Œæ‚¨çš„æ”¯æŒå°†é¼“åŠ±æˆ‘ç»§ç»­åˆ›ä½œï¼</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>èµ</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/assets/images/wechat.gif" alt="Zhao Q.H. WeChat Pay"/>
          <p>å¾®ä¿¡æ‰“èµ</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/assets/images/pay.gif" alt="Zhao Q.H. Alipay"/>
          <p>æ”¯ä»˜å®æ‰“èµ</p>
        </div>
      
    </div>
  </div>


      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            
            <a href="/tag/#/rabbitmq" rel="tag"># rabbitmq</a>
          
        </div>
      

      
      
      
      
      

      
      
        <div class="post-nav" id="post-nav-id">
          <div class="post-nav-next post-nav-item">
            
              <a href="/%E9%9D%A2%E8%AF%95/2025/12/11/mianshi-go/" rel="next" title="Golangé¢è¯•æ±‡æ€»">
                <i class="fa fa-chevron-left"></i> Golangé¢è¯•æ±‡æ€»
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/php/2025/12/03/xhprof/" rel="prev" title="XHProfæ€§èƒ½åˆ†æå·¥å…·ã€‚">
                XHProfæ€§èƒ½åˆ†æå·¥å…·ã€‚ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
      

      
    </footer>
  </article>

  <div class="post-spread">
    
  </div>
</div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="gitalk-container"></div>
    
  </div>


        </div>
        
          

  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        
        
        







      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/assets/images/avatar.gif"
               alt="Zhao Q.H." />
          <p class="site-author-name" itemprop="name">Zhao Q.H.</p>
           
              <p class="site-description motion-element" itemprop="description">Keep It Simple, Stupid</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">51</span>
                <span class="site-state-item-name">æ—¥å¿—</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/">
                <span class="site-state-item-count">26</span>
                <span class="site-state-item-name">åˆ†ç±»</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">æ ‡ç­¾</span>
              </a>
            </div>
          

        </nav>

        
        
        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              
              
              <span class="links-of-author-item">
                <a href="https://github.com/zhaoqhu/zhaoqhu.github.io/issues" target="_blank" title="Issues">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  Issues
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            








            
              <div class="post-toc-content">
    <ol class=nav>
      <li class="nav-item nav-level-2"> <a class="nav-link" href="#æ¶ˆæ¯é˜Ÿåˆ—"> <span class="nav-number">1</span> <span class="nav-text">æ¶ˆæ¯é˜Ÿåˆ—</span> </a> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#ç”Ÿäº§è€…"> <span class="nav-number">2</span> <span class="nav-text">ç”Ÿäº§è€…</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#-å¦‚ä½•ç¡®ä¿å‡ ä¹-100ä¸ä¸¢-5-å±‚é˜²æŠ¤è¯¦è§£"> <span class="nav-number">2.1</span> <span class="nav-text">âœ… å¦‚ä½•ç¡®ä¿â€œå‡ ä¹ 100%â€ä¸ä¸¢ï¼Ÿâ€”â€” 5 å±‚é˜²æŠ¤è¯¦è§£</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#ç”Ÿäº§ç¯å¢ƒä¸­ç”Ÿäº§è€…çš„æ ‡å‡†ç­”æ¡ˆ"> <span class="nav-number">2.2</span> <span class="nav-text">ç”Ÿäº§ç¯å¢ƒä¸­ç”Ÿäº§è€…çš„æ ‡å‡†ç­”æ¡ˆ</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#è°ƒç”¨ç¤ºä¾‹"> <span class="nav-number">2.3</span> <span class="nav-text">è°ƒç”¨ç¤ºä¾‹</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#æ¶ˆæ¯æŒä¹…åŒ–"> <span class="nav-number">2.4</span> <span class="nav-text">æ¶ˆæ¯æŒä¹…åŒ–</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#å¹‚ç­‰å¤„ç†"> <span class="nav-number">2.5</span> <span class="nav-text">å¹‚ç­‰å¤„ç†</span> </a> </li> </ol> </li> <li class="nav-item nav-level-2"> <a class="nav-link" href="#ï¸-rabbitmq-æ¶ˆè´¹è€…é˜²é‡å¤æ¶ˆè´¹ä¸å¹‚ç­‰å¤„ç†å®Œæ•´æ–¹æ¡ˆ"> <span class="nav-number">3</span> <span class="nav-text">ğŸ›¡ï¸ RabbitMQ æ¶ˆè´¹è€…é˜²é‡å¤æ¶ˆè´¹ä¸å¹‚ç­‰å¤„ç†å®Œæ•´æ–¹æ¡ˆ</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-3"> <a class="nav-link" href="#ä¸€ä¸ºä»€ä¹ˆå¿…é¡»å¤„ç†é‡å¤æ¶ˆè´¹"> <span class="nav-number">3.1</span> <span class="nav-text">ä¸€ã€ä¸ºä»€ä¹ˆå¿…é¡»å¤„ç†é‡å¤æ¶ˆè´¹ï¼Ÿ</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#äºŒå¹‚ç­‰æ€§æ¶ˆè´¹è€…çš„ç”Ÿå‘½çº¿"> <span class="nav-number">3.2</span> <span class="nav-text">äºŒã€å¹‚ç­‰æ€§ï¼šæ¶ˆè´¹è€…çš„ç”Ÿå‘½çº¿</span> </a> <ol class="nav-child"> <li class="nav-item nav-level-4"> <a class="nav-link" href="#-å¹‚ç­‰ä¸æ˜¯å¯é€‰é¡¹è€Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…é€‰é¡¹"> <span class="nav-number">3.2.1</span> <span class="nav-text">âœ… å¹‚ç­‰ä¸æ˜¯â€œå¯é€‰é¡¹â€ï¼Œè€Œæ˜¯ç”Ÿäº§ç¯å¢ƒçš„å¿…é€‰é¡¹ã€‚</span> </a> </li> </ol> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#ä¸‰äº”å¤§å¹‚ç­‰ç­–ç•¥æŒ‰æ¨èåº¦æ’åº"> <span class="nav-number">3.3</span> <span class="nav-text">ä¸‰ã€äº”å¤§å¹‚ç­‰ç­–ç•¥ï¼ˆæŒ‰æ¨èåº¦æ’åºï¼‰</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#å››æ¶ˆè´¹è€…å¼€å‘åå¤§å…³é”®å®è·µæ•´åˆå¯é æ€§ä¸å¯ç»´æŠ¤æ€§"> <span class="nav-number">3.4</span> <span class="nav-text">å››ã€æ¶ˆè´¹è€…å¼€å‘åå¤§å…³é”®å®è·µï¼ˆæ•´åˆå¯é æ€§ä¸å¯ç»´æŠ¤æ€§ï¼‰</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#äº”å®Œæ•´å¤„ç†æµç¨‹ä»¥-php-ä¸ºä¾‹"> <span class="nav-number">3.5</span> <span class="nav-text">äº”ã€å®Œæ•´å¤„ç†æµç¨‹ï¼ˆä»¥ PHP ä¸ºä¾‹ï¼‰</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#å…­æ€»ç»“æ„å»ºé›¶èµ„æŸæ¶ˆè´¹è€…ä½“ç³»çš„å››å¤§æ”¯æŸ±"> <span class="nav-number">3.6</span> <span class="nav-text">å…­ã€æ€»ç»“ï¼šæ„å»ºâ€œé›¶èµ„æŸâ€æ¶ˆè´¹è€…ä½“ç³»çš„å››å¤§æ”¯æŸ±</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#-æœ€ç»ˆå»ºè®®"> <span class="nav-number">3.7</span> <span class="nav-text">âœ… æœ€ç»ˆå»ºè®®</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#ä¸€äº”å¤§æ ¸å¿ƒæ¨¡å—ç³»ç»Ÿéª¨æ¶"> <span class="nav-number">3.8</span> <span class="nav-text">ä¸€ã€äº”å¤§æ ¸å¿ƒæ¨¡å—ï¼ˆç³»ç»Ÿéª¨æ¶ï¼‰</span> </a> </li> <li class="nav-item nav-level-3"> <a class="nav-link" href="#-ä½¿ç”¨æ–¹å¼"> <span class="nav-number">3.9</span> <span class="nav-text">ğŸš€ ä½¿ç”¨æ–¹å¼</span> </a> </li> </ol> </li>
    </ol>
  </div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>

        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  
  &copy; 
  <span itemprop="copyrightYear">2026</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zhao Q.H.</span>
</div>


<div class="powered-by">
  ç”± <a class="theme-link" href="https://jekyllrb.com">Jekyll</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/simpleyyt/jekyll-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>





















  
   
  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery/index.js?v=2.1.3"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  
  
  
  
  <script type="text/javascript" src="/assets/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/assets/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/assets/js/src/motion.js?v=5.1.1"></script>



  
  


  <script type="text/javascript" src="/assets/js/src/affix.js?v=5.1.1"></script>

  <script type="text/javascript" src="/assets/js/src/schemes/pisces.js?v=5.1.1"></script>



  <script type="text/javascript" src="/assets/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/assets/js/src/post-details.js?v=5.1.1"></script>


  


  <script type="text/javascript" src="/assets/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  







<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script type="text/javascript">
      var gitalk = new Gitalk({
        clientID: '6b408abe365ff10490b9',
        clientSecret: 'a46aa7a0fda5ead2100ddc767dcb83ffaed15392',
        repo: 'zhaoqhu.github.io',
        owner: 'zhaoqhu',
        admin: ['zhaoqhu'],
        id: '/%E9%9D%A2%E8%AF%95/2025/12/05/rabbitmq-ms/',
        labels: ['gitalk'],
        perPage: 50,
        distractionFreeMode: false
      });
      gitalk.render('gitalk-container');
</script>







  




  

    

  







  


  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
  


  

  

  

</body>
</html>

